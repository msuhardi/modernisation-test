      *************************                                                 
       IDENTIFICATION DIVISION.                                                 
      *************************                                                 
       PROGRAM-ID.    BP13CY31.                                                 
       AUTHOR.        JIANG BO.                                                 
       DATE-WRITTEN.  13/08/08.                                                 
      *****************************************************************         
      * OBJECTIVE - TO PRINT SUMMARY REPORT AND DETAIL FILE                     
      *                                                                         
      *     INPUT FILE :                                                        
      *                  1. BP13F205                                            
      *                  2. BP13F800                                            
      *                  3. BP13K595                                            
      *                                                                         
      *     OUTPUT FILE:                                                        
      *                  1. BP13LY31                                            
      *                  2. P13F800A (DETAIL FILE)                              
      *                                                                         
      *----------------------------------------------------------------         
      * REF NO    DATE      BY   AMENDMENTS/ENHANCEMENTS                        
      * -------   --------  ---  ------------------------                       
      * BP133340  13082008  JB8  NEW PROGRAM.                                   
      *****************************************************************         
                                                                                
                                                                                
      **********************                                                    
       ENVIRONMENT DIVISION.                                                    
      **********************                                                    
                                                                                
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
                                                                                
           SELECT  SY02F001  ASSIGN        TO SY02F001.                         
           SELECT  BP13F205  ASSIGN        TO BP13F205.                         
           SELECT  BP13F800  ASSIGN        TO BP13F800.                         
           SELECT  BP13K595  ASSIGN        TO BP13K595                          
                             ORGANIZATION  IS INDEXED                           
                             ACCESS MODE   IS DYNAMIC                           
                             RECORD KEY    IS K595-KEY-FLD                      
                             FILE STATUS   IS WS-K595-STATUS.                   
           SELECT  BP13LY31  ASSIGN        TO BP13LY31.                         
           SELECT  P13F800A  ASSIGN        TO P13F800A.                         
                                                                                
      ***************                                                           
       DATA DIVISION.                                                           
      ***************                                                           
                                                                                
       FILE SECTION.                                                            
                                                                                
       COPY SY02F001.                                                           
                                                                                
       FD   BP13F800                   BLOCK CONTAINS 0 RECORDS                 
                                       RECORD CONTAINS 2000 CHARACTERS          
                                       LABEL RECORDS ARE STANDARD               
                                       RECORDING MODE IS F.                     
       COPY BP13F800.                                                           
                                                                                
       FD   BP13F205                   BLOCK CONTAINS 0 RECORDS                 
                                       RECORD CONTAINS 80 CHARACTERS            
                                       LABEL RECORDS ARE STANDARD               
                                       RECORDING MODE IS F.                     
       COPY BP13F205.                                                           
                                                                                
       FD   BP13K595                                                            
                                       RECORD CONTAINS 500 CHARACTERS.          
       COPY BP13K595.                                                           
                                                                                
       FD   BP13LY31                   BLOCK CONTAINS 0 RECORDS                 
                                       RECORD CONTAINS 132 CHARACTERS           
                                       LABEL RECORDS ARE STANDARD               
                                       RECORDING MODE IS F.                     
       01   BP13LY31-REC               PIC X(132).                              
                                                                                
       FD   P13F800A                   BLOCK CONTAINS 0 RECORDS                 
                                       RECORD CONTAINS 100 CHARACTERS           
                                       LABEL RECORDS ARE STANDARD               
                                       RECORDING MODE IS F.                     
       01  P13F800A-REC                PIC X(100).                              
                                                                                
       WORKING-STORAGE SECTION.                                                 
      ******************************************************************        
      *                   WORKING-STORAGE AREA                         *        
      ******************************************************************        
       01  WORK-FILE-VARIABLE.                                                  
           05  WS-EOF-F800             PIC X     VALUE 'N'.                     
           05  WS-EOF-K595             PIC X     VALUE 'N'.                     
           05  WS-K595-STATUS          PIC 9(02) VALUE ZEROES.                  
                                                                                
       01  WS-COUNTERS.                                                         
           05  WS-F800-READ            PIC 9(7)  VALUE ZEROES.                  
           05  WS-LY31-WRITE           PIC 9(7)  VALUE ZEROES.                  
           05  WS-F800A-WRITE          PIC 9(7)  VALUE ZEROES.                  
           05  WS-CNT-SH-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-SH-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-SG-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-SG-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-UH-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-UH-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-UG-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-UG-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-RH-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-RH-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-RG-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-RG-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-FT-ALL           PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-FT-BK            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-TOTAL-ALL        PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-TOTAL-BK         PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-SKIP1            PIC 9(07) VALUE ZEROES.                  
           05  WS-CNT-SKIP2            PIC 9(07) VALUE ZEROES.                  
           05  WS-TMP-ALL              PIC 9(07) VALUE ZEROES.                  
           05  WS-TMP-BK               PIC 9(07) VALUE ZEROES.                  
                                                                                
       01  WS-VARIABLE.                                                         
           05  WS-PREV-NT              PIC X(03) VALUE SPACES.                  
           05  WS-DTE-BALLOT           PIC X(06) VALUE SPACES.                  
           05  WS-RESULT               PIC X(01) VALUE SPACES.                  
           05  WS-FT                   PIC X(01) VALUE SPACES.                  
           05  WS-PRINTED-FT           PIC X(01) VALUE SPACES.                  
           05  WS-PRINTED-NT           PIC X(01) VALUE SPACES.                  
           05  WS-DTE-BK               PIC X(08) VALUE SPACES.                  
           05  WS-PREV-FT              PIC X(01) VALUE SPACES.                  
           05  WS-PREV-DTE-BK          PIC X(08) VALUE SPACES.                  
           05  WS-CUR-DATE             PIC X(08) VALUE SPACES.                  
                                                                                
       01  WS-OUTPUT-VARIABLE.                                                  
           05  WS-PAGE-CNT             PIC 9(07) VALUE ZEROES.                  
           05  WS-REC-CNT              PIC 9(07) VALUE 56.                      
           05  WS-SN-CNT               PIC 9(05) VALUE ZEROES.                  
                                                                                
      *---> DETAIL LINES FOR REPORT                                             
       01  LY31-HEADER01.                                                       
           05  FILLER              PIC X(8)      VALUE 'BP13LY31'.              
           05  FILLER              PIC X(4)      VALUE SPACES.                  
           05  FILLER              PIC X(8)      VALUE 'HDBCAT 3'.              
           05  FILLER              PIC X(24)     VALUE SPACES.                  
           05  FILLER              PIC X(20)     VALUE                          
                                  'S Y S T E M   O F   '.                       
           05  FILLER              PIC X(19) VALUE                              
                                  'C O M M I T M E N T'.                        
           05  FILLER              PIC X(15)     VALUE SPACES.                  
           05  FILLER              PIC X(07)     VALUE 'DATE : '.               
           05  LY31-DATE-HDR       PIC X(10)     VALUE SPACES.                  
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  FILLER              PIC X(07)     VALUE 'PAGE : '.               
           05  LY31-PAGE-HDR       PIC ZZZ9      VALUE ZEROES.                  
                                                                                
       01  LY31-HEADER02.                                                       
           05  FILLER              PIC X(44)     VALUE SPACES.                  
           05  FILLER              PIC X(32)     VALUE SPACES.                  
                                                                                
       01  LY31-HEADER03.                                                       
           05  FILLER              PIC X(03)   VALUE SPACES.                    
           05  FILLER              PIC X(16)   VALUE 'NT/DTE-BALLOT : '.        
           05  LY31-NT-BAL         PIC X(10)   VALUE SPACES.                    
                                                                                
       01  LY31-HEADER04.                                                       
           05  FILLER              PIC X(03)   VALUE SPACES.                    
           05  FILLER              PIC X(16)   VALUE 'FLAT TYPE     : '.        
           05  LY31-FT             PIC X(10)   VALUE SPACES.                    
                                                                                
       01  LY31-HEADER05.                                                       
           05  FILLER              PIC X(03)     VALUE SPACES.                  
           05  FILLER              PIC X(05)     VALUE '  S/N'.                 
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  FILLER              PIC X(11)     VALUE 'DTE-BK-APPT'.           
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  FILLER              PIC X(06)     VALUE 'RESULT'.                
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  FILLER              PIC X(09)     VALUE 'HOUSEHOLD'.             
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  FILLER              PIC X(10)     VALUE 'NO.INVITED'.            
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  FILLER              PIC X(10)     VALUE 'NO.BOOKED'.             
                                                                                
       01  LY31-DETAIL01.                                                       
           05  FILLER              PIC X(03)     VALUE SPACES.                  
           05  LY31-SN             PIC ZZZZ9     VALUE ZEROES.                  
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  LY31-DTE-BK         PIC X(10)     VALUE SPACES.                  
           05  FILLER              PIC X(07)     VALUE SPACES.                  
           05  LY31-RESULT         PIC X(01)     VALUE SPACES.                  
           05  FILLER              PIC X(11)     VALUE SPACES.                  
           05  LY31-HH             PIC X(01)     VALUE SPACES.                  
           05  FILLER              PIC X(09)     VALUE SPACES.                  
           05  LY31-ALL            PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  LY31-BOOKED         PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
                                                                                
       01  LY31-DETAIL02.                                                       
           05  FILLER              PIC X(39)     VALUE SPACES.                  
           05  FILLER              PIC X(12)     VALUE 'ALL TOTAL : '.          
           05  LY31-TOT-ALL        PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  LY31-TOT-BK         PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
                                                                                
       01  LY31-DETAIL03.                                                       
           05  FILLER              PIC X(38)     VALUE SPACES.                  
           05  FILLER              PIC X(13)     VALUE 'PAGE TOTAL : '.         
           05  LY31-FT-ALL         PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  LY31-FT-BK          PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
                                                                                
      ********************                                                      
      * OUTPUT FILE FORMAT                                                      
      ********************                                                      
       01  P13F800A-TITLE.                                                      
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  F800A-ALLO-CAT      PIC X(03)     VALUE SPACES.                  
           05  FILLER              PIC X(01)     VALUE '/'.                     
           05  F800A-DTE-BALLOT    PIC X(08)     VALUE SPACES.                  
           05  FILLER              PIC X(01)     VALUE '/'.                     
           05  F800A-NT            PIC X(03)     VALUE SPACES.                  
           05  FILLER              PIC X(92)     VALUE SPACES.                  
                                                                                
       01  P13F800A-TOTAL.                                                      
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(12)     VALUE '    TOTAL : '.          
           05  F800A-TOTAL         PIC Z,ZZZ,ZZ9 VALUE ZEROES.                  
           05  FILLER              PIC X(87)     VALUE SPACES.                  
                                                                                
       01  P13F800A-HEADER.                                                     
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(08)     VALUE 'REGN    '.              
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(06)     VALUE 'RESULT'.                
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(11)     VALUE 'DTE-BK-APPT'.           
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(02)     VALUE 'HH'.                    
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(02)     VALUE 'FT'.                    
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(03)     VALUE 'NT'.                    
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(07)     VALUE 'HA1-AGE'.               
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(06)     VALUE 'INCOME'.                
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(07)     VALUE 'HH-SIZE'.               
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(04)     VALUE 'ALLO'.                  
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(04)     VALUE 'ELIG'.                  
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(03)     VALUE 'CAT'.                   
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(11)     VALUE 'SCH-ACC'.               
                                                                                
       01  P13F800A-DETAIL.                                                     
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  F800A-NUM-REGN      PIC X(08)     VALUE SPACES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  F800A-NUM-RESULT    PIC X(01)     VALUE SPACES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  F800A-DTE-BK        PIC X(10)     VALUE SPACES.                  
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  F800A-HH-TYPE       PIC X(01)     VALUE SPACES.                  
           05  FILLER              PIC X(03)     VALUE SPACES.                  
           05  F800A-FT            PIC X(02)     VALUE SPACES.                  
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  F800A-NEW-TOWN      PIC X(03)     VALUE SPACES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  F800A-HA1-AGE       PIC ZZZ9      VALUE ZEROES.                  
           05  FILLER              PIC X(03)     VALUE SPACES.                  
           05  F800A-INCOME        PIC ZZZZ9     VALUE ZEROES.                  
           05  FILLER              PIC X(05)     VALUE SPACES.                  
           05  F800A-SIZE          PIC Z9        VALUE ZEROES.                  
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  F800A-ALLO-SCH      PIC X(03)     VALUE SPACES.                  
           05  FILLER              PIC X(03)     VALUE SPACES.                  
           05  F800A-ELIG-SCH      PIC X(03)     VALUE SPACES.                  
           05  FILLER              PIC X(04)     VALUE SPACES.                  
           05  F800A-ETHNIC        PIC 9         VALUE ZEROES.                  
           05  FILLER              PIC X(03)     VALUE SPACES.                  
           05  F800A-SCHACC        PIC X(11)     VALUE SPACES.                  
                                                                                
      ******************************************************************        
      *                   P R O G R A M     B O D Y                    *        
      ******************************************************************        
                                                                                
      ********************                                                      
       PROCEDURE DIVISION.                                                      
      ********************                                                      
                                                                                
      ******************************************************************        
       0000-MAIN.                                                               
      ******************************************************************        
                                                                                
           PERFORM 1000-OPEN-ROUTINE       THRU 1000-EXIT.                      
                                                                                
           PERFORM 2000-READ-BP13F205      THRU 2000-EXIT.                      
           PERFORM 2100-READ-BP13F800      THRU 2100-EXIT.                      
                                                                                
           PERFORM 3000-PROCEED-BP13F800   THRU 3000-EXIT                       
             UNTIL WS-EOF-F800 = 'Y'.                                           
                                                                                
           PERFORM 6000-WRITE-REPORT       THRU 6000-EXIT.                      
           PERFORM 6500-WRITE-FT-TOTAL     THRU 6500-EXIT.                      
           PERFORM 7000-WRITE-TOTAL        THRU 7000-EXIT.                      
                                                                                
           PERFORM 9000-CLOSE-ROUTINE      THRU  9000-EXIT.                     
                                                                                
       0000-EXIT.  EXIT.                                                        
                                                                                
      ******************************************************************        
       1000-OPEN-ROUTINE.                                                       
      ******************************************************************        
                                                                                
           OPEN INPUT  SY02F001                                                 
                       BP13F205                                                 
                       BP13F800                                                 
                       BP13K595                                                 
                OUTPUT BP13LY31                                                 
                       P13F800A.                                                
                                                                                
           IF WS-K595-STATUS NOT = 00 AND 97                                    
              DISPLAY 'BP13K595 - ERROR OPENING '                               
              MOVE WS-K595-STATUS              TO RETURN-CODE                   
              GO TO 9000-CLOSE-ROUTINE                                          
           END-IF.                                                              
                                                                                
           READ SY02F001                                                        
             AT END                                                             
                DISPLAY 'SY02F001 - ERROR READING'                              
                GO TO 9000-CLOSE-ROUTINE.                                       
                                                                                
           MOVE F001-DTE-CURRENT               TO WS-CUR-DATE.                  
                                                                                
           STRING F001-DTE-CURRENT(7:2) '/'                                     
                  F001-DTE-CURRENT(5:2) '/'                                     
                  F001-DTE-CURRENT(1:4)                                         
              DELIMITED BY SIZE INTO LY31-DATE-HDR.                             
                                                                                
       1000-EXIT.  EXIT.                                                        
                                                                                
      ******************************************************************        
       2000-READ-BP13F205.                                                      
      ******************************************************************        
                                                                                
           READ BP13F205           AT   END                                     
                DISPLAY 'NOT RECORD FOUND IN BP13F205'                          
                GO                 TO   2000-EXIT.                              
                                                                                
       2000-EXIT.  EXIT.                                                        
                                                                                
      ******************************************************************        
       2100-READ-BP13F800.                                                      
      ******************************************************************        
                                                                                
           READ BP13F800           AT   END                                     
                MOVE 'Y'           TO   WS-EOF-F800                             
                GO                 TO   2100-EXIT.                              
                                                                                
           ADD  1                  TO   WS-F800-READ.                           
                                                                                
       2100-EXIT.  EXIT.                                                        
                                                                                
      ******************************************************************        
       3000-PROCEED-BP13F800.                                                   
      ******************************************************************        
                                                                                
                                                                                
           IF F800-NUM-ALLO-CAT = F205-NUM-SELECTION AND                        
              F800-DTE-BALLOT   = F205-DTE-BALLOT                               
              PERFORM 4000-PROCEED-REPORT     THRU 4000-EXIT                    
           ELSE                                                                 
              ADD 1                             TO WS-CNT-SKIP1                 
           END-IF.                                                              
                                                                                
           PERFORM 2100-READ-BP13F800  THRU 2100-EXIT.                          
                                                                                
       3000-EXIT.  EXIT.                                                        
                                                                                
      **********************                                                    
       4000-PROCEED-REPORT.                                                     
      **********************                                                    
                                                                                
           IF F800-NUM-NEW-TOWN NOT = F800A-NT                                  
              MOVE F800-NUM-NEW-TOWN           TO F800A-NT                      
              MOVE F800-NUM-ALLO-CAT           TO F800A-ALLO-CAT                
              MOVE F800-DTE-BALLOT             TO F800A-DTE-BALLOT              
              WRITE P13F800A-REC FROM P13F800A-TITLE                            
              WRITE P13F800A-REC FROM P13F800A-HEADER                           
           END-IF.                                                              
                                                                                
           IF F800-NUM-BALLOT-STATUS NOT = SPACE AND LOW-VALUE                  
              MOVE F800-NUM-BALLOT-STATUS      TO WS-RESULT                     
           ELSE                                                                 
              PERFORM 5000-GET-RESULT        THRU 5000-EXIT                     
           END-IF.                                                              
                                                                                
           IF F800-NUM-NEW-TOWN NOT = WS-PREV-NT                                
              IF WS-PREV-NT = SPACES OR LOW-VALUES                              
                 MOVE F800-NUM-NEW-TOWN        TO WS-PREV-NT                    
                 MOVE F800-DTE-BALLOT          TO WS-DTE-BALLOT                 
              ELSE                                                              
                 PERFORM 6000-WRITE-REPORT   THRU 6000-EXIT                     
                 MOVE F800-NUM-NEW-TOWN        TO WS-PREV-NT                    
                 MOVE F800-DTE-BALLOT          TO WS-DTE-BALLOT                 
                 MOVE SPACES                   TO WS-PREV-FT                    
                 MOVE SPACES                   TO WS-PRINTED-FT                 
                 MOVE SPACES                   TO WS-PREV-DTE-BK                
              END-IF                                                            
           END-IF.                                                              
                                                                                
           PERFORM 8000-OUTPUT-P13F800A      THRU 8000-EXIT                     
                                                                                
           IF WS-PREV-FT = SPACES OR LOW-VALUES                                 
              MOVE F800-NUM-FLAT-TYPE(1:1)     TO WS-PREV-FT                    
              MOVE F800-DTE-BK-APPT            TO WS-PREV-DTE-BK                
           ELSE                                                                 
              IF F800-NUM-FLAT-TYPE(1:1) = WS-PREV-FT                           
                 IF F800-DTE-BK-APPT NOT = WS-PREV-DTE-BK                       
                    PERFORM 6000-WRITE-REPORT THRU 6000-EXIT                    
                    MOVE F800-DTE-BK-APPT       TO WS-PREV-DTE-BK               
                 END-IF                                                         
              ELSE                                                              
                 PERFORM 6000-WRITE-REPORT    THRU 6000-EXIT                    
                 MOVE F800-NUM-FLAT-TYPE(1:1)   TO WS-PREV-FT                   
                 MOVE F800-DTE-BK-APPT          TO WS-PREV-DTE-BK               
              END-IF                                                            
           END-IF.                                                              
                                                                                
           PERFORM 4500-COUNT-RECORD         THRU 4500-EXIT.                    
                                                                                
       4000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       4500-COUNT-RECORD.                                                       
      ******************************************************************        
                                                                                
           IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                      
              ADD 1                            TO WS-CNT-FT-BK                  
           END-IF                                                               
           ADD 1                               TO WS-CNT-FT-ALL.                
                                                                                
           IF WS-RESULT = 'S'                                                   
              IF F800-NUM-HOUSEHOLD = 'H' OR 'T'                                
                 IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                
                    ADD 1                      TO WS-CNT-SH-BK                  
                 END-IF                                                         
                 ADD 1                         TO WS-CNT-SH-ALL                 
              ELSE                                                              
                 IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                
                    ADD 1                      TO WS-CNT-SG-BK                  
                 END-IF                                                         
                 ADD 1                         TO WS-CNT-SG-ALL                 
              END-IF                                                            
           ELSE                                                                 
           IF WS-RESULT = 'R'                                                   
              IF F800-NUM-HOUSEHOLD = 'H' OR 'T'                                
                 IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                
                    ADD 1                      TO WS-CNT-RH-BK                  
                 END-IF                                                         
                 ADD 1                         TO WS-CNT-RH-ALL                 
              ELSE                                                              
                 IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                
                    ADD 1                      TO WS-CNT-RG-BK                  
                 END-IF                                                         
                 ADD 1                         TO WS-CNT-RG-ALL                 
              END-IF                                                            
           ELSE                                                                 
              IF F800-NUM-HOUSEHOLD = 'H' OR 'T'                                
                 IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                
                    ADD 1                      TO WS-CNT-UH-BK                  
                 END-IF                                                         
                 ADD 1                         TO WS-CNT-UH-ALL                 
              ELSE                                                              
                 IF F800-NUM-SCH-ACC NOT = SPACES AND LOW-VALUES                
                    ADD 1                      TO WS-CNT-UG-BK                  
                 END-IF                                                         
                 ADD 1                         TO WS-CNT-UG-ALL                 
              END-IF                                                            
           END-IF.                                                              
                                                                                
       4500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       5000-GET-RESULT.                                                         
      ******************************************************************        
                                                                                
           MOVE SPACES                         TO BP13K595-REC.                 
           INITIALIZE                             BP13K595-REC.                 
                                                                                
           MOVE F800-NUM-REGN                  TO K595-NUM-REGN-REF.            
           MOVE 'N'                            TO WS-EOF-K595.                  
           MOVE SPACES                         TO WS-RESULT.                    
                                                                                
                                                                                
           PERFORM 5200-START-BP13K595       THRU 5200-EXIT.                    
                                                                                
           IF WS-K595-STATUS = 00 OR 02                                         
              PERFORM 5400-READNEXT-BP13K595 THRU 5400-EXIT                     
                UNTIL WS-EOF-K595 = 'Y'                                         
                   OR WS-RESULT NOT = SPACES AND LOW-VALUES                     
           END-IF.                                                              
                                                                                
           IF WS-RESULT = SPACES OR LOW-VALUES                                  
              MOVE SPACES                      TO WS-RESULT                     
              DISPLAY 'RESULT NOT FOUND , KEY IS ' F800-NUM-REGN                
           END-IF.                                                              
                                                                                
       5000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       5200-START-BP13K595.                                                     
      ******************************************************************        
                                                                                
           START BP13K595 KEY > K595-KEY-FLD.                                   
                                                                                
           EVALUATE WS-K595-STATUS                                              
              WHEN 00                                                           
              WHEN 02                                                           
              WHEN 23                                                           
                 CONTINUE                                                       
              WHEN OTHER                                                        
                 DISPLAY 'BP13K595 - ERROR BROWSING : '                         
                         WS-K595-STATUS                                         
                 GO TO 9000-CLOSE-ROUTINE                                       
           END-EVALUATE.                                                        
                                                                                
       5200-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       5400-READNEXT-BP13K595.                                                  
      *----------------------------------------------------------------*        
                                                                                
           READ BP13K595 NEXT RECORD                                            
                AT END MOVE 'Y' TO WS-EOF-K595                                  
                GO TO 5400-EXIT.                                                
                                                                                
           EVALUATE WS-K595-STATUS                                              
              WHEN 00                                                           
              WHEN 02                                                           
                 IF K595-NUM-REGN-REF = F800-NUM-REGN                           
                    IF K595-CDE-REQUEST-STATUS = 'R' OR 'S' OR 'U' OR           
                                                 'W' OR 'Z'                     
                       MOVE K595-CDE-REQUEST-STATUS TO WS-RESULT                
                    END-IF                                                      
                 ELSE                                                           
                    MOVE 'Y'                      TO WS-EOF-K595                
                 END-IF                                                         
              WHEN 23                                                           
                 MOVE 'Y'                         TO WS-EOF-K595                
              WHEN OTHER                                                        
                 DISPLAY 'BP13K595 - ERROR READING : '                          
                         WS-K595-STATUS                                         
                 GO TO 9000-CLOSE-ROUTINE                                       
           END-EVALUATE.                                                        
                                                                                
       5400-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       6000-WRITE-REPORT.                                                       
      ******************************************************************        
                                                                                
           IF WS-PREV-FT = WS-PRINTED-FT                                        
              CONTINUE                                                          
           ELSE                                                                 
              MOVE WS-PREV-FT                  TO WS-PRINTED-FT                 
              PERFORM 6200-WRITE-NEW-PAGE    THRU 6200-EXIT                     
           END-IF.                                                              
                                                                                
           IF WS-CNT-SH-ALL = 0 AND WS-CNT-SH-BK = 0                            
              CONTINUE                                                          
           ELSE                                                                 
                                                                                
              IF WS-REC-CNT > 54                                                
                 PERFORM 6200-WRITE-NEW-PAGE THRU 6200-EXIT                     
              END-IF                                                            
                                                                                
              STRING WS-PREV-DTE-BK(7:2) '/'                                    
                     WS-PREV-DTE-BK(5:2) '/'                                    
                     WS-PREV-DTE-BK(1:4)                                        
                 DELIMITED BY SIZE INTO LY31-DTE-BK                             
              MOVE 'S'                         TO LY31-RESULT                   
              MOVE 'H'                         TO LY31-HH                       
              MOVE WS-CNT-SH-ALL               TO LY31-ALL                      
              MOVE WS-CNT-SH-BK                TO LY31-BOOKED                   
              ADD 1                            TO WS-SN-CNT                     
              ADD 1                            TO WS-LY31-WRITE                 
              MOVE WS-SN-CNT                   TO LY31-SN                       
              ADD 1                            TO WS-REC-CNT                    
              WRITE BP13LY31-REC FROM LY31-DETAIL01                             
           END-IF.                                                              
                                                                                
           IF WS-CNT-SG-ALL = 0 AND WS-CNT-SG-BK = 0                            
              CONTINUE                                                          
           ELSE                                                                 
                                                                                
              IF WS-REC-CNT > 54                                                
                 PERFORM 6200-WRITE-NEW-PAGE THRU 6200-EXIT                     
              END-IF                                                            
                                                                                
              STRING WS-PREV-DTE-BK(7:2) '/'                                    
                     WS-PREV-DTE-BK(5:2) '/'                                    
                     WS-PREV-DTE-BK(1:4)                                        
                 DELIMITED BY SIZE INTO LY31-DTE-BK                             
              MOVE 'S'                         TO LY31-RESULT                   
              MOVE 'G'                         TO LY31-HH                       
              MOVE WS-CNT-SG-ALL               TO LY31-ALL                      
              MOVE WS-CNT-SG-BK                TO LY31-BOOKED                   
              ADD 1                            TO WS-SN-CNT                     
              ADD 1                            TO WS-LY31-WRITE                 
              MOVE WS-SN-CNT                   TO LY31-SN                       
              ADD 1                            TO WS-REC-CNT                    
              WRITE BP13LY31-REC FROM LY31-DETAIL01                             
           END-IF.                                                              
                                                                                
           IF WS-CNT-UH-ALL = 0 AND WS-CNT-UH-BK = 0                            
              CONTINUE                                                          
           ELSE                                                                 
                                                                                
              IF WS-REC-CNT > 54                                                
                 PERFORM 6200-WRITE-NEW-PAGE THRU 6200-EXIT                     
              END-IF                                                            
                                                                                
              STRING WS-PREV-DTE-BK(7:2) '/'                                    
                     WS-PREV-DTE-BK(5:2) '/'                                    
                     WS-PREV-DTE-BK(1:4)                                        
                 DELIMITED BY SIZE INTO LY31-DTE-BK                             
              MOVE 'U'                         TO LY31-RESULT                   
              MOVE 'H'                         TO LY31-HH                       
              MOVE WS-CNT-UH-ALL               TO LY31-ALL                      
              MOVE WS-CNT-UH-BK                TO LY31-BOOKED                   
              ADD 1                            TO WS-SN-CNT                     
              ADD 1                            TO WS-LY31-WRITE                 
              MOVE WS-SN-CNT                   TO LY31-SN                       
              ADD 1                            TO WS-REC-CNT                    
              WRITE BP13LY31-REC FROM LY31-DETAIL01                             
           END-IF.                                                              
                                                                                
           IF WS-CNT-UG-ALL = 0 AND WS-CNT-UG-BK = 0                            
              CONTINUE                                                          
           ELSE                                                                 
                                                                                
              IF WS-REC-CNT > 54                                                
                 PERFORM 6200-WRITE-NEW-PAGE THRU 6200-EXIT                     
              END-IF                                                            
                                                                                
              STRING WS-PREV-DTE-BK(7:2) '/'                                    
                     WS-PREV-DTE-BK(5:2) '/'                                    
                     WS-PREV-DTE-BK(1:4)                                        
                 DELIMITED BY SIZE INTO LY31-DTE-BK                             
              MOVE 'U'                         TO LY31-RESULT                   
              MOVE 'G'                         TO LY31-HH                       
              MOVE WS-CNT-UG-ALL               TO LY31-ALL                      
              MOVE WS-CNT-UG-BK                TO LY31-BOOKED                   
              ADD 1                            TO WS-SN-CNT                     
              ADD 1                            TO WS-LY31-WRITE                 
              MOVE WS-SN-CNT                   TO LY31-SN                       
              ADD 1                            TO WS-REC-CNT                    
              WRITE BP13LY31-REC FROM LY31-DETAIL01                             
           END-IF.                                                              
                                                                                
           IF WS-CNT-RH-ALL = 0 AND WS-CNT-RH-BK = 0                            
              CONTINUE                                                          
           ELSE                                                                 
                                                                                
              IF WS-REC-CNT > 54                                                
                 PERFORM 6200-WRITE-NEW-PAGE THRU 6200-EXIT                     
              END-IF                                                            
                                                                                
              STRING WS-PREV-DTE-BK(7:2) '/'                                    
                     WS-PREV-DTE-BK(5:2) '/'                                    
                     WS-PREV-DTE-BK(1:4)                                        
                 DELIMITED BY SIZE INTO LY31-DTE-BK                             
              MOVE 'R'                         TO LY31-RESULT                   
              MOVE 'H'                         TO LY31-HH                       
              MOVE WS-CNT-RH-ALL               TO LY31-ALL                      
              MOVE WS-CNT-RH-BK                TO LY31-BOOKED                   
              ADD 1                            TO WS-SN-CNT                     
              ADD 1                            TO WS-LY31-WRITE                 
              MOVE WS-SN-CNT                   TO LY31-SN                       
              ADD 1                            TO WS-REC-CNT                    
              WRITE BP13LY31-REC FROM LY31-DETAIL01                             
           END-IF.                                                              
                                                                                
           IF WS-CNT-RG-ALL = 0 AND WS-CNT-RG-BK = 0                            
              CONTINUE                                                          
           ELSE                                                                 
                                                                                
              IF WS-REC-CNT > 54                                                
                 PERFORM 6200-WRITE-NEW-PAGE THRU 6200-EXIT                     
              END-IF                                                            
                                                                                
              STRING WS-PREV-DTE-BK(7:2) '/'                                    
                     WS-PREV-DTE-BK(5:2) '/'                                    
                     WS-PREV-DTE-BK(1:4)                                        
                 DELIMITED BY SIZE INTO LY31-DTE-BK                             
              MOVE 'R'                         TO LY31-RESULT                   
              MOVE 'G'                         TO LY31-HH                       
              MOVE WS-CNT-RG-ALL               TO LY31-ALL                      
              MOVE WS-CNT-RG-BK                TO LY31-BOOKED                   
              ADD 1                            TO WS-SN-CNT                     
              ADD 1                            TO WS-LY31-WRITE                 
              MOVE WS-SN-CNT                   TO LY31-SN                       
              ADD 1                            TO WS-REC-CNT                    
              WRITE BP13LY31-REC FROM LY31-DETAIL01                             
           END-IF.                                                              
                                                                                
           MOVE ZEROES TO WS-CNT-SH-ALL  WS-CNT-UG-ALL                          
                          WS-CNT-SH-BK   WS-CNT-UG-BK                           
                          WS-CNT-SG-ALL  WS-CNT-RH-ALL                          
                          WS-CNT-SG-BK   WS-CNT-RH-BK                           
                          WS-CNT-UH-ALL  WS-CNT-RG-ALL                          
                          WS-CNT-UH-BK   WS-CNT-RG-BK.                          
                                                                                
       6000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       6200-WRITE-NEW-PAGE.                                                     
      ******************************************************************        
                                                                                
           IF WS-PAGE-CNT NOT = 0                                               
              PERFORM 6500-WRITE-FT-TOTAL  THRU 6500-EXIT                       
           END-IF.                                                              
                                                                                
           STRING WS-CUR-DATE(7:2) '/'                                          
                  WS-CUR-DATE(5:2) '/'                                          
                  WS-CUR-DATE(1:4)                                              
              DELIMITED BY SIZE INTO LY31-DATE-HDR.                             
           ADD 1                             TO WS-PAGE-CNT.                    
           MOVE ZEROES                       TO WS-SN-CNT                       
           MOVE WS-PAGE-CNT                  TO LY31-PAGE-HDR.                  
           MOVE WS-PRINTED-FT                TO LY31-FT.                        
           STRING WS-PREV-NT '/' WS-DTE-BALLOT                                  
              DELIMITED BY SIZE INTO LY31-NT-BAL.                               
           WRITE BP13LY31-REC FROM LY31-HEADER01 AFTER PAGE.                    
           WRITE BP13LY31-REC FROM LY31-HEADER02.                               
           WRITE BP13LY31-REC FROM LY31-HEADER03 AFTER 2.                       
           WRITE BP13LY31-REC FROM LY31-HEADER04.                               
           WRITE BP13LY31-REC FROM LY31-HEADER05.                               
           MOVE 4                            TO WS-REC-CNT.                     
                                                                                
       6200-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       6500-WRITE-FT-TOTAL.                                                     
      ******************************************************************        
                                                                                
           COMPUTE WS-TMP-BK = WS-CNT-SH-BK + WS-CNT-UG-BK +                    
                               WS-CNT-SG-BK + WS-CNT-RH-BK +                    
                               WS-CNT-UH-BK + WS-CNT-RG-BK.                     
                                                                                
           COMPUTE WS-TMP-ALL = WS-CNT-SH-ALL + WS-CNT-UG-ALL +                 
                                WS-CNT-SG-ALL + WS-CNT-RH-ALL +                 
                                WS-CNT-UH-ALL + WS-CNT-RG-ALL.                  
                                                                                
           COMPUTE WS-CNT-FT-ALL = WS-CNT-FT-ALL - WS-TMP-ALL                   
           COMPUTE WS-CNT-FT-BK  = WS-CNT-FT-BK  - WS-TMP-BK                    
                                                                                
           MOVE WS-CNT-FT-ALL                TO LY31-FT-ALL                     
           MOVE WS-CNT-FT-BK                 TO LY31-FT-BK                      
           WRITE BP13LY31-REC FROM LY31-DETAIL03.                               
           ADD WS-CNT-FT-ALL                 TO WS-CNT-TOTAL-ALL                
           ADD WS-CNT-FT-BK                  TO WS-CNT-TOTAL-BK                 
           MOVE WS-TMP-ALL                   TO WS-CNT-FT-ALL                   
           MOVE WS-TMP-BK                    TO WS-CNT-FT-BK.                   
                                                                                
       6500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       7000-WRITE-TOTAL.                                                        
      ******************************************************************        
                                                                                
           MOVE WS-CNT-TOTAL-ALL             TO LY31-TOT-ALL.                   
           MOVE WS-CNT-TOTAL-BK              TO LY31-TOT-BK.                    
                                                                                
           WRITE BP13LY31-REC FROM LY31-DETAIL02.                               
                                                                                
           MOVE WS-F800A-WRITE               TO F800A-TOTAL                     
           WRITE P13F800A-REC FROM P13F800A-TOTAL.                              
                                                                                
       7000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       8000-OUTPUT-P13F800A.                                                    
      ******************************************************************        
                                                                                
           MOVE F800-NUM-REGN                TO F800A-NUM-REGN                  
           MOVE WS-RESULT                    TO F800A-NUM-RESULT                
           MOVE F800-DTE-BK-APPT             TO F800A-DTE-BK                    
           MOVE F800-NUM-HOUSEHOLD           TO F800A-HH-TYPE                   
           MOVE F800-NUM-FLAT-TYPE           TO F800A-FT                        
           MOVE F800-NUM-NEW-TOWN            TO F800A-NEW-TOWN                  
           MOVE BP13F800-MASTER(1982:4)      TO F800A-HA1-AGE                   
           MOVE BP13F800-MASTER(1994:5)      TO F800A-INCOME                    
           MOVE BP13F800-MASTER(1980:2)      TO F800A-SIZE                      
           MOVE F800-NUM-ALLO-SCHEME         TO F800A-ALLO-SCH                  
           MOVE F800-NUM-ELIG-SCHEME         TO F800A-ELIG-SCH                  
           MOVE F800-NUM-CAT                 TO F800A-ETHNIC.                   
           MOVE F800-NUM-SCH-ACC             TO F800A-SCHACC.                   
                                                                                
           WRITE P13F800A-REC FROM P13F800A-DETAIL.                             
           ADD 1                             TO WS-F800A-WRITE.                 
                                                                                
       8000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      ******************************************************************        
       9000-CLOSE-ROUTINE.                                                      
      ******************************************************************        
                                                                                
                                                                                
           DISPLAY '******* CONTROL   TOTALS ********'.                         
           DISPLAY 'PROGRAM-ID : BP13CY31'.                                     
           DISPLAY '---------------------'.                                     
           DISPLAY 'NO OF BP13F800 RECORDS READ ...............: '              
                    WS-F800-READ.                                               
           DISPLAY 'NO OF BP13LY31 RECORDS WRITTEN ............: '              
                    WS-LY31-WRITE.                                              
           DISPLAY 'NO OF BP13F800 RECORDS WITH INVALID MODE ..: '              
                    WS-CNT-SKIP1.                                               
           DISPLAY 'NO OF BP13F800 RECORDS WITH INVALID RESULT : '              
                    WS-CNT-SKIP2.                                               
                                                                                
           CLOSE SY02F001                                                       
                 BP13F800                                                       
                 BP13K595                                                       
                 P13F800A                                                       
                 BP13F205                                                       
                 BP13LY31.                                                      
                                                                                
           IF WS-K595-STATUS NOT = 00                                           
              DISPLAY 'BP13K595 - ERROR CLOSING : ' WS-K595-STATUS              
              MOVE WS-K595-STATUS            TO RETURN-CODE                     
           END-IF.                                                              
                                                                                
           STOP RUN.                                                            
                                                                                
       9000-EXIT.  EXIT.                                                        
