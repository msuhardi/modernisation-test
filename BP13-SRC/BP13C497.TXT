      *************************                                         00010000
       IDENTIFICATION DIVISION.                                         00020000
      *************************                                         00030000
       PROGRAM-ID.    BP13C497.                                         00040000
       AUTHOR.        KV5.                                              00050000
       DATE-WRITTEN.  26/03/2019.                                       00060000
                                                                        00070000
      *************************************************************     00080000
      * SYSTEM NAME : SYSTEM OF COMMITTMENT - BP13                *     00090000
      *===========================================================*     00100000
      * OBJECTIVE   : TO WRITE SMS AND NON-SMS REPORTS FROM K491  *     00110000
      *               TAG-FORM 'I' RECORDS.                       *     00120000
      *                                                           *     00130000
      * FILES USED  : BP13F491 - SORTED TAG-FORM 'I' REC FROM K491*     00140000
      *               BP13K800 - SOC APPLICATION MASTER.          *     00150000
      *               AB03K030 - SMS PHASE 3.                     *     00160000
      *               AB03K080 - SMS PHASE 3.                     *     00170000
      *               OUTFSMS  - ELIG SCHEME FS REPORT.           *     00180000
      *               OUTFNSMS - NON FS REPORT.                   *     00190000
      *===========================================================*     00200000
      * CHGEREQ  DATE       BY   AMMENDMENTS                      *     00210000
      * -------- ---------- ---- -----------                      *     00220000
      * BP137741 26/03/2019 KV5  NEW PROGRAM                      *     00230000
      * BP137782 22/05/2019 KV5  REMOVED THE EMAIL, ERROR & BLOCK *     00231001
      *                          OF 257A IN REPORTS.              *     00232001
      * BP139238 29/06/2022 KAC1 TO REPLACE SOO CHIEW LOW (HDB) W/*     00233002
      *                             BERNICE JH GAN (HDB)          *     00234002
      * BP139175 29/06/2024 KAC1 REPL Bernice_JH_GAN@hdb.gov.sg W/*     00235002
      *                               Iris_LL_KOR@hdb.gov.sg      *     00236002
      *************************************************************     00240000
                                                                        00250000
      **********************                                            00260000
       ENVIRONMENT DIVISION.                                            00270000
      **********************                                            00280000
       CONFIGURATION SECTION.                                           00290000
       SOURCE-COMPUTER. IBM-3090.                                       00300000
       OBJECT-COMPUTER. IBM-3090.                                       00310000
                                                                        00320000
       INPUT-OUTPUT SECTION.                                            00330000
       FILE-CONTROL.                                                    00340000
           SELECT BP13K800 ASSIGN           TO BP13K800                 00350000
                           ORGANIZATION     IS INDEXED                  00360000
                           ACCESS MODE      IS RANDOM                   00370000
                           RECORD KEY       IS K800-NUM-REGN            00380000
                           FILE STATUS      IS WS-BP13K800-STATUS.      00390000
                                                                        00400000
           SELECT AB03K080 ASSIGN           TO AB03K080                 00410000
                           ORGANIZATION     IS INDEXED                  00420000
                           ACCESS MODE      IS DYNAMIC                  00430000
                           RECORD KEY       IS K080-KEY                 00440000
                           FILE STATUS      IS WS-K080-STATUS.          00450000
                                                                        00460000
           SELECT AB03K030 ASSIGN           TO AB03K030                 00470000
                           ORGANIZATION     IS INDEXED                  00480000
                           ACCESS MODE      IS RANDOM                   00490000
                           RECORD KEY       IS K030-NUM-HDB-REF         00500000
                           FILE STATUS      IS WS-K030-STATUS.          00510000
                                                                        00520000
           SELECT BP13F491 ASSIGN           TO BP13F491.                00530000
           SELECT OUTFSMS  ASSIGN           TO OUTFSMS.                 00540000
           SELECT OUTFNSMS ASSIGN           TO OUTFNSMS.                00550000
                                                                        00560000
      ***************                                                   00570000
       DATA DIVISION.                                                   00580000
      ***************                                                   00590000
       FILE SECTION.                                                    00600000
                                                                        00610000
       FD  BP13K800                                                     00620000
           RECORD CONTAINS 2000 CHARACTERS.                             00630000
       COPY BP13K800.                                                   00640000
                                                                        00650000
       FD   AB03K080                                                    00660000
            RECORD CONTAINS 50  CHARACTERS.                             00670000
       COPY AB03K080.                                                   00680000
                                                                        00690000
       FD   AB03K030                                                    00700000
            RECORD CONTAINS 800 CHARACTERS.                             00710000
       COPY AB03K030.                                                   00720000
                                                                        00730000
       FD  BP13F491                                                     00740000
           BLOCK CONTAINS  0   RECORDS                                  00750000
           LABEL RECORDS   ARE STANDARD                                 00760000
           RECORDING MODE  IS  F                                        00770000
           RECORD CONTAINS 200 CHARACTERS.                              00780000
       COPY BP13F491.                                                   00790000
                                                                        00800000
       FD  OUTFSMS                                                      00810000
           RECORD CONTAINS 200 CHARACTERS                               00820000
           RECORDING MODE IS F.                                         00830000
       01  OUTFSMS-REC                      PIC X(200).                 00840000
                                                                        00850000
       FD  OUTFNSMS                                                     00860000
           RECORD CONTAINS 200 CHARACTERS                               00870000
           RECORDING MODE IS F.                                         00880000
       01  OUTFNSMS-REC                     PIC X(200).                 00890000
                                                                        00900000
       WORKING-STORAGE SECTION.                                         00910000
                                                                        00920000
       01 WS-COUNTERS.                                                  00930000
          05 WS-F491-READ                   PIC 9(05) VALUE ZEROS.      00940000
          05 WS-K800-FND                    PIC 9(05) VALUE ZEROS.      00950000
          05 WS-K800-NFND                   PIC 9(05) VALUE ZEROS.      00960000
          05 WS-OUTFSMS-CTR                 PIC 9(05) VALUE ZEROS.      00970000
          05 WS-OUTFNSMS-CTR                PIC 9(05) VALUE ZEROS.      00980000
                                                                        00990000
       01 WS-SWITCHES.                                                  01000000
          05 WS-F491-EOF                    PIC X(01) VALUE SPACES.     01010000
          05 K800-FND                       PIC X(01) VALUE SPACES.     01020000
          05 WS-FLAG                        PIC X(01) VALUE SPACES.     01030000
          05 WS-SMS                         PIC X(01) VALUE SPACES.     01040000
                                                                        01050000
       01 WS-NRIC                           PIC X(09).                  01060000
                                                                        01070000
       01 WS-FILE-STATUS.                                               01080000
          05 WS-BP13K800-STATUS             PIC 9(02) VALUE ZEROES.     01090000
          05 WS-K080-STATUS                 PIC 9(02) VALUE ZEROS.      01100000
          05 WS-K030-STATUS                 PIC 9(02) VALUE ZEROS.      01110000
                                                                        01120000
       01 WS-DTE-TME.                                                   01130000
          05 WS-DTE                         PIC X(08) VALUE SPACES.     01140000
          05 WS-TME                         PIC X(08) VALUE SPACES.     01150000
          05 FILLER                         PIC X(05) VALUE SPACES.     01160000
                                                                        01170000
       01 WS-DISPLAY-DATE.                                              01180000
          05 WS-DD                          PIC X(02) VALUE SPACES.     01190000
          05 FILLER                         PIC X(01) VALUE '/'.        01200000
          05 WS-MM                          PIC X(02) VALUE SPACES.     01210000
          05 FILLER                         PIC X(01) VALUE '/'.        01220000
          05 WS-CCYY                        PIC X(04) VALUE SPACES.     01230000
                                                                        01240000
       01 WS-OUTFILE-REC.                                               01250000
          05 OUT-SER-NO                         PIC ZZZZ9.              01260000
          05 FILLER                             PIC X(01).              01270000
          05 OUT-NUM-REGN                       PIC X(08).              01280000
          05 FILLER                             PIC X(01).              01290000
          05 OUT-DTE-PCD                        PIC X(18).              01300000
          05 FILLER                             PIC X(01).              01310000
          05 OUT-NUM-EMAIL                      PIC X(50).              01320000
          05 FILLER                             PIC X(01).              01330000
          05 OUT-FLAT-ADD.                                              01340000
             10 OUT-NUM-BLK                     PIC X(05).              01350000
             10 FILLER                          PIC X(01).              01360000
             10 OUT-NUM-LEVEL                   PIC X(02).              01370000
             10 FILLER                          PIC X(01).              01380000
             10 OUT-NUM-MAIN-UNIT               PIC X(04).              01390000
             10 FILLER                          PIC X(01).              01400000
             10 OUT-NUM-STREET                  PIC X(30).              01410000
             10 FILLER                          PIC X(01).              01420000
             10 OUT-NUM-POSTAL                  PIC X(06).              01430000
          05 FILLER                             PIC X(64).              01440000
                                                                        01450000
       01  WS-EMAIL-RPT-VARIABLES.                                      01460000
           05  WS-DATE-RPT-DTL.                                         01470000
               10 FILLER                PIC X(6)  VALUE 'DATE: '.       01480000
               10 WS-DATE-RPT           PIC X(10) VALUE SPACES.         01490000
           05  WS-MAIL-RPT1             PIC X(12) VALUE 'HELO SGPHDB1'. 01500000
           05  WS-MAIL-RPT2             PIC X(27) VALUE                 01510000
                   'MAIL FROM:<OPCP@SGPHDB1>'.                          01520000
           05  WS-MAIL-RPT3             PIC X(60) VALUE                 01530000
                   'RCPT TO:<HEE_WAN_MENG@HDB.GOV.SG>'.                 01540000
           05  WS-MAIL-RPT3B            PIC X(60) VALUE                 01550000
                   'RCPT TO:<Iris_LL_KOR@hdb.gov.sg>'.                  01560002
           05  WS-MAIL-RPT4             PIC X(4)  VALUE                 01570000
                   'DATA'.                                              01580000
           05  WS-MAIL-RPT5             PIC X(40) VALUE                 01590000
                   'FROM:Soc System - Email Alert'.                     01600000
           05  WS-MAIL-RPT6             PIC X(60) VALUE                 01610000
                   'TO:<HEE_WAN_MENG@HDB.GOV.SG>'.                      01620000
           05  WS-MAIL-RPT6B            PIC X(60) VALUE                 01630000
                   'TO:<Iris_LL_KOR@hdb.gov.sg>'.                       01640002
           05  WS-MAIL-RPT7.                                            01650000
               10 FILLER                PIC X(37) VALUE                 01660000
                   'SUBJECT: Report for PCD TAG FORM(I - '.             01670000
               10 FILLER                PIC X(63) VALUE                 01680000
                   'EXISTING FLAT OWNERS FOUND IN ''SMS''.'.            01690000
           05  WS-MAIL-RPT8.                                            01700000
               10 FILLER                PIC X(37) VALUE                 01710000
                   'SUBJECT: Report for PCD TAG FORM(I - '.             01720000
               10 FILLER                PIC X(63) VALUE                 01730000
                   'EXISTING FLAT OWNERS NOT FOUND IN ''SMS''.'.        01740000
                                                                        01750000
       01  OUT-HDR01.                                                   01760000
           05 FILLER                     PIC X(14) VALUE 'BP13C497'.    01770000
           05 FILLER                     PIC X(30) VALUE 'HDB3'.        01780000
           05 FILLER                     PIC X(42) VALUE                01790000
             'S Y S T E M   O F   C O M M I T M E N T'.                 01800000
           05 FILLER                     PIC X(13) VALUE SPACES.        01810000
           05 FILLER                     PIC X(7)  VALUE 'DATE: '.      01820000
           05 OUT-DATE                   PIC X(10) VALUE SPACES.        01830000
                                                                        01840000
       01  OUT-HDR02-SMS.                                               01850000
           05 FILLER                     PIC X(14) VALUE SPACES.        01860000
           05 FILLER                     PIC X(10) VALUE SPACES.        01870000
           05 FILLER                     PIC X(41) VALUE                01880000
             'LIST OF REGN/PCD/EMAIL/ADDRESS - TAG FORM'.               01890000
           05 FILLER                     PIC X(44) VALUE                01900000
             '(I - EXISTING FLAT OWNERS FOUND IN ''SMS''.'.             01910000
                                                                        01920000
       01  OUT-HDR02-NSMS.                                              01930000
           05 FILLER                     PIC X(14) VALUE SPACES.        01940000
           05 FILLER                     PIC X(10) VALUE SPACES.        01950000
           05 FILLER                     PIC X(41) VALUE                01960000
             'LIST OF REGN/PCD/EMAIL/ADDRESS - TAG FORM'.               01970000
           05 FILLER                     PIC X(45) VALUE                01980000
             '(I - EXISTING FLAT OWNERS NOT FOUND IN ''SMS''.'.         01990000
                                                                        02000000
       01  OUT-HDR03.                                                   02010000
           05 FILLER                     PIC X(6)  VALUE '  SNO'.       02020000
           05 FILLER                     PIC X(09) VALUE 'REGN NO  '.   02030000
           05 FILLER                     PIC X(19)                      02040000
                    VALUE 'PCD              '.                          02050000
           05 FILLER                     PIC X(50)                      02060000
                    VALUE 'EMAIL ADDRESS  '.                            02070000
           05 FILLER                     PIC X(20)                      02080000
                    VALUE '  FLAT ADDRESS   '.                          02090000
                                                                        02100000
      ********************                                              02110000
       PROCEDURE DIVISION.                                              02120000
      ********************                                              02130000
      *-----------------*                                               02140000
       0000-MAIN-ROUTINE.                                               02150000
      *-----------------*                                               02160000
           PERFORM 1000-OPEN-FILES          THRU 1000-EXIT.             02170000
           PERFORM 2000-READ-BP13F491       THRU 2000-EXIT              02180000
             UNTIL WS-F491-EOF = 'Y'.                                   02190000
           PERFORM 9000-CLOSE-FILES         THRU 9000-EXIT.             02200000
                                                                        02210000
       0000-EXIT.                                                       02220000
                                                                        02230000
      *---------------*                                                 02240000
       1000-OPEN-FILES.                                                 02250000
      *---------------*                                                 02260000
           OPEN INPUT  BP13F491                                         02270000
                       BP13K800                                         02280000
                       AB03K030                                         02290000
                       AB03K080                                         02300000
                OUTPUT OUTFSMS                                          02310000
                       OUTFNSMS.                                        02320000
                                                                        02330000
           IF WS-BP13K800-STATUS NOT = 00 AND 97                        02340000
              DISPLAY 'ERROR OPENING BP13K800 , STATUS = '              02350000
              WS-BP13K800-STATUS                                        02360000
              MOVE WS-BP13K800-STATUS       TO RETURN-CODE              02370000
              PERFORM 9000-CLOSE-FILES      THRU 9000-EXIT              02380000
           END-IF.                                                      02390000
                                                                        02400000
           IF WS-K080-STATUS NOT = 00 AND 97                            02410000
              DISPLAY 'ERROR OPENING BP13K800 , STATUS = '              02420000
              WS-K080-STATUS                                            02430000
              MOVE WS-K080-STATUS           TO RETURN-CODE              02440000
              PERFORM 9000-CLOSE-FILES      THRU 9000-EXIT              02450000
           END-IF.                                                      02460000
                                                                        02470000
           IF WS-K030-STATUS NOT = 00 AND 97                            02480000
              DISPLAY 'ERROR OPENING BP13K800 , STATUS = '              02490000
              WS-K030-STATUS                                            02500000
              MOVE WS-K030-STATUS           TO RETURN-CODE              02510000
              PERFORM 9000-CLOSE-FILES      THRU 9000-EXIT              02520000
           END-IF.                                                      02530000
                                                                        02540000
           MOVE FUNCTION CURRENT-DATE       TO WS-DTE-TME.              02550000
           MOVE WS-DTE(1:4)                 TO WS-CCYY.                 02560000
           MOVE WS-DTE(5:2)                 TO WS-MM.                   02570000
           MOVE WS-DTE(7:2)                 TO WS-DD.                   02580000
           MOVE WS-DISPLAY-DATE             TO OUT-DATE.                02590000
                                                                        02600000
           PERFORM 1100-HEADER-EMAIL        THRU 1100-EXIT.             02610000
                                                                        02620000
       1000-EXIT.                                                       02630000
           EXIT.                                                        02640000
                                                                        02650000
      *---------------*                                                 02660000
       1100-HEADER-EMAIL.                                               02670000
      *---------------*                                                 02680000
                                                                        02690000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT1.          02700000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT1.          02710000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT2.          02720000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT2.          02730000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT3.          02740000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT3.          02750000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT3B.         02760000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT3B.         02770000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT4.          02780000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT4.          02790000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT5.          02800000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT5.          02810000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT6.          02820000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT6.          02830000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT6B.         02840000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT6B.         02850000
           WRITE OUTFSMS-REC                FROM WS-MAIL-RPT7.          02860000
           WRITE OUTFNSMS-REC               FROM WS-MAIL-RPT8.          02870000
           MOVE WS-DISPLAY-DATE             TO WS-DATE-RPT.             02880000
           WRITE OUTFSMS-REC                FROM WS-DATE-RPT-DTL.       02890000
           WRITE OUTFNSMS-REC               FROM WS-DATE-RPT-DTL.       02900000
                                                                        02910000
           MOVE SPACES                      TO OUTFSMS-REC.             02920000
           MOVE SPACES                      TO OUTFNSMS-REC.            02930000
           WRITE OUTFSMS-REC.                                           02940000
           WRITE OUTFNSMS-REC.                                          02950000
                                                                        02960000
           WRITE OUTFSMS-REC                FROM OUT-HDR01.             02970000
           WRITE OUTFNSMS-REC               FROM OUT-HDR01.             02980000
                                                                        02990000
           MOVE SPACES                      TO OUTFSMS-REC.             03000000
           MOVE SPACES                      TO OUTFNSMS-REC.            03010000
           WRITE OUTFSMS-REC.                                           03020000
           WRITE OUTFNSMS-REC.                                          03030000
                                                                        03040000
           WRITE OUTFSMS-REC                FROM OUT-HDR02-SMS.         03050000
           WRITE OUTFNSMS-REC               FROM OUT-HDR02-NSMS.        03060000
                                                                        03070000
           MOVE SPACES                      TO OUTFSMS-REC.             03080000
           MOVE SPACES                      TO OUTFNSMS-REC.            03090000
           WRITE OUTFSMS-REC.                                           03100000
           WRITE OUTFNSMS-REC.                                          03110000
                                                                        03120000
           WRITE OUTFSMS-REC                FROM OUT-HDR03.             03130000
           WRITE OUTFNSMS-REC               FROM OUT-HDR03.             03140000
                                                                        03150000
           MOVE ALL '='                     TO OUTFSMS-REC(1:136)       03160000
                                               OUTFNSMS-REC(1:136).     03170000
           WRITE OUTFSMS-REC.                                           03180000
           WRITE OUTFNSMS-REC.                                          03190000
                                                                        03200000
       1100-EXIT.                                                       03210000
            EXIT.                                                       03220000
                                                                        03230000
      *------------------*                                              03240000
       2000-READ-BP13F491.                                              03250000
      *------------------*                                              03260000
           READ BP13F491                                                03270000
             AT END                                                     03280000
                MOVE 'Y'                    TO WS-F491-EOF              03290000
             NOT AT END                                                 03300000
                ADD 1                       TO WS-F491-READ             03310000
                MOVE SPACES                 TO OUTFSMS-REC              03320000
                                               OUTFNSMS-REC             03330000
                                               WS-OUTFILE-REC           03340000
                MOVE F491-NUM-REGN          TO OUT-NUM-REGN             03350000
                MOVE F491-DTE-PCD           TO OUT-DTE-PCD              03360000
                MOVE F491-NUM-EMAIL         TO OUT-NUM-EMAIL            03370000
                MOVE F491-NUM-BLK           TO OUT-NUM-BLK              03380000
                MOVE F491-NUM-LEVEL         TO OUT-NUM-LEVEL            03390000
                MOVE F491-NUM-MAIN-UNIT     TO OUT-NUM-MAIN-UNIT        03400000
                MOVE F491-NUM-STREET        TO OUT-NUM-STREET           03410000
                MOVE F491-NUM-POSTAL        TO OUT-NUM-POSTAL           03420000
                                                                        03430000
                PERFORM 3000-READ-BP13K800  THRU 3000-EXIT              03440000
                                                                        03450000
                IF K800-FND = 'Y'                                       03460000
                   PERFORM 4000-CHECK-SMS   THRU 4000-EXIT              03470000
                   IF WS-SMS = 'Y'                                      03480000
                      ADD 1                 TO WS-OUTFSMS-CTR           03490000
                      MOVE WS-OUTFSMS-CTR   TO OUT-SER-NO               03500000
                      MOVE WS-OUTFILE-REC   TO OUTFSMS-REC              03510000
                      WRITE OUTFSMS-REC                                 03520000
                   END-IF                                               03530000
                   IF WS-SMS = 'N'                                      03540000
                      ADD 1                 TO WS-OUTFNSMS-CTR          03550000
                      MOVE WS-OUTFNSMS-CTR  TO OUT-SER-NO               03560000
                      MOVE WS-OUTFILE-REC   TO OUTFNSMS-REC             03570000
                      WRITE OUTFNSMS-REC                                03580000
                   END-IF                                               03590000
                END-IF                                                  03600000
           END-READ.                                                    03610000
                                                                        03620000
       2000-EXIT.                                                       03630000
           EXIT.                                                        03640000
                                                                        03650000
      *------------------*                                              03660000
       3000-READ-BP13K800.                                              03670000
      *------------------*                                              03680000
           MOVE SPACES                      TO K800-NUM-REGN.           03690000
           MOVE F491-NUM-REGN               TO K800-NUM-REGN.           03700000
                                                                        03710000
           READ BP13K800.                                               03720000
                                                                        03730000
           EVALUATE WS-BP13K800-STATUS                                  03740000
               WHEN 00                                                  03750000
                    ADD 1                   TO WS-K800-FND              03760000
                    MOVE 'Y'                TO K800-FND                 03770000
               WHEN 23                                                  03780000
                    ADD 1                   TO WS-K800-NFND             03790000
                    MOVE 'N'                TO K800-FND                 03800000
               WHEN OTHER                                               03810000
                    DISPLAY 'BP13K800 - ERROR IN READING , '            03820000
                    'K800-STATUS = ' WS-BP13K800-STATUS                 03830000
                    MOVE WS-BP13K800-STATUS  TO RETURN-CODE             03840000
                    PERFORM 9000-CLOSE-FILES THRU 9000-EXIT             03850000
           END-EVALUATE.                                                03860000
                                                                        03870000
       3000-EXIT.                                                       03880000
           EXIT.                                                        03890000
                                                                        03900000
      *--------------*                                                  03910000
       4000-CHECK-SMS.                                                  03920000
      *--------------*                                                  03930000
            IF (K800-NUM-NRIC1 NOT = SPACES AND LOW-VALUES) AND         03940000
               (K800-NUM-NRIC1(1:1) NOT = '#')                          03950000
               MOVE SPACES                  TO AB03K080-REC             03960000
                                               WS-SMS                   03970000
               MOVE K800-NUM-NRIC1          TO K080-NUM-UIN             03980000
                                               WS-NRIC                  03990000
               PERFORM 4100-READ-K080       THRU 4100-EXIT              04000000
            END-IF.                                                     04010000
                                                                        04020000
       4000-EXIT.                                                       04030000
            EXIT.                                                       04040000
                                                                        04050000
      *--------------*                                                  04060000
       4100-READ-K080.                                                  04070000
      *--------------*                                                  04080000
           MOVE 'N'                         TO WS-FLAG                  04090000
           START AB03K080 KEY > K080-KEY                                04100000
                                                                        04110000
           IF WS-K080-STATUS = 00                                       04120000
              PERFORM UNTIL WS-FLAG = 'Y'                               04130000
                 READ AB03K080 NEXT RECORD                              04140000
                      AT END MOVE 'Y'       TO WS-FLAG                  04150000
                 END-READ                                               04160000
                 IF WS-K080-STATUS = 00                                 04170000
                    IF WS-NRIC = K080-NUM-UIN                           04180000
                       MOVE SPACES          TO AB03K030-REC             04190000
                       MOVE K080-NUM-HDB-REF  TO K030-NUM-HDB-REF       04200000
                       PERFORM 4110-READ-K030 THRU 4110-EXIT            04210000
                    ELSE                                                04220000
                       MOVE 'Y'             TO WS-FLAG                  04230000
                    END-IF                                              04240000
                 END-IF                                                 04250000
              END-PERFORM                                               04260000
           ELSE                                                         04270000
              DISPLAY 'ERROR WITH START READ OF AM03K080. STATUS IS '   04280000
                      WS-K080-STATUS                                    04290000
              MOVE WS-K080-STATUS           TO RETURN-CODE              04300000
              PERFORM 9000-CLOSE-FILES      THRU 9000-EXIT              04310000
           END-IF.                                                      04320000
                                                                        04330000
       4100-EXIT.                                                       04340000
           EXIT.                                                        04350000
                                                                        04360000
      *--------------*                                                  04370000
       4110-READ-K030.                                                  04380000
      *--------------*                                                  04390000
             READ AB03K030                                              04400000
                                                                        04410000
             IF WS-K030-STATUS = 00                                     04420000
                IF K030-CDE-ACCT-STAT = 'C' AND                         04430000
                   K030-CDE-SALES-TYP NOT = '13' AND '18'               04440000
                   MOVE 'Y'                 TO WS-SMS                   04450000
                END-IF                                                  04460000
             ELSE                                                       04470000
                IF WS-K030-STATUS = 23                                  04480000
                   MOVE 'N'                 TO WS-SMS                   04490000
                ELSE                                                    04500000
                   DISPLAY 'ERROR READ AB03K030,STATUS ' WS-K030-STATUS 04510000
                   MOVE WS-K030-STATUS      TO RETURN-CODE              04520000
                   PERFORM 9000-CLOSE-FILES THRU 9000-EXIT              04530000
                END-IF                                                  04540000
             END-IF.                                                    04550000
                                                                        04560000
       4110-EXIT.                                                       04570000
            EXIT.                                                       04580000
                                                                        04590000
      *----------------*                                                04600000
       9000-CLOSE-FILES.                                                04610000
      *----------------*                                                04620000
           CLOSE BP13F491                                               04630000
                 BP13K800                                               04640000
                 AB03K030                                               04650000
                 AB03K080                                               04660000
                 OUTFSMS                                                04670000
                 OUTFNSMS.                                              04680000
                                                                        04690000
           IF WS-BP13K800-STATUS NOT = 00 AND 97                        04700000
              DISPLAY 'ERROR CLOSING BP13K800 , STATUS = '              04710000
              WS-BP13K800-STATUS                                        04720000
              MOVE WS-BP13K800-STATUS       TO RETURN-CODE              04730000
           END-IF.                                                      04740000
                                                                        04750000
           IF WS-K080-STATUS NOT = 00 AND 97                            04760000
              DISPLAY 'ERROR CLOSING BP13K800 , STATUS = '              04770000
              WS-K080-STATUS                                            04780000
              MOVE WS-K080-STATUS           TO RETURN-CODE              04790000
           END-IF.                                                      04800000
                                                                        04810000
           IF WS-K030-STATUS NOT = 00 AND 97                            04820000
              DISPLAY 'ERROR CLOSING BP13K800 , STATUS = '              04830000
              WS-K030-STATUS                                            04840000
              MOVE WS-K030-STATUS           TO RETURN-CODE              04850000
           END-IF.                                                      04860000
                                                                        04870000
           DISPLAY ' '.                                                 04880000
           DISPLAY 'PROGRAM NAME   :  BP13C497'.                        04890000
           DISPLAY 'DATE OF RUN    :' WS-DISPLAY-DATE.                  04900000
           DISPLAY ' '.                                                 04910000
           DISPLAY 'RECORDS READ FROM BP13F491  : ' WS-F491-READ.       04920000
           DISPLAY 'RECORDS FOUND IN BP13K800   : ' WS-K800-FND.        04930000
           DISPLAY 'RECORDS NOT FND IN BP13K800 : ' WS-K800-NFND.       04940000
           DISPLAY 'RECODRS WRITE INTO OUTFSMS  : ' WS-OUTFSMS-CTR.     04950000
           DISPLAY 'RECODRS WRITE INTO OUTFNSMS : ' WS-OUTFNSMS-CTR.    04960000
           DISPLAY ' '.                                                 04970000
                                                                        04980000
           STOP RUN.                                                    04990000
                                                                        05000000
       9000-EXIT.                                                       05010000
           EXIT.                                                        05020000
