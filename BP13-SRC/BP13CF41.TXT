       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.    BP13CF41.                                                 
      *AUTHOR.        ZDD1.                                                     
      *DATE-WRITTEN.  10/11/2011.                                               
      *========================================================*                
      * SYSTEM OF COMMITMENT (BP13)                            *                
      *========================================================*                
      *    OBJECTIVE :                                         *                
      *      1.  READ BP13F740 BALLOT FILE                     *                
      *      2.  READ BP13K74C TO GET THE RANDOM NUMBER FOR    *                
      *          OTHER ALLOC-SCHEME, EG MCPS, PA               *                
      *--------------------------------------------------------*                
      * CHG-NO    BY  DATE    DESCRIPTION                      *                
      * -------  ---  ------  -----------                      *                
      * BP13XXXX ZDD1 101111  NEW PROGRAM                      *                
      *========================================================*                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
           SELECT BP13F740 ASSIGN TO BP13F740.                                  
                                                                                
           SELECT BP13K74A ASSIGN TO BP13K74A                                   
                  ACCESS MODE     IS RANDOM                                     
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K74A-KEY-FLD                               
                  FILE STATUS     IS WS-BP13K74A-STATUS.                        
                                                                                
           SELECT BP13K74C ASSIGN TO BP13K74C                                   
                  ACCESS MODE     IS DYNAMIC                                    
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K74C-KEY-FLD                               
                  FILE STATUS     IS WS-BP13K74C-STATUS.                        
                                                                                
           SELECT BP13K74E ASSIGN TO BP13K74E                                   
                  ACCESS MODE     IS RANDOM                                     
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K74E-KEY-FLD                               
                  FILE STATUS     IS WS-BP13K74E-STATUS.                        
                                                                                
           SELECT BP13K74G ASSIGN TO BP13K74G                                   
                  ACCESS MODE     IS RANDOM                                     
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K74G-KEY-FLD                               
                  FILE STATUS     IS WS-BP13K74G-STATUS.                        
                                                                                
           SELECT BP13F74A ASSIGN TO BP13F74A.                                  
                                                                                
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
                                                                                
       FD   BP13F740                                                            
            RECORD CONTAINS 500 CHARACTERS                                      
            BLOCK  CONTAINS 0   RECORDS                                         
            LABEL  RECORDS ARE  STANDARD                                        
            RECORDING MODE IS F.                                                
                                                                                
       COPY BP13F740.                                                           
                                                                                
       FD   BP13K74A                                                            
            RECORD CONTAINS 300 CHARACTERS.                                     
       COPY BP13K74A.                                                           
                                                                                
       FD   BP13K74C                                                            
            RECORD CONTAINS 100 CHARACTERS.                                     
       COPY BP13K74C.                                                           
                                                                                
       FD   BP13K74E                                                            
            RECORD CONTAINS 300 CHARACTERS.                                     
       COPY BP13K74E.                                                           
                                                                                
       FD   BP13K74G                                                            
            RECORD CONTAINS 300 CHARACTERS.                                     
       COPY BP13K74G.                                                           
                                                                                
       FD   BP13F74A                                                            
            RECORD CONTAINS 300 CHARACTERS                                      
            BLOCK  CONTAINS 0   RECORDS                                         
            LABEL  RECORDS ARE  STANDARD                                        
            RECORDING MODE IS F.                                                
                                                                                
       COPY BP13F74A.                                                           
                                                                                
       WORKING-STORAGE SECTION.                                                 
       01  WS-FILE-STATUS.                                                      
           05  WS-BP13K74A-STATUS   PIC 9(2)    VALUE ZEROES.                   
           05  WS-BP13K74C-STATUS   PIC 9(2)    VALUE ZEROES.                   
           05  WS-BP13K74E-STATUS   PIC 9(2)    VALUE ZEROES.                   
           05  WS-BP13K74G-STATUS   PIC 9(2)    VALUE ZEROES.                   
                                                                                
       01  WS-COUNTERS.                                                         
           05 WS-F740-READ          PIC 9(6)    VALUE ZEROES.                   
           05 WS-K74C-READ          PIC 9(6)    VALUE ZEROES.                   
           05 WS-K74A-WRT           PIC 9(6)    VALUE ZEROES.                   
           05 WS-K74E-WRT           PIC 9(6)    VALUE ZEROES.                   
           05 WS-K74G-WRT           PIC 9(6)    VALUE ZEROES.                   
           05 WS-F74A-WRT           PIC 9(6)    VALUE ZEROES.                   
           05 WS-BYPASS             PIC 9(6)    VALUE ZEROES.                   
           05 WS-K74C-REGN          PIC 9(2)    VALUE ZEROES.                   
                                                                                
       01  WS-VARIABLES.                                                        
           05 EOF-BP13F740          PIC X(2)    VALUE SPACES.                   
           05 WS-FOUND              PIC X(1)    VALUE 'N'.                      
           05 EOF-BP13K74C          PIC X(2)    VALUE SPACES.                   
           05 WS-END-OF-PROCESS     PIC X(1)    VALUE 'N'.                      
           05 WS-MCPS               PIC X(1)    VALUE SPACES.                   
           05 WS-HHTY               PIC X(1)    VALUE SPACES.                   
           05 WS-TEMP-RAND-NUM      PIC X(28)   VALUE SPACES.                   
           05 WS-FIRST-READ         PIC X(1)    VALUE 'N'.                      
           05 WS-CTR                PIC 9(1)    VALUE ZERO.                     
                                                                                
       01  WS-KEY.                                                              
           05 WS-DTE-BALLOT         PIC X(6)    VALUE SPACES.                   
           05 WS-NUM-ALLO-CAT       PIC X(3)    VALUE SPACES.                   
           05 WS-NUM-REGN           PIC X(8)    VALUE 'N'.                      
                                                                                
       01  WS-ALLOCSCH-TYPE               PIC X(3)    VALUE SPACES.             
       COPY PRIOSCH.                                                            
                                                                                
       PROCEDURE DIVISION.                                                      
      *------------------------------------------------------------             
       0000-MAIN.                                                               
      *------------------------------------------------------------             
                                                                                
           OPEN INPUT  BP13F740                                                 
                       BP13K74C                                                 
                I-O    BP13K74A                                                 
                       BP13K74E                                                 
                       BP13K74G                                                 
               OUTPUT  BP13F74A.                                                
                                                                                
           IF WS-BP13K74A-STATUS NOT = 0 AND 97                                 
              DISPLAY 'FILE BP13K74A OPEN ERROR'  WS-BP13K74A-STATUS            
              MOVE WS-BP13K74A-STATUS TO RETURN-CODE                            
              PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                         
           END-IF.                                                              
                                                                                
           IF WS-BP13K74C-STATUS NOT = 0 AND 97                                 
              DISPLAY 'FILE BP13K74C OPEN ERROR'  WS-BP13K74C-STATUS            
              MOVE WS-BP13K74C-STATUS TO RETURN-CODE                            
              PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                         
           END-IF.                                                              
                                                                                
           IF WS-BP13K74E-STATUS NOT = 0 AND 97                                 
              DISPLAY 'FILE BP13K74E OPEN ERROR'  WS-BP13K74E-STATUS            
              MOVE WS-BP13K74E-STATUS TO RETURN-CODE                            
              PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                         
           END-IF.                                                              
                                                                                
           IF WS-BP13K74G-STATUS NOT = 0 AND 97                                 
              DISPLAY 'FILE BP13K74G OPEN ERROR'  WS-BP13K74G-STATUS            
              MOVE WS-BP13K74G-STATUS TO RETURN-CODE                            
              PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                         
           END-IF.                                                              
                                                                                
           PERFORM 1000-READ-F740-REC THRU 1000-EXIT.                           
           PERFORM 2000-PROCESS-REC   THRU 2000-EXIT                            
                   UNTIL EOF-BP13F740 = 'Y'.                                    
           PERFORM 9000-CLOSE-ROUTINE.                                          
                                                                                
       0000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       1000-READ-F740-REC.                                                      
      *------------------------------------------------------------             
                                                                                
           READ BP13F740 AT END MOVE 'Y' TO EOF-BP13F740                        
                GO TO 1000-EXIT.                                                
                                                                                
           ADD 1 TO WS-F740-READ.                                               
                                                                                
       1000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       2000-PROCESS-REC.                                                        
      *------------------------------------------------------------             
                                                                                
           IF F740-CDE-BALLOT-HOUSEHOLD = SPACES                                
              MOVE F740-CDE-HOUSEHOLD TO WS-HHTY                                
              IF F740-CDE-BALLOT-HOUSEHOLD = 'T'                                
                 MOVE 'H' TO  WS-HHTY                                           
              END-IF                                                            
           ELSE                                                                 
              MOVE F740-CDE-BALLOT-HOUSEHOLD TO WS-HHTY                         
              IF F740-CDE-BALLOT-HOUSEHOLD = 'T'                                
                 MOVE 'H'    TO WS-HHTY                                         
              END-IF                                                            
           END-IF.                                                              
                                                                                
      *    PERFORM 2500-GET-PRIO-SCH   THRU 2500-EXIT.                          
                                                                                
           IF (F740-NUM-MCPS NOT = SPACE AND LOW-VALUE) AND                     
              (F740-CDE-RESIDENT-HA1 NOT = 'H' AND                              
               F740-CDE-RESIDENT-HA1 NOT = 'P' AND                              
               F740-CDE-RESIDENT-HA1 NOT = 'M' )                                
               MOVE 'Y'      TO WS-MCPS                                         
               MOVE 'MCP'    TO WS-ALLOCSCH-TYPE                                
           ELSE                                                                 
               MOVE 'N'                   TO WS-MCPS                            
               MOVE F740-CDE-ALLOC-SCH    TO WS-ALLOCSCH-TYPE                   
           END-IF.                                                              
           PERFORM 2400-READ-BP13K74A  THRU 2400-EXIT.                          
                                                                                
           IF WS-FOUND = 'Y'                                                    
              ADD 1 TO WS-BYPASS                                                
           ELSE                                                                 
              MOVE SPACES                TO BP13K74A-REC                        
              INITIALIZE                    BP13K74A-REC                        
              MOVE 'N'                   TO EOF-BP13K74C                        
                                            WS-END-OF-PROCESS                   
              MOVE ZERO                  TO WS-CTR                              
              MOVE SPACES                TO K74C-KEY-FLD                        
              MOVE F740-DTE-BALLOT       TO K74C-DTE-BALLOT                     
                                            WS-DTE-BALLOT                       
              MOVE F740-NUM-ALLO-CAT     TO K74C-NUM-ALLO-CAT                   
                                            WS-NUM-ALLO-CAT                     
              MOVE F740-NUM-REGN         TO K74C-NUM-REGN                       
                                            WS-NUM-REGN                         
              PERFORM 2700-BROWSE-BP13K74C  THRU 2700-EXIT                      
              PERFORM 4000-MOVE-DETAILS     THRU 4000-EXIT                      
              PERFORM 4500-WRITE-BP13K74A   THRU 4500-EXIT                      
              PERFORM 2800-READ-BP13K74E    THRU 2800-EXIT                      
              PERFORM 2900-READ-BP13K74G    THRU 2900-EXIT                      
           END-IF.                                                              
                                                                                
           PERFORM 1000-READ-F740-REC  THRU 1000-EXIT.                          
                                                                                
       2000-EXIT.                                                               
           EXIT.                                                                
                                                                                
                                                                                
      *------------------------------------------------------------             
       2400-READ-BP13K74A.                                                      
      *------------------------------------------------------------             
            MOVE SPACES           TO BP13K74A-REC                               
            MOVE F740-DTE-BALLOT     TO K74A-DTE-BALLOT                         
            MOVE F740-CDE-NT1        TO K74A-NUM-ZONE                           
            MOVE F740-CDE-FLAT-TYPE  TO K74A-NUM-FLAT-TYPE                      
            MOVE WS-ALLOCSCH-TYPE    TO K74A-NUM-PRIORITY-SCH                   
            MOVE WS-HHTY             TO K74A-NUM-HHTY                           
            IF F740-CDE-CATEGORY = '4'                                          
               MOVE '3'              TO K74A-NUM-CATEGORY                       
            ELSE                                                                
              MOVE F740-CDE-CATEGORY   TO K74A-NUM-CATEGORY                     
            END-IF                                                              
      *     MOVE F740-CDE-COHORT     TO K74A-NUM-COHORT                         
            MOVE F740-NUM-RANDOM     TO K74A-NUM-RANDOM-NO                      
            MOVE F740-NUM-RANDOM-PRIORITY TO K74A-NUM-RANDOM-PRIORITY           
                                                                                
            READ BP13K74A.                                                      
                                                                                
            EVALUATE WS-BP13K74A-STATUS                                         
              WHEN 00                                                           
                 MOVE 'Y'   TO  WS-FOUND                                        
              WHEN 10                                                           
              WHEN 23                                                           
                 MOVE 'N'   TO  WS-FOUND                                        
      *          DISPLAY 'REC NOT FOUND IN BP13K74A - ' K74A-KEY-FLD            
              WHEN OTHER                                                        
                  DISPLAY 'READ BP13K74A ERROR ' WS-BP13K74A-STATUS             
                  MOVE WS-BP13K74A-STATUS          TO RETURN-CODE               
                  PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                     
            END-EVALUATE.                                                       
                                                                                
       2400-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       2500-GET-PRIO-SCH.                                                       
      *------------------------------------------------------------             
                                                                                
           SET WS-ALLOC-PTR TO 1.                                               
                                                                                
           SEARCH WS-ALLOC-SCH                                                  
              AT END MOVE 'XXX' TO WS-ALLOCSCH-TYPE                             
              WHEN F740-CDE-ALLOC-SCH =                                         
                                WS-ALLOC-SCH-DESP(WS-ALLOC-PTR)                 
              MOVE WS-MAIN-SCH-CD(WS-ALLOC-PTR) TO                              
                                      WS-ALLOCSCH-TYPE.                         
                                                                                
                                                                                
       2500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       2700-BROWSE-BP13K74C.                                                    
      *------------------------------------------------------------             
                                                                                
           MOVE SPACES TO WS-TEMP-RAND-NUM.                                     
           MOVE 'Y'    TO WS-FIRST-READ.                                        
           MOVE 'N'    TO WS-END-OF-PROCESS                                     
                          EOF-BP13K74C.                                         
           MOVE ZEROS TO WS-K74C-REGN.                                          
           START BP13K74C KEY >= K74C-KEY-FLD.                                  
                                                                                
            EVALUATE WS-BP13K74C-STATUS                                         
              WHEN 00                                                           
              WHEN 02                                                           
                 PERFORM 2750-READNEXT-K74C THRU 2750-EXIT                      
                 PERFORM 3000-PROCESS-RECORD  THRU 3000-EXIT                    
                       UNTIL WS-END-OF-PROCESS = 'Y'                            
                       OR    EOF-BP13K74C = 'Y'                                 
              WHEN 10                                                           
              WHEN 23                                                           
                 DISPLAY 'REC NOT FOUND IN BP13K74C - ' K74C-KEY-FLD            
              WHEN OTHER                                                        
                  DISPLAY 'READ BP13K74C ERROR ' WS-BP13K74C-STATUS             
                  MOVE WS-BP13K74C-STATUS          TO RETURN-CODE               
                  PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                     
            END-EVALUATE.                                                       
                                                                                
                                                                                
       2700-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       2750-READNEXT-K74C.                                                      
      *------------------------------------------------------------             
                                                                                
           READ BP13K74C NEXT RECORD.                                           
                                                                                
            EVALUATE WS-BP13K74C-STATUS                                         
              WHEN 00                                                           
              WHEN 02                                                           
                    IF WS-FIRST-READ = 'Y'                                      
                       MOVE 'N' TO WS-FIRST-READ                                
                       MOVE K74C-NUM-RANDOM-NO TO WS-TEMP-RAND-NUM              
                    END-IF                                                      
                    ADD 1 TO WS-CTR                                             
              WHEN 10                                                           
              WHEN 23                                                           
                 MOVE 'Y'   TO EOF-BP13K74C                                     
              WHEN OTHER                                                        
                  DISPLAY 'READNEXT BP13K74C ERROR ' WS-BP13K74C-STATUS         
                  MOVE WS-BP13K74C-STATUS          TO RETURN-CODE               
                  PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                     
            END-EVALUATE.                                                       
                                                                                
                                                                                
       2750-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       2800-READ-BP13K74E.                                                      
      *------------------------------------------------------------             
            MOVE SPACES                 TO BP13K74E-REC                         
            MOVE F740-DTE-BALLOT        TO K74E-DTE-BALLOT                      
            MOVE F740-CDE-NT1           TO K74E-NUM-ZONE                        
            MOVE F740-CDE-FLAT-TYPE     TO K74E-NUM-FLAT-TYPE                   
            MOVE WS-ALLOCSCH-TYPE       TO K74E-NUM-PRIORITY-SCH                
            MOVE WS-HHTY                TO K74E-NUM-HHTY                        
      *     MOVE F740-CDE-CATEGORY      TO K74E-NUM-CATEGORY                    
      *     MOVE F740-CDE-COHORT        TO K74E-NUM-COHORT                      
            MOVE F740-NUM-RANDOM        TO K74E-NUM-RANDOM                      
                                                                                
            READ BP13K74E.                                                      
                                                                                
            EVALUATE WS-BP13K74E-STATUS                                         
              WHEN 00                                                           
                 CONTINUE                                                       
              WHEN 10                                                           
              WHEN 23                                                           
                 PERFORM  4600-WRITE-BP13K74E   THRU 4600-EXIT                  
              WHEN OTHER                                                        
                  DISPLAY 'READ BP13K74E ERROR ' WS-BP13K74E-STATUS             
                  MOVE WS-BP13K74E-STATUS          TO RETURN-CODE               
                  PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                     
            END-EVALUATE.                                                       
                                                                                
       2800-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       2900-READ-BP13K74G.                                                      
      *------------------------------------------------------------             
            MOVE SPACES                 TO BP13K74G-REC                         
            MOVE F740-DTE-BALLOT        TO K74G-DTE-BALLOT                      
            MOVE F740-CDE-NT1           TO K74G-NUM-ZONE                        
            MOVE F740-CDE-FLAT-TYPE     TO K74G-NUM-FLAT-TYPE                   
            MOVE K74A-NUM-COHORT        TO K74G-NUM-COHORT                      
            MOVE WS-ALLOCSCH-TYPE       TO K74G-NUM-PRIORITY-SCH                
      *     MOVE WS-HHTY                TO K74G-NUM-HHTY                        
            MOVE F740-NUM-RANDOM(10:19) TO K74G-NUM-RANDOM-NO                   
            MOVE F740-NUM-RANDOM-PRIORITY TO K74G-NUM-RANDOM-PRIORITY           
                                                                                
            READ BP13K74G.                                                      
                                                                                
            EVALUATE WS-BP13K74G-STATUS                                         
              WHEN 00                                                           
                 CONTINUE                                                       
              WHEN 10                                                           
              WHEN 23                                                           
                 PERFORM  4700-WRITE-BP13K74G   THRU 4700-EXIT                  
              WHEN OTHER                                                        
                  DISPLAY 'READ BP13K74G ERROR ' WS-BP13K74G-STATUS             
                  MOVE WS-BP13K74G-STATUS          TO RETURN-CODE               
                  PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                     
            END-EVALUATE.                                                       
                                                                                
       2900-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *                                                                         
      * MCPS FT = 4 RANDOM-NO                                                   
      * MCPS ST = 2 RANDOM-NO                                                   
      * PA   FT = 2 RANDOM-NO                                                   
      * PA   ST = 1 RANDOM-NO                                                   
      *                                                                         
      *------------------------------------------------------------             
       3000-PROCESS-RECORD.                                                     
      *------------------------------------------------------------             
                                                                                
      *    DISPLAY '3000-' F740-NUM-REGN                                        
      *            ' H=' WS-HHTY                                                
      *            ' MCP=' WS-MCPS                                              
      *            ' R=' WS-ALLOCSCH-TYPE                                       
      *            ' R/N=' F740-NUM-RANDOM                                      
      *            ' B=' K74C-NUM-REGN                                          
      *            ' N=' K74C-NUM-RANDOM-NO.                                    
                                                                                
           IF F740-CDE-HOUSEHOLD = 'H' OR 'T'                                   
               IF K74C-KEY-FLD(1:17) = WS-KEY                                   
                  PERFORM 3100-CHECK-FIRST-TIMER THRU 3100-EXIT                 
                      UNTIL WS-END-OF-PROCESS = 'Y' OR                          
                            EOF-BP13K74C = 'Y'                                  
               END-IF                                                           
           END-IF.                                                              
                                                                                
           IF F740-CDE-HOUSEHOLD = 'G'                                          
      *     DISPLAY K74C-KEY-FLD(1:17) '/' WS-KEY                               
            IF K74C-KEY-FLD(1:17) = WS-KEY                                      
              IF WS-MCPS  = 'Y'                                                 
                  PERFORM 3200-CHECK-UPGRADER THRU 3200-EXIT                    
              ELSE                                                              
                PERFORM UNTIL WS-CTR > 4 OR EOF-BP13K74C = 'Y'                  
                  IF K74C-NUM-RANDOM-NO < WS-TEMP-RAND-NUM                      
                      MOVE K74C-NUM-RANDOM-NO TO WS-TEMP-RAND-NUM               
                  END-IF                                                        
                  IF WS-CTR = 2                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-FT-PA             
                                              K74A-NUM-RANDOM-ST-MCP            
                  END-IF                                                        
                  IF WS-CTR = 4                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-FT-MCP            
                  END-IF                                                        
                  PERFORM 2750-READNEXT-K74C THRU 2750-EXIT                     
                END-PERFORM                                                     
                 MOVE 'Y'                TO WS-END-OF-PROCESS                   
              END-IF                                                            
            END-IF                                                              
           END-IF.                                                              
                                                                                
       3000-EXIT.                                                               
           EXIT.                                                                
                                                                                
       3100-CHECK-FIRST-TIMER.                                                  
      *                                                                         
      * MCPS FT = 4 RANDOM-NO                                                   
      * MCPS ST = 2 RANDOM-NO                                                   
      * PA   FT = 2 RANDOM-NO                                                   
      * PA   ST = 1 RANDOM-NO                                                   
      *                                                                         
           IF WS-MCPS    = 'Y'                                                  
                PERFORM UNTIL WS-CTR > 3 OR EOF-BP13K74C = 'Y'                  
                  IF K74C-NUM-RANDOM-NO < WS-TEMP-RAND-NUM                      
                      MOVE K74C-NUM-RANDOM-NO TO WS-TEMP-RAND-NUM               
                  END-IF                                                        
                  IF WS-CTR = 1                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-ST-PA             
                  END-IF                                                        
                  IF WS-CTR = 2                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-ST-MCP            
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-FT-PA             
                    MOVE 'Y'                TO WS-END-OF-PROCESS                
                  END-IF                                                        
                  PERFORM 2750-READNEXT-K74C THRU 2750-EXIT                     
                END-PERFORM                                                     
                                                                                
           ELSE                                                                 
              IF K74C-NUM-RANDOM-NO < WS-TEMP-RAND-NUM                          
                 MOVE K74C-NUM-RANDOM-NO TO WS-TEMP-RAND-NUM                    
              END-IF                                                            
              PERFORM UNTIL WS-CTR > 4 OR EOF-BP13K74C = 'Y'                    
                  IF K74C-NUM-RANDOM-NO < WS-TEMP-RAND-NUM                      
                      MOVE K74C-NUM-RANDOM-NO TO WS-TEMP-RAND-NUM               
                  END-IF                                                        
                  IF WS-CTR = 1                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-ST-PA             
                  END-IF                                                        
                  IF WS-CTR = 2                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-ST-MCP            
                  END-IF                                                        
                  IF WS-CTR = 4                                                 
                    MOVE WS-TEMP-RAND-NUM  TO K74A-NUM-RANDOM-FT-MCP            
                    MOVE 'Y'                TO WS-END-OF-PROCESS                
                  END-IF                                                        
                  PERFORM 2750-READNEXT-K74C THRU 2750-EXIT                     
              END-PERFORM                                                       
           END-IF.                                                              
                                                                                
       3100-EXIT.                                                               
           EXIT.                                                                
                                                                                
       3200-CHECK-UPGRADER.                                                     
                                                                                
           PERFORM UNTIL WS-CTR > 4 OR EOF-BP13K74C = 'Y'                       
             IF K74C-NUM-RANDOM-NO < WS-TEMP-RAND-NUM                           
                MOVE K74C-NUM-RANDOM-NO TO WS-TEMP-RAND-NUM                     
             END-IF                                                             
                                                                                
             IF WS-CTR = 1                                                      
                MOVE WS-TEMP-RAND-NUM   TO K74A-NUM-RANDOM-ST-PA                
             END-IF                                                             
                                                                                
             IF WS-CTR = 2                                                      
                MOVE WS-TEMP-RAND-NUM   TO K74A-NUM-RANDOM-FT-PA                
             END-IF                                                             
                                                                                
             IF WS-CTR = 4                                                      
                MOVE WS-TEMP-RAND-NUM   TO K74A-NUM-RANDOM-FT-MCP               
                MOVE 'Y'                TO WS-END-OF-PROCESS                    
             END-IF                                                             
                                                                                
             PERFORM 2750-READNEXT-K74C THRU 2750-EXIT                          
           END-PERFORM.                                                         
                                                                                
       3200-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       4000-MOVE-DETAILS.                                                       
      *------------------------------------------------------------             
                                                                                
            MOVE F740-DTE-BALLOT       TO K74A-DTE-BALLOT.                      
            MOVE F740-CDE-NT1          TO K74A-NUM-ZONE.                        
            MOVE F740-CDE-FLAT-TYPE    TO K74A-NUM-FLAT-TYPE.                   
            MOVE WS-ALLOCSCH-TYPE      TO K74A-NUM-PRIORITY-SCH.                
            MOVE WS-HHTY               TO K74A-NUM-HHTY.                        
            IF F740-CDE-CATEGORY  = '4'                                         
              MOVE '3'                 TO K74A-NUM-CATEGORY                     
            ELSE                                                                
              MOVE F740-CDE-CATEGORY     TO K74A-NUM-CATEGORY                   
            END-IF                                                              
            MOVE F740-NUM-RANDOM       TO K74A-NUM-RANDOM-NO.                   
            MOVE F740-NUM-RANDOM-PRIORITY TO                                    
                 K74A-NUM-RANDOM-PRIORITY.                                      
                                                                                
            IF  F740-CDE-COHORT = SPACES                                        
                MOVE F740-CDE-REQUEST-STATUS TO K74A-NUM-COHORT                 
            ELSE                                                                
                MOVE F740-CDE-COHORT       TO K74A-NUM-COHORT                   
            END-IF.                                                             
            MOVE F740-NUM-REGN         TO K74A-NUM-REGN.                        
            MOVE F740-NUM-NT-FT-QUEUE  TO K74A-NUM-NT-FT-QUEUE.                 
            MOVE F740-DTE-BK-APPT      TO K74A-DTE-BK-APPT.                     
            MOVE F740-TME-BK-APPT      TO K74A-TME-BK-APPT.                     
                                                                                
       4000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       4500-WRITE-BP13K74A.                                                     
      *------------------------------------------------------------             
                                                                                
            MOVE SPACES                TO BP13F74A-REC.                         
            INITIALIZE                    BP13F74A-REC.                         
            MOVE  BP13K74A-REC TO BP13F74A-REC.                                 
            WRITE BP13F74A-REC.                                                 
                                                                                
      *    DISPLAY '4500-' F74A-NUM-REGN                                        
      *            ' H=' F74A-NUM-HHTY                                          
      *            ' R=' F74A-NUM-PRIORITY-SCH                                  
      *            ' N=' F74A-NUM-RANDOM-NO                                     
      *            ' P=' F74A-NUM-RANDOM-PRIORITY                               
                                                                                
            WRITE BP13K74A-REC.                                                 
            ADD 1 TO WS-K74A-WRT.                                               
                                                                                
            EVALUATE WS-BP13K74A-STATUS                                         
              WHEN 00                                                           
              WHEN 02                                                           
              WHEN 22                                                           
                   CONTINUE                                                     
              WHEN OTHER                                                        
                   DISPLAY 'REWRITE BP13K74A ERROR ' WS-BP13K74A-STATUS         
                   MOVE WS-BP13K74A-STATUS          TO RETURN-CODE              
                   PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                    
            END-EVALUATE.                                                       
                                                                                
       4500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       4600-WRITE-BP13K74E.                                                     
      *------------------------------------------------------------             
                                                                                
            MOVE SPACES                 TO BP13K74E-REC                         
            INITIALIZE                     BP13K74E-REC.                        
            MOVE F740-DTE-BALLOT        TO K74E-DTE-BALLOT                      
            MOVE F740-CDE-NT1           TO K74E-NUM-ZONE                        
            MOVE F740-CDE-FLAT-TYPE     TO K74E-NUM-FLAT-TYPE                   
            MOVE WS-ALLOCSCH-TYPE       TO K74E-NUM-PRIORITY-SCH                
            MOVE WS-HHTY                TO K74E-NUM-HHTY                        
            MOVE F740-NUM-RANDOM        TO K74E-NUM-RANDOM                      
            IF F740-CDE-CATEGORY  =  '4'                                        
               MOVE '3'                 TO K74E-NUM-CATEGORY                    
            ELSE                                                                
              MOVE F740-CDE-CATEGORY      TO K74E-NUM-CATEGORY                  
            END-IF                                                              
            MOVE F740-CDE-COHORT        TO K74E-NUM-COHORT                      
                                                                                
            IF  F740-CDE-COHORT = SPACES                                        
                MOVE F740-CDE-REQUEST-STATUS TO K74E-NUM-COHORT                 
            ELSE                                                                
                MOVE F740-CDE-COHORT       TO K74E-NUM-COHORT                   
            END-IF.                                                             
                                                                                
            MOVE F740-NUM-REGN         TO K74E-NUM-REGN.                        
            MOVE F740-NUM-NT-FT-QUEUE  TO K74E-NUM-QUEUE.                       
            MOVE F740-DTE-BK-APPT      TO K74E-DTE-BK-APPT.                     
            MOVE F740-TME-BK-APPT      TO K74E-TME-BK-APPT.                     
                                                                                
            MOVE K74A-NUM-RANDOM-FT-MCP TO K74E-NUM-RANDOM-FT-MCP.              
            MOVE K74A-NUM-RANDOM-ST-MCP TO K74E-NUM-RANDOM-ST-MCP.              
            MOVE K74A-NUM-RANDOM-FT-PA  TO K74E-NUM-RANDOM-FT-PA.               
            MOVE K74A-NUM-RANDOM-ST-PA  TO K74E-NUM-RANDOM-ST-PA.               
                                                                                
            WRITE BP13K74E-REC.                                                 
            ADD 1 TO WS-K74E-WRT.                                               
                                                                                
            EVALUATE WS-BP13K74E-STATUS                                         
              WHEN 00                                                           
              WHEN 02                                                           
              WHEN 22                                                           
                   CONTINUE                                                     
              WHEN OTHER                                                        
                   DISPLAY 'WRITE BP13K74E ERROR ' WS-BP13K74E-STATUS           
                   MOVE WS-BP13K74E-STATUS          TO RETURN-CODE              
                   PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                    
            END-EVALUATE.                                                       
                                                                                
       4600-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       4700-WRITE-BP13K74G.                                                     
      *------------------------------------------------------------             
                                                                                
            MOVE SPACES                 TO BP13K74G-REC                         
            MOVE F740-DTE-BALLOT        TO K74G-DTE-BALLOT                      
            MOVE F740-CDE-NT1           TO K74G-NUM-ZONE                        
            MOVE F740-CDE-FLAT-TYPE     TO K74G-NUM-FLAT-TYPE                   
            MOVE WS-ALLOCSCH-TYPE       TO K74G-NUM-PRIORITY-SCH                
            MOVE K74A-NUM-COHORT        TO K74G-NUM-COHORT                      
            MOVE WS-HHTY                TO K74G-NUM-HHTY                        
            MOVE F740-NUM-RANDOM(10:19) TO K74G-NUM-RANDOM-NO                   
            MOVE F740-NUM-RANDOM-PRIORITY TO K74G-NUM-RANDOM-PRIORITY           
            MOVE F740-NUM-REGN         TO K74G-NUM-REGN.                        
            MOVE F740-NUM-NT-FT-QUEUE  TO K74G-NUM-NT-FT-QUEUE.                 
            MOVE F740-DTE-BK-APPT      TO K74G-DTE-BK-APPT.                     
            MOVE F740-TME-BK-APPT      TO K74G-TME-BK-APPT.                     
            MOVE K74A-NUM-RANDOM-FT-MCP TO K74G-NUM-RANDOM-FT-MCP.              
            MOVE K74A-NUM-RANDOM-ST-MCP TO K74G-NUM-RANDOM-ST-MCP.              
            MOVE K74A-NUM-RANDOM-FT-PA  TO K74G-NUM-RANDOM-FT-PA.               
            MOVE K74A-NUM-RANDOM-ST-PA  TO K74G-NUM-RANDOM-ST-PA.               
                                                                                
            WRITE BP13K74G-REC.                                                 
            ADD 1 TO WS-K74G-WRT.                                               
                                                                                
            EVALUATE WS-BP13K74G-STATUS                                         
              WHEN 00                                                           
              WHEN 02                                                           
              WHEN 22                                                           
                   CONTINUE                                                     
              WHEN OTHER                                                        
                   DISPLAY 'WRITE BP13K74G ERROR ' WS-BP13K74G-STATUS           
                   MOVE WS-BP13K74G-STATUS          TO RETURN-CODE              
                   PERFORM 9000-CLOSE-ROUTINE THRU 9000-EXIT                    
            END-EVALUATE.                                                       
                                                                                
       4700-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *------------------------------------------------------------             
       9000-CLOSE-ROUTINE.                                                      
      *------------------------------------------------------------             
                                                                                
           DISPLAY ' '.                                                         
           DISPLAY 'BP13CF41'.                                                  
           DISPLAY '*-----------------------------------------------*'.         
           DISPLAY 'EXCEPTIONAL REPORT BEFORE BALLOT COMMENCE'.                 
           DISPLAY '*-----------------------------------------------*'.         
           DISPLAY 'NO OF RECORDS READ FROM F740   ' WS-F740-READ.              
           DISPLAY 'NO OF RECORDS FND  FROM K74A   ' WS-BYPASS.                 
           DISPLAY 'NO OF RECORDS READ FROM F74B   ' WS-K74C-READ.              
           DISPLAY 'NO OF RECORDS UPD  FROM K74A   ' WS-K74A-WRT.               
           DISPLAY 'NO OF RECORDS UPD  FROM F74A   ' WS-F74A-WRT.               
           DISPLAY 'NO OF RECORDS FND  FROM K74A   ' WS-BYPASS.                 
                                                                                
           CLOSE BP13F740                                                       
                 BP13K74A                                                       
                 BP13K74C                                                       
                 BP13F74A                                                       
                 BP13K74E.                                                      
                                                                                
           IF  WS-BP13K74A-STATUS NOT = ZEROS AND 97                            
               DISPLAY 'CLOSING ERROR '                                         
               DISPLAY 'WS-BP13K74A-STATUS ' WS-BP13K74A-STATUS.                
                                                                                
           IF  WS-BP13K74C-STATUS NOT = ZEROS AND 97                            
               DISPLAY 'CLOSING ERROR '                                         
               DISPLAY 'WS-BP13K74C-STATUS ' WS-BP13K74C-STATUS.                
                                                                                
           IF  WS-BP13K74E-STATUS NOT = ZEROS AND 97                            
               DISPLAY 'CLOSING ERROR '                                         
               DISPLAY 'WS-BP13K74E-STATUS ' WS-BP13K74E-STATUS.                
                                                                                
                                                                                
           STOP RUN.                                                            
                                                                                
       9000-EXIT.                                                               
           EXIT.                                                                
