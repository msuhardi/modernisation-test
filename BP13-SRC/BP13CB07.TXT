      **************************                                                
       IDENTIFICATION DIVISION.                                                 
      **************************                                                
       PROGRAM-ID.    BP13CB07.                                                 
      *AUTHOR.        SHARON DUMDUM.                                            
      *DATE-WRITTEN.  16 AUGUST 2006.                                           
                                                                                
      * =========================================================== *           
      * SYSTEM OF COMMITMENT (BP13)                                 *           
      * =========================================================== *           
      *   OBJECTIVE   : TO UPDATE BP13K203 BASED ON BP13K200.       *           
      *                                                             *           
      *   INPUT FILES :                                             *           
      *   1.  BP13F200 -- SORTED BOOKING APPOINTMENT FILE           *           
      *   2.  BP13K800 -- SOC MASTER FILE                           *           
      *   3.  BP13K820 -- SOC OCCUPIER FILE                         *           
      *   4.  BP13K813 -- BTO SITE FILE                             *           
      *                                                             *           
      *   I-O FILES :                                               *           
      *   1.  BP13K203 -- SMS FILE                                  *           
      *                                                             *           
      * CHQ REQ     DATE     BY  DESCRIPTIONS                       *           
      * -------- ---------- ---- ---------------------------------- *           
      * BP132851 16/08/2006 SD10 NEW PROGRAM                        *           
      *          06/11/2006 SD10 TO READ BP13K767 FOR BTO CASES     *           
      * BP133333 28/07/2008 RVC1 READ FROM BP13K200 TO GET          *           
      *                  K200-DTE-BKAPPMT-DATE AND K200-TME-BKAPPMT *           
      * BP133367 26/08/2008 CT2  MOVE 'SER' TO ALLO-CAT IF          *           
      *                          FLAT-TYPE = 'SE'                   *           
      * BP133451 10/10/2008 CT2  CHECK K800-NUM-ALLO-CAT FOR BTO    *           
      *                          AND SER CASES                      *           
      * BP133610 24/04/2009 ESA1 TO REPLACE BP13K767 W/ BP13K813    *           
      * BP133707 28/10/2009 CT2  TO CATER  FOR NPL CASES (BL MSG)   *           
      * BP134513 17/04/2012 ESA1 TO CATER FOR MGPS                  *           
      * BP135941 01/09/2015 FNP1 ADD 'BI' APPT TYPE FOR CASES WHERE *           
      *                          K200-NUM-PRINT-TAG = T             *           
      * BP136040 03/03/2016 ZDD1 CHANGE BP13K816 TO BP13K813        *           
      * BP136192 27/04/2016 ESA1 TO CATER FOR BN APPOINTMENT TYPE   *           
      * BP136336 19/08/2016 ESA1 TO CATER FOR BS APPOINTMENT TYPE IN*           
      *                          CREATNG BP13K203                   *           
      * BP137144 05/01/2018 ESA1 TO CATER FOR DI & DN APPMT TYPE    *           
      * BP137208 14/03/2018 FNP1 TO CATER FOR BM APPT TYPE FOR SERS *           
      * =========================================================== *           
                                                                                
       ENVIRONMENT DIVISION.                                                    
                                                                                
       CONFIGURATION SECTION.                                                   
                                                                                
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
       INPUT-OUTPUT SECTION.                                                    
                                                                                
       FILE-CONTROL.                                                            
                                                                                
           SELECT BP13K203 ASSIGN TO BP13K203                                   
                  ACCESS MODE     IS DYNAMIC                                    
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K203-KEY-FLD                               
                  ALTERNATE KEY   IS K203-ALT-KEY                               
                  FILE STATUS     IS BP13K203-STATUS.                           
                                                                                
           SELECT BP13K800 ASSIGN TO BP13K800                                   
                  ACCESS MODE     IS DYNAMIC                                    
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K800-NUM-REGN                              
                  FILE STATUS     IS BP13K800-STATUS.                           
                                                                                
           SELECT BP13K820 ASSIGN TO BP13K820                                   
                  ACCESS MODE     IS DYNAMIC                                    
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K820-KEY-FLD                               
                  FILE STATUS     IS BP13K820-STATUS.                           
                                                                                
           SELECT BP13K813 ASSIGN TO BP13K813                                   
                  ACCESS MODE     IS RANDOM                                     
                  ORGANIZATION    IS INDEXED                                    
                  RECORD KEY      IS K813-KEY-FLD                               
                  FILE STATUS     IS BP13K813-STATUS.                           
                                                                                
           SELECT BP13K200 ASSIGN TO BP13K200                                   
                  ORGANIZATION    IS INDEXED                                    
                  ACCESS MODE     IS RANDOM                                     
                  RECORD KEY      IS K200-KEY-FLD                               
                  ALTERNATE KEY   IS K200-NUM-REGN                              
                  FILE STATUS     IS BP13K200-STATUS.                           
                                                                                
           SELECT BP13F200 ASSIGN TO BP13F200.                                  
                                                                                
                                                                                
       DATA DIVISION.                                                           
                                                                                
       FILE SECTION.                                                            
                                                                                
       FD   BP13K203                                                            
            RECORD CONTAINS  200 CHARACTERS.                                    
       COPY BP13K203.                                                           
                                                                                
       FD   BP13K800                                                            
            RECORD CONTAINS 2000 CHARACTERS.                                    
       COPY BP13K800.                                                           
                                                                                
       FD   BP13K820                                                            
            RECORD CONTAINS  400 CHARACTERS.                                    
       COPY BP13K820.                                                           
                                                                                
       FD   BP13K813                                                            
            RECORD CONTAINS 1000 CHARACTERS.                                    
       COPY BP13K813.                                                           
                                                                                
       FD   BP13K200                                                            
            RECORD     CONTAINS 300 CHARACTERS.                                 
       COPY BP13K200.                                                           
                                                                                
       FD   BP13F200                                                            
            BLOCK CONTAINS     0 RECORDS                                        
            RECORD CONTAINS  300 CHARACTERS                                     
            LABEL RECORD IS STANDARD                                            
            RECORDING MODE IS F.                                                
       COPY BP13F200.                                                           
                                                                                
                                                                                
      *************************                                                 
       WORKING-STORAGE SECTION.                                                 
      *************************                                                 
                                                                                
       01  WS-CURR-DATE           PIC X(08) VALUE ZEROES.                       
       01  WS-K203-ERR-CNT        PIC 9(08) VALUE ZEROES.                       
       01  WS-K203-FND-SW         PIC X     VALUE SPACES.                       
       01  WS-K203-WRITE-CNT      PIC 9(08) VALUE ZEROES.                       
       01  WS-K203-DUPL-REC       PIC 9(08) VALUE ZEROES.                       
       01  WS-K203-WRITE-ERR      PIC 9(08) VALUE ZEROES.                       
       01  WS-K203-READ-ERR       PIC 9(08) VALUE ZEROES.                       
       01  WS-K800-READ-ERR       PIC 9(08) VALUE ZEROES.                       
       01  WS-K800-READ-CNT       PIC 9(08) VALUE ZEROES.                       
       01  WS-K800-FND-SW         PIC X     VALUE SPACES.                       
       01  WS-K820-READ-ERR       PIC 9(08) VALUE ZEROES.                       
       01  WS-K820-READ-CNT       PIC 9(08) VALUE ZEROES.                       
       01  WS-K820-FND-SW         PIC X     VALUE SPACES.                       
       01  WS-K200-READ-ERR       PIC 9(08) VALUE ZEROES.                       
       01  WS-K200-READ-CNT       PIC 9(08) VALUE ZEROES.                       
       01  WS-K200-FND-SW         PIC X     VALUE SPACES.                       
       01  WS-K813-READ-ERR       PIC 9(08) VALUE ZEROES.                       
       01  WS-K813-READ-CNT       PIC 9(08) VALUE ZEROES.                       
       01  WS-F200-READ-CNT       PIC 9(08) VALUE ZEROES.                       
       01  WS-F200-EOF            PIC X     VALUE SPACES.                       
       01  WS-FLAG                PIC X     VALUE SPACES.                       
       01  WS-NUM-QUEUE           PIC X(05) VALUE SPACES.                       
       01  BP13K203-STATUS        PIC 9(02) VALUE ZEROES.                       
       01  BP13K800-STATUS        PIC 9(02) VALUE ZEROES.                       
       01  BP13K820-STATUS        PIC 9(02) VALUE ZEROES.                       
       01  BP13K813-STATUS        PIC 9(02) VALUE ZEROES.                       
       01  BP13K200-STATUS        PIC 9(02) VALUE ZEROES.                       
                                                                                
      ********************                                                      
       PROCEDURE DIVISION.                                                      
      ********************                                                      
                                                                                
      *----------*                                                              
       0000-MAIN.                                                               
      *----------*                                                              
                                                                                
           PERFORM 1000-OPEN-FILES   THRU 1000-EXIT.                            
           PERFORM 2000-READ-F200    THRU 2000-EXIT.                            
           PERFORM 3000-PROCESS-REC  THRU 3000-EXIT                             
                   UNTIL WS-F200-EOF = 'Y'.                                     
           PERFORM 9000-CLOSE-FILES  THRU 9000-EXIT.                            
                                                                                
       0000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------*                                                        
       1000-OPEN-FILES.                                                         
      *----------------*                                                        
                                                                                
           OPEN INPUT  BP13F200                                                 
                       BP13K800                                                 
                       BP13K820                                                 
                       BP13K200                                                 
                       BP13K813                                                 
                I-O    BP13K203.                                                
                                                                                
           IF BP13K203-STATUS NOT = 0 AND 97                                    
              DISPLAY 'ERROR OPENING - BP13K203 : ' BP13K203-STATUS             
              MOVE BP13K203-STATUS TO RETURN-CODE                               
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT                           
           END-IF.                                                              
                                                                                
           IF BP13K800-STATUS NOT = 0 AND 97                                    
              DISPLAY 'ERROR OPENING - BP13K800 : ' BP13K800-STATUS             
              MOVE BP13K800-STATUS TO RETURN-CODE                               
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT                           
           END-IF.                                                              
                                                                                
           IF BP13K820-STATUS NOT = 0 AND 97                                    
              DISPLAY 'ERROR OPENING - BP13K820 : ' BP13K820-STATUS             
              MOVE BP13K820-STATUS TO RETURN-CODE                               
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT                           
           END-IF.                                                              
                                                                                
           IF BP13K813-STATUS NOT = 0 AND 97                                    
              DISPLAY 'ERROR OPENING - BP13K813 : ' BP13K813-STATUS             
              MOVE BP13K813-STATUS TO RETURN-CODE                               
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT                           
           END-IF.                                                              
                                                                                
           IF BP13K200-STATUS NOT = 0 AND 97                                    
              DISPLAY 'ERROR OPENING - BP13K200 : ' BP13K200-STATUS             
              MOVE BP13K200-STATUS TO RETURN-CODE                               
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT                           
           END-IF.                                                              
                                                                                
           ACCEPT WS-CURR-DATE FROM DATE YYYYMMDD.                              
                                                                                
       1000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *---------------*                                                         
       2000-READ-F200.                                                          
      *---------------*                                                         
                                                                                
           READ BP13F200 AT END                                                 
                MOVE HIGH-VALUES TO BP13F200-REC                                
                MOVE 'Y' TO WS-F200-EOF                                         
                GO TO 2000-EXIT.                                                
                                                                                
           ADD 1 TO WS-F200-READ-CNT.                                           
                                                                                
       2000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------*                                                       
       3000-PROCESS-REC.                                                        
      *-----------------*                                                       
                                                                                
           IF F200-NUM-REGN NOT = SPACES AND LOW-VALUES AND ZEROES              
              PERFORM 3100-READ-BP13K800 THRU 3100-EXIT                         
              PERFORM 3600-READ-BP13K200 THRU 3600-EXIT                         
              IF WS-K800-FND-SW = 'Y'                                           
                 PERFORM 3200-READ-BP13K820 THRU 3200-EXIT                      
                 IF K800-DTE-BALLOT >= '201608'                                 
                    PERFORM 3410-MOVE-K203-NEW THRU 3410-EXIT                   
                 ELSE                                                           
                    PERFORM 3400-MOVE-K203     THRU 3400-EXIT                   
                 END-IF                                                         
              END-IF                                                            
           END-IF.                                                              
                                                                                
           PERFORM 2000-READ-F200        THRU 2000-EXIT.                        
                                                                                
       3000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-------------------*                                                     
       3100-READ-BP13K800.                                                      
      *-------------------*                                                     
                                                                                
           MOVE 'N'                TO WS-K800-FND-SW.                           
           MOVE SPACES             TO K800-NUM-REGN.                            
           MOVE F200-NUM-REGN      TO K800-NUM-REGN.                            
           READ BP13K800 KEY IS K800-NUM-REGN.                                  
                                                                                
           IF BP13K800-STATUS = 0                                               
              DISPLAY 'RECORD FOUND ' F200-NUM-REGN                             
              MOVE 'Y' TO WS-K800-FND-SW                                        
              ADD   1  TO WS-K800-READ-CNT                                      
           ELSE                                                                 
           IF BP13K800-STATUS = 23                                              
              DISPLAY 'RECORD NOT FOUND IN BP13K800:' F200-NUM-REGN             
              ADD   1  TO WS-K800-READ-ERR                                      
           ELSE                                                                 
           IF BP13K800-STATUS NOT = 0                                           
              MOVE '4'  TO RETURN-CODE                                          
              DISPLAY  'READ ERROR IN BP13K800 ' F200-NUM-REGN                  
              ADD   1   TO WS-K800-READ-ERR                                     
              GO        TO 9000-CLOSE-FILES.                                    
                                                                                
       3100-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-------------------*                                                     
       3200-READ-BP13K820.                                                      
      *-------------------*                                                     
                                                                                
           MOVE SPACES             TO K820-KEY-FLD.                             
           MOVE K800-NUM-REGN      TO K820-NUM-REGN.                            
           MOVE K800-NUM-NRIC1     TO K820-NUM-NRIC.                            
           READ BP13K820 KEY IS K820-KEY-FLD.                                   
                                                                                
           IF BP13K820-STATUS = 0                                               
              DISPLAY 'RECORD FOUND KEY IS ' K820-KEY-FLD                       
              MOVE 'Y' TO WS-K820-FND-SW                                        
              ADD   1  TO WS-K820-READ-CNT                                      
           ELSE                                                                 
           IF BP13K820-STATUS = 23                                              
              DISPLAY 'RECORD NOT FOUND IN BP13K820:' F200-NUM-REGN             
              ADD   1  TO WS-K820-READ-ERR                                      
           ELSE                                                                 
           IF BP13K820-STATUS NOT = 0                                           
              MOVE '4'  TO RETURN-CODE                                          
              DISPLAY  'READ ERROR IN BP13K820 ' F200-NUM-REGN                  
              ADD   1   TO WS-K820-READ-ERR                                     
              GO        TO 9000-CLOSE-FILES.                                    
                                                                                
       3200-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *---------------*                                                         
       3400-MOVE-K203.                                                          
      *---------------*                                                         
                                                                                
           MOVE SPACES                TO BP13K203-REC.                          
           INITIALIZE                    BP13K203-REC.                          
                                                                                
           IF K200-NUM-PRINT-TAG = 'T'                                          
              MOVE K800-NUM-ALLO-CAT  TO K203-NUM-ALLO-MODE                     
              PERFORM 3450-READ-BP13K813 THRU 3450-EXIT                         
              MOVE K813-CDE-NT             TO K203-NUM-NEW-TOWN                 
              MOVE K800-NUM-FLAT-TYPE      TO K203-NUM-FLAT-TYPE                
      *       MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN                      
      *       MOVE F200-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE                     
      *       IF F200-NUM-NT-ZONE =  '304'                                      
      *          MOVE 'BK'            TO K203-TYPE-APPMT                        
      *       ELSE                                                              
                 MOVE 'BI'            TO K203-TYPE-APPMT                        
      *       END-IF                                                            
           ELSE                                                                 
           IF K800-NUM-ALLO-CAT = 'BTO'                                         
              MOVE K800-NUM-ALLO-CAT       TO K203-NUM-ALLO-MODE                
              PERFORM 3450-READ-BP13K813 THRU 3450-EXIT                         
              MOVE K813-CDE-NT             TO K203-NUM-NEW-TOWN                 
              MOVE K800-NUM-FLAT-TYPE      TO K203-NUM-FLAT-TYPE                
              MOVE 'BK'               TO K203-TYPE-APPMT                        
           ELSE                                                                 
              IF K800-NUM-ALLO-CAT = 'SER' AND                                  
                 F200-NUM-FLAT-TYPE = 'SE'                                      
                MOVE 'SER'              TO K203-NUM-ALLO-MODE                   
                MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN                    
                MOVE K800-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE                   
                MOVE 'BM'               TO K203-TYPE-APPMT                      
              ELSE                                                              
                IF K800-NUM-ALLO-CAT = 'NPL'                                    
                   MOVE 'NPL'              TO K203-NUM-ALLO-MODE                
                   MOVE K800-NUM-NEW-TOWN  TO K203-NUM-NEW-TOWN                 
                   MOVE K800-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE                
                   MOVE 'BL'               TO K203-TYPE-APPMT                   
                ELSE                                                            
                  IF K800-NUM-ALLO-CAT = 'SBF'                                  
                     MOVE 'SBF'              TO K203-NUM-ALLO-MODE              
                     MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN               
                     MOVE K800-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE              
                     MOVE 'BS'               TO K203-TYPE-APPMT                 
                  ELSE                                                          
                     MOVE K800-NUM-ALLO-CAT  TO K203-NUM-ALLO-MODE              
                     MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN               
                     MOVE F200-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE              
                     MOVE 'BK'               TO K203-TYPE-APPMT                 
                  END-IF                                                        
                END-IF                                                          
              END-IF                                                            
           END-IF.                                                              
                                                                                
           MOVE K800-NUM-CAT          TO K203-NUM-ETHNIC.                       
           MOVE F200-NUM-REGN         TO K203-NUM-REGN.                         
           MOVE F200-DTE-BALLOT       TO K203-DTE-BALLOT.                       
           IF   F200-NUM-MGPS-TAG = 'P' OR 'C'                                  
                MOVE K200-DTE-BKAPPMT-DATE-MGPS TO K203-DTE-APPMT               
                MOVE K200-TME-BKAPPMT-MGPS TO K203-TME-APPMT                    
                MOVE F200-NUM-MGPS-QUEUE-SERIAL                                 
                                      TO K203-NUM-QUEUE                         
           ELSE                                                                 
                MOVE K200-DTE-BKAPPMT-DATE TO K203-DTE-APPMT                    
                MOVE K200-TME-BKAPPMT      TO K203-TME-APPMT                    
                MOVE F200-NUM-HHTY-QUEUE-SERIAL                                 
                                      TO K203-NUM-QUEUE                         
           END-IF.                                                              
           MOVE F200-NUM-REF          TO K203-NUM-REF.                          
           MOVE K800-NUM-NRIC1        TO K203-NUM-NRIC.                         
           MOVE K820-NME-OCCP         TO K203-NME-NRIC.                         
           MOVE K820-NUM-HP-PGR       TO K203-NUM-HP.                           
           MOVE 'HA1'                 TO K203-NUM-APLCNT.                       
           MOVE K800-NUM-ZONE         TO K203-NUM-ZONE.                         
                                                                                
           PERFORM 3500-WRITE-BP13K203   THRU 3500-EXIT.                        
                                                                                
       3400-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-------------------*                                                     
       3410-MOVE-K203-NEW.                                                      
      *-------------------*                                                     
                                                                                
           PERFORM 3450-READ-BP13K813 THRU 3450-EXIT.                           
                                                                                
           MOVE SPACES                TO BP13K203-REC.                          
           INITIALIZE                    BP13K203-REC.                          
                                                                                
           IF K800-NUM-ALLO-CAT = 'BTO'                                         
              MOVE K800-NUM-ALLO-CAT       TO K203-NUM-ALLO-MODE                
              MOVE K813-CDE-NT             TO K203-NUM-NEW-TOWN                 
              MOVE K800-NUM-FLAT-TYPE      TO K203-NUM-FLAT-TYPE                
              MOVE 'BI'               TO K203-TYPE-APPMT                        
           ELSE                                                                 
              IF K800-NUM-ALLO-CAT = 'SER' AND                                  
                 F200-NUM-FLAT-TYPE = 'SE'                                      
                MOVE 'SER'              TO K203-NUM-ALLO-MODE                   
                MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN                    
                MOVE K800-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE                   
                MOVE 'BM'               TO K203-TYPE-APPMT                      
              ELSE                                                              
                IF K800-NUM-ALLO-CAT = 'NPL'                                    
                   MOVE 'NPL'              TO K203-NUM-ALLO-MODE                
                   MOVE K800-NUM-NEW-TOWN  TO K203-NUM-NEW-TOWN                 
                   MOVE K800-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE                
                   MOVE 'BL'               TO K203-TYPE-APPMT                   
                ELSE                                                            
                  IF K800-NUM-ALLO-CAT = 'SBF'                                  
                     MOVE 'SBF'              TO K203-NUM-ALLO-MODE              
                     MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN               
                     MOVE K800-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE              
                     MOVE 'BI'               TO K203-TYPE-APPMT                 
                  ELSE                                                          
                     MOVE K800-NUM-ALLO-CAT  TO K203-NUM-ALLO-MODE              
                     MOVE F200-NUM-NT-ZONE   TO K203-NUM-NEW-TOWN               
                     MOVE F200-NUM-FLAT-TYPE TO K203-NUM-FLAT-TYPE              
                     MOVE 'BI'               TO K203-TYPE-APPMT                 
                  END-IF                                                        
                END-IF                                                          
              END-IF                                                            
           END-IF.                                                              
                                                                                
           MOVE K800-NUM-CAT          TO K203-NUM-ETHNIC.                       
           MOVE F200-NUM-REGN         TO K203-NUM-REGN.                         
           MOVE F200-DTE-BALLOT       TO K203-DTE-BALLOT.                       
           IF   F200-NUM-MGPS-TAG = 'P' OR 'C'                                  
                MOVE K200-DTE-BKAPPMT-DATE-MGPS TO K203-DTE-APPMT               
                MOVE K200-TME-BKAPPMT-MGPS TO K203-TME-APPMT                    
                MOVE F200-NUM-MGPS-QUEUE-SERIAL                                 
                                      TO K203-NUM-QUEUE                         
           ELSE                                                                 
                MOVE K200-DTE-BKAPPMT-DATE TO K203-DTE-APPMT                    
                MOVE K200-TME-BKAPPMT      TO K203-TME-APPMT                    
                MOVE F200-NUM-HHTY-QUEUE-SERIAL                                 
                                      TO K203-NUM-QUEUE                         
           END-IF.                                                              
           IF K203-TYPE-APPMT = 'BI'                                            
              MOVE K203-NUM-QUEUE TO WS-NUM-QUEUE                               
              IF WS-NUM-QUEUE(1:1) NOT NUMERIC                                  
                 MOVE ZEROES          TO WS-NUM-QUEUE(1:1)                      
              END-IF                                                            
              IF WS-NUM-QUEUE(2:1) NOT NUMERIC                                  
                 MOVE ZEROES          TO WS-NUM-QUEUE(2:1)                      
              END-IF                                                            
              IF WS-NUM-QUEUE > K813-NUM-QUEUE-MID                              
                 MOVE 'DI'            TO K203-TYPE-APPMT                        
              END-IF                                                            
           END-IF.                                                              
                                                                                
           MOVE F200-NUM-REF          TO K203-NUM-REF.                          
           MOVE K800-NUM-NRIC1        TO K203-NUM-NRIC.                         
           MOVE K820-NME-OCCP         TO K203-NME-NRIC.                         
           MOVE K820-NUM-HP-PGR       TO K203-NUM-HP.                           
           MOVE 'HA1'                 TO K203-NUM-APLCNT.                       
           MOVE K800-NUM-ZONE         TO K203-NUM-ZONE.                         
                                                                                
           PERFORM 3500-WRITE-BP13K203   THRU 3500-EXIT.                        
                                                                                
       3410-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-------------------*                                                     
       3450-READ-BP13K813.                                                      
      *-------------------*                                                     
                                                                                
           MOVE SPACES             TO K813-KEY-FLD.                             
           IF K800-NUM-ALLO-CAT = 'BTO'                                         
             MOVE K800-NUM-BTO-ZONE  TO K813-NUM-ZONE                           
           ELSE                                                                 
             MOVE K800-NUM-NEW-TOWN  TO K813-NUM-ZONE                           
           END-IF.                                                              
                                                                                
           MOVE K800-NUM-FLAT-TYPE TO K813-NUM-FLAT-TYPE.                       
           MOVE K800-DTE-BALLOT    TO K813-DTE-BALLOT.                          
                                                                                
           READ BP13K813 KEY IS K813-KEY-FLD.                                   
                                                                                
           IF BP13K813-STATUS = 0                                               
              DISPLAY 'RECORD FOUND KEY IS ' K813-KEY-FLD                       
              ADD   1  TO WS-K813-READ-CNT                                      
           ELSE                                                                 
           IF BP13K813-STATUS = 23                                              
              DISPLAY 'RECORD NOT FOUND IN BP13K813:' F200-NUM-REGN             
              ADD   1     TO WS-K813-READ-ERR                                   
              MOVE SPACES TO K813-CDE-NT                                        
                             K813-NUM-FLAT-TYPE                                 
           ELSE                                                                 
           IF BP13K813-STATUS NOT = 0                                           
              MOVE '4'  TO RETURN-CODE                                          
              DISPLAY  'READ ERROR IN BP13K813 ' F200-NUM-REGN                  
              ADD   1   TO WS-K813-READ-ERR                                     
              GO        TO 9000-CLOSE-FILES.                                    
                                                                                
       3450-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *--------------------*                                                    
       3500-WRITE-BP13K203.                                                     
      *--------------------*                                                    
                                                                                
           WRITE BP13K203-REC.                                                  
                                                                                
           IF BP13K203-STATUS = 0                                               
              ADD   1  TO WS-K203-WRITE-CNT                                     
              IF ((K203-TYPE-APPMT = 'BK' OR 'BI' OR 'BL' OR 'BS' OR            
                                     'DI' OR 'BM') AND                          
                 (K820-NUM-HP-PGR  NOT = SPACES AND LOW-VALUES) AND             
                 (K820-NUM-HP-PGR IS NUMERIC))                                  
                 IF K203-TYPE-APPMT = 'DI'                                      
                    MOVE 'DN'     TO  K203-TYPE-APPMT                           
                 ELSE                                                           
                    MOVE 'BN'     TO  K203-TYPE-APPMT                           
                 END-IF                                                         
                 MOVE 'P'      TO  K203-NUM-STATUS                              
                 PERFORM 3700-READ-BP13K203  THRU 3700-EXIT                     
                 IF WS-K203-FND-SW = 'Y'                                        
                    GO TO 3500-EXIT                                             
                 ELSE                                                           
                    PERFORM 3510-WRITE-BP13K203 THRU 3510-EXIT                  
                 END-IF                                                         
              END-IF                                                            
           ELSE                                                                 
           IF BP13K203-STATUS = 2 OR 22                                         
              IF BP13K203-STATUS = 22                                           
                 WRITE BP13K203-REC                                             
                 ADD   1  TO WS-K203-WRITE-CNT                                  
                 IF ((K203-TYPE-APPMT = 'BK' OR 'BI' OR 'BL' OR 'BS' OR         
                                        'DI' OR 'BM') AND                       
                    (K820-NUM-HP-PGR  NOT = SPACES AND LOW-VALUES) AND          
                    (K820-NUM-HP-PGR IS NUMERIC))                               
                    IF K203-TYPE-APPMT = 'DI'                                   
                       MOVE 'DN'     TO  K203-TYPE-APPMT                        
                    ELSE                                                        
                       MOVE 'BN'     TO  K203-TYPE-APPMT                        
                    END-IF                                                      
                    MOVE 'P'      TO  K203-NUM-STATUS                           
                    PERFORM 3700-READ-BP13K203  THRU 3700-EXIT                  
                    IF WS-K203-FND-SW = 'Y'                                     
                       GO TO 3500-EXIT                                          
                    ELSE                                                        
                       PERFORM 3510-WRITE-BP13K203 THRU 3510-EXIT               
                    END-IF                                                      
                 END-IF                                                         
              END-IF                                                            
              ADD   1  TO WS-K203-DUPL-REC                                      
              DISPLAY 'DUPLICATE RECORD IN BP13K203:'                           
              DISPLAY ' KEY     : ' K203-KEY-FLD                                
              DISPLAY ' ALT KEY : ' K203-ALT-KEY                                
           ELSE                                                                 
           IF BP13K203-STATUS NOT = 0                                           
              MOVE '4'  TO RETURN-CODE                                          
              DISPLAY 'WRITE ERROR, STATUS : ' BP13K203-STATUS                  
              DISPLAY ' KEY     : ' K203-KEY-FLD                                
              DISPLAY ' ALT KEY : ' K203-ALT-KEY                                
              ADD   1   TO WS-K203-WRITE-ERR                                    
              GO        TO 9000-CLOSE-FILES.                                    
                                                                                
       3500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *--------------------*                                                    
       3510-WRITE-BP13K203.                                                     
      *--------------------*                                                    
                                                                                
           WRITE BP13K203-REC.                                                  
                                                                                
           IF BP13K203-STATUS = 0                                               
              ADD   1  TO WS-K203-WRITE-CNT                                     
           ELSE                                                                 
           IF BP13K203-STATUS = 2 OR 22                                         
              ADD   1  TO WS-K203-DUPL-REC                                      
              CONTINUE                                                          
           ELSE                                                                 
           IF BP13K203-STATUS NOT = 0                                           
              MOVE '4'  TO RETURN-CODE                                          
              DISPLAY 'WRITE ERROR, STATUS : ' BP13K203-STATUS                  
              DISPLAY ' KEY     : ' K203-KEY-FLD                                
              DISPLAY ' ALT KEY : ' K203-ALT-KEY                                
              ADD   1   TO WS-K203-WRITE-ERR                                    
              GO        TO 9000-CLOSE-FILES.                                    
                                                                                
       3510-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-------------------*                                                     
       3600-READ-BP13K200.                                                      
      *-------------------*                                                     
                                                                                
           MOVE SPACES             TO BP13K200-REC.                             
           INITIALIZE                 BP13K200-REC.                             
           MOVE F200-NUM-REGN      TO K200-NUM-REGN.                            
           READ BP13K200 KEY IS K200-NUM-REGN.                                  
                                                                                
           IF BP13K200-STATUS = 0                                               
              MOVE 'Y' TO WS-K200-FND-SW                                        
              ADD   1  TO WS-K200-READ-CNT                                      
           ELSE                                                                 
           IF BP13K200-STATUS = 23                                              
              DISPLAY 'RECORD NOT FOUND IN BP13K200:' F200-NUM-REGN             
              ADD   1  TO WS-K200-READ-ERR                                      
           ELSE                                                                 
           IF BP13K200-STATUS NOT = 0                                           
              MOVE '4'  TO RETURN-CODE                                          
              DISPLAY  'READ ERROR IN BP13K200 ' F200-NUM-REGN                  
              ADD   1   TO WS-K200-READ-ERR                                     
              GO        TO 9000-CLOSE-FILES.                                    
                                                                                
       3600-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *--------------------*                                                    
       3700-READ-BP13K203.                                                      
      *--------------------*                                                    
                                                                                
           MOVE 'N'    TO WS-K203-FND-SW.                                       
                                                                                
           READ BP13K203.                                                       
                                                                                
           EVALUATE BP13K203-STATUS                                             
              WHEN 00                                                           
                MOVE 'Y'    TO WS-K203-FND-SW                                   
              WHEN 23                                                           
                CONTINUE                                                        
              WHEN OTHER                                                        
                MOVE '4'  TO RETURN-CODE                                        
                DISPLAY 'BP13K203 READ ERROR STATUS : ' BP13K203-STATUS         
                DISPLAY ' KEY     : ' K203-KEY-FLD                              
                DISPLAY ' ALT KEY : ' K203-ALT-KEY                              
                ADD   1   TO WS-K203-READ-ERR                                   
                GO        TO 9000-CLOSE-FILES.                                  
                                                                                
       3700-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------*                                                       
       9000-CLOSE-FILES.                                                        
      *-----------------*                                                       
                                                                                
           DISPLAY '******  BP13CB07  *************'.                           
           DISPLAY 'RECS READ FROM  BP13F200    : ' WS-F200-READ-CNT.           
           DISPLAY '                              '.                            
           DISPLAY 'RECS WRITTEN  IN BP13K203   : ' WS-K203-WRITE-CNT.          
           DISPLAY 'RECS ERROR WRITE BP13K203   : ' WS-K203-WRITE-ERR.          
           DISPLAY 'RECS FOUND    IN BP13K203   : ' WS-K203-DUPL-REC.           
           DISPLAY '                              '.                            
           DISPLAY 'RECS READ   FROM BP13K800   : ' WS-K800-READ-CNT.           
           DISPLAY 'RECS NOTFND   IN BP13K800   : ' WS-K800-READ-ERR.           
           DISPLAY '                              '.                            
           DISPLAY 'RECS READ   FROM BP13K820   : ' WS-K820-READ-CNT.           
           DISPLAY 'RECS NOTFND   IN BP13K820   : ' WS-K820-READ-ERR.           
           DISPLAY '                              '.                            
           DISPLAY 'RECS READ   FROM BP13K813   : ' WS-K813-READ-CNT.           
           DISPLAY 'RECS NOTFND   IN BP13K813   : ' WS-K813-READ-ERR.           
           DISPLAY '                              '.                            
           DISPLAY 'RECS READ   FROM BP13K200   : ' WS-K200-READ-CNT.           
           DISPLAY 'RECS NOTFND   IN BP13K200   : ' WS-K200-READ-ERR.           
                                                                                
           CLOSE BP13K203                                                       
                 BP13K800                                                       
                 BP13K820                                                       
                 BP13K813                                                       
                 BP13F200.                                                      
                                                                                
           IF BP13K203-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K203-STATUS ' BP13K203-STATUS          
            MOVE BP13K203-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K800-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K800-STATUS ' BP13K800-STATUS          
            MOVE BP13K800-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K820-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K820-STATUS ' BP13K820-STATUS          
            MOVE BP13K800-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K813-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K813-STATUS ' BP13K813-STATUS          
            MOVE BP13K813-STATUS TO RETURN-CODE.                                
                                                                                
           STOP RUN.                                                            
                                                                                
       9000-EXIT.                                                               
            EXIT.                                                               
