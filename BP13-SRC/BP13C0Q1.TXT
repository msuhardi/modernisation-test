      *----------------------------------------------------------------*        
       IDENTIFICATION DIVISION.                                                 
      *----------------------------------------------------------------*        
       PROGRAM-ID.    BP13C0Q1.                                                 
       AUTHOR.        ALWYN BENNY.                                              
       DATE-WRITTEN.  09/02/2012.                                               
                                                                                
      ******************************************************************        
      *                                                                *        
      *   SYSTEM NAME :  SYSTEM OF COMMITMENT  (SOC)                   *        
      *                                                                *        
      *   SYSTEM ID   :  BP13                                          *        
      *                                                                *        
      *   OBJECTIVE   :  UPDATE LAST QUEUE NUMBER & LAST QUEUE DATE    *        
      *                  TO BP13Q60  FROM BP13F200.                   *         
      *                                                                *        
      *   INPUT FILES :  1.  BP13F200  -                               *        
      *                                                                *        
      *   OUPUT FILES :  1.  BP13KQ60 -BP13.KQ60.LAST.QUEUE            *        
      *----------------------------------------------------------------*        
      *                                                                *        
      *   CHGE-NO   BY    DATE      DESCRIPTION                        *        
      *   --------  ---  ---------- -----------                        *        
      *   BP134424  AB9  09/02/2012 NEW PGM                            *        
      *   BP134424  AB9  13/02/2012 ADD READING OF BP13K813 TO GET     *        
      *                  FLAT TYPE FOR BTO ZONE.                       *        
      *   BP135190  SMR2 04/12/2013 EXPAND BP13K813 TO 1000            *        
      *   BP135898  KAM4 06/08/2015 CATER FOR REWRITE TO FIX THE UNUPDTD        
      *                             QUEUE NO. DUE TO DUPKEY ERROR. ALSO*        
      *                             ADDED BP13F205 TO CHECK FOR RANGE. *        
      *   BP135869  KAM4 11/08/2015 CATER TO MATCH F205 TO F200 FOR -  *        
      *                             POSSIBLE MULTIPLE RECORDS IN F205. *        
      ******************************************************************        
                                                                                
      *----------------------------------------------------------------*        
       ENVIRONMENT DIVISION.                                                    
      *----------------------------------------------------------------*        
                                                                                
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
                                                                                
           SELECT BP13F205  ASSIGN        TO BP13F205.                          
                                                                                
           SELECT BP13K813  ASSIGN        TO BP13K813                           
                            ORGANIZATION  IS INDEXED                            
                            ACCESS MODE   IS DYNAMIC                            
                            RECORD KEY    IS K813-KEY-FLD                       
                            FILE STATUS   IS WS-K813-STATUS.                    
                                                                                
           SELECT BP13KQ60 ASSIGN         TO BP13KQ60                           
                           ACCESS MODE    IS RANDOM                             
                           ORGANIZATION   IS INDEXED                            
                           RECORD KEY     IS KQ60-KEY-FLD                       
                           FILE STATUS    IS WS-KQ60-STATUS.                    
                                                                                
           SELECT BP13F200  ASSIGN        TO BP13F200.                          
                                                                                
      *----------------------------------------------------------------*        
       DATA DIVISION.                                                           
      *----------------------------------------------------------------*        
                                                                                
       FILE SECTION.                                                            
                                                                                
       FD   BP13F205                                                            
            BLOCK CONTAINS  0   RECORDS                                         
            LABEL RECORDS   ARE STANDARD                                        
            RECORDING MODE  IS  F                                               
            RECORD CONTAINS 80  CHARACTERS.                                     
       COPY BP13F205.                                                           
                                                                                
       FD  BP13F200                                                             
           BLOCK CONTAINS 0 RECORDS                                             
           RECORD CONTAINS 300 CHARACTERS                                       
           RECORDING MODE F                                                     
           LABEL RECORDS ARE STANDARD.                                          
       COPY BP13F200.                                                           
                                                                                
       FD  BP13KQ60                                                             
           RECORD CONTAINS 100 CHARACTERS.                                      
       COPY BP13KQ60.                                                           
                                                                                
       FD   BP13K813                                                            
            RECORD CONTAINS 1000 CHARACTERS.                                    
       COPY BP13K813.                                                           
                                                                                
                                                                                
      *----------------------------------------------------------------*        
       WORKING-STORAGE SECTION.                                                 
      *----------------------------------------------------------------*        
                                                                                
       01  WS-COUNTERS.                                                         
           05 WS-CNT-F200-READ        PIC 9(8)  VALUE 0.                        
           05 WS-CNT-KQ60-WRITE       PIC 9(8)  VALUE 0.                        
           05 WS-CNT-KQ60-REWRITE     PIC 9(8)  VALUE 0.                        
           05 WS-CNT                  PIC 9(8)  VALUE 0.                        
           05 WS-F205-CNT             PIC 9(8)  VALUE 0.                        
                                                                                
       01  WS-SWITCHES.                                                         
           05 WS-F200-EOF             PIC X(1)  VALUE 'N'.                      
           05 WS-F001-EOF             PIC X(1)  VALUE 'N'.                      
               88 EOF-F001                      VALUE 'Y'.                      
           05 WS-F205-EOF             PIC X(01) VALUE 'N'.                      
                                                                                
       01  WS-FILE-STATUS.                                                      
           05 WS-KQ60-STATUS          PIC 9(02) VALUE ZEROS.                    
           05 WS-K813-STATUS          PIC 9(02) VALUE ZEROS.                    
                                                                                
       01  WS-F200-DATE.                                                        
           05  WS-COMP-DATE           PIC X(8).                                 
           05  WS-COMP-DATE-NUM REDEFINES WS-COMP-DATE PIC 9(8).                
                                                                                
       01  WS-DATE1                   PIC 9(8)   VALUE ZEROS.                   
       01  WS-CURR-DATE               PIC 9(8)  VALUE ZEROES.                   
       01  WS-EDITED-DATE.                                                      
           05  WS-DD-X                PIC X(2).                                 
           05  FILLER                 PIC X.                                    
           05  WS-MM-X                PIC X(2).                                 
           05  FILLER                 PIC X.                                    
           05  WS-CCYY-X              PIC X(4).                                 
                                                                                
       01  WS-START-DTE.                                                        
           05  WS-START-CY                    PIC 9(4).                         
           05  WS-START-MM                    PIC 9(2).                         
           05  WS-START-DD                    PIC 9(2).                         
       01  WS-START-DTE-9 REDEFINES                                             
                         WS-START-DTE       PIC 9(8).                           
                                                                                
       01  WS-END-DTE.                                                          
           05  WS-END-CY                    PIC 9(4).                           
           05  WS-END-MM                    PIC 9(2).                           
           05  WS-END-DD                    PIC 9(2).                           
       01  WS-END-DTE-9 REDEFINES                                               
                         WS-END-DTE       PIC 9(8).                             
                                                                                
       01  WS-NEXT-DTE.                                                         
           05  WS-NEXT-CY                    PIC 9(4).                          
           05  WS-NEXT-MM                    PIC 9(2).                          
           05  WS-NEXT-DD                    PIC 9(2).                          
       01  WS-NEXT-DTE-9 REDEFINES                                              
                         WS-NEXT-DTE       PIC 9(8).                            
       01  WS-LEAP-YR                      PIC 9(4).                            
       01  WS-FUNC-START-DTE                PIC S9(9).                          
       01  WS-FUNC-END-DTE                  PIC S9(9).                          
       01  WS-DATE-DIFF                     PIC 9(9).                           
                                                                                
       01  WS-CURRENT-DATE.                                                     
           05  WS-DATE              PIC X(8).                                   
           05  WS-CURRENT-TIME      PIC X(9).                                   
           05  FILLER               PIC X(4).                                   
                                                                                
       01  WS-CURR-TIME.                                                        
           05  WS-CURR-TIME1        PIC X(9).                                   
           05  WS-TIME REDEFINES WS-CURR-TIME1.                                 
              10  WS-HH             PIC 9(2).                                   
              10  WS-MM             PIC 9(2).                                   
              10  WS-SS             PIC 9(2).                                   
              10  WS-MS             PIC 9(2).                                   
              10  WS-GM             PIC 9(1).                                   
       01  WS-GM-CNT                PIC S9(8) COMP VALUE ZEROS.                 
                                                                                
       01  WS-LAST-KEY.                                                         
           05  WS-F200-DTE-BKAPPMT     PIC X(8).                                
           05  WS-SUB-KEY.                                                      
               10  WS-F200-CDE-PROJECT     PIC X(3).                            
               10  WS-F200-NUM-NT-ZONE     PIC X(3).                            
               10  WS-F200-NUM-FLAT-TYPE   PIC X(2).                            
                                                                                
       01  WS-CURR-KEY.                                                         
           05  WS-CURR-F200-DTE-BKAPPMT     PIC X(8).                           
           05  WS-CURR-SUB-KEY.                                                 
               10  WS-CURR-F200-CDE-PROJECT     PIC X(3).                       
               10  WS-CURR-F200-NUM-NT-ZONE     PIC X(3).                       
               10  WS-CURR-F200-NUM-FLAT-TYPE   PIC X(2).                       
                                                                                
       01  WS-PREV-KEY.                                                         
           05  WS-PREV-F200-DTE-BKAPPMT     PIC X(8).                           
           05  WS-PREV-SUB-KEY.                                                 
               10  WS-PREV-F200-CDE-PROJECT     PIC X(3).                       
               10  WS-PREV-F200-NUM-NT-ZONE     PIC X(3).                       
               10  WS-PREV-F200-NUM-FLAT-TYPE   PIC X(2).                       
                                                                                
       01  WS-MATCH-KEYS.                                                       
           05 WS-F205-MATCH-KEY.                                                
              10 WS-F205-MATCH-NT-ZONE    PIC X(03).                            
              10 WS-F205-MATCH-FLAT-TYPE  PIC X(02).                            
              10 WS-F205-MATCH-DTE-BALLOT PIC X(06).                            
           05 WS-F200-MATCH-KEY.                                                
              10 WS-F200-MATCH-NT-ZONE    PIC X(03).                            
              10 WS-F200-MATCH-FLAT-TYPE  PIC X(02).                            
              10 WS-F200-MATCH-DTE-BALLOT PIC X(06).                            
                                                                                
       01  WS-OTHER-VAR.                                                        
           05  WS-NUM-QUEUE-BIG        PIC X(5)  VALUE SPACES.                  
           05  WS-NUM-QUEUE-TEMP       PIC X(5)  VALUE SPACES.                  
           05  WS-UPDATE-TAG           PIC X(1)  VALUE 'N'.                     
           05  WS-NUM-LAST-QUEUE       PIC X(5)  VALUE SPACES.                  
           05  WS-REMAINDER            PIC 9     VALUE ZERO.                    
           05  WS-QUOTIENT             PIC 99    VALUE ZEROS.                   
           05  WS-BP13KQ60-REC         PIC X(100) VALUE SPACES.                 
           05  WS-KQ60-KEY-FLD         PIC X(22) VALUE SPACES.                  
                                                                                
       01  WS-DATE-VALUES.                                                      
           05  WS-CUR-DATE                PIC X(8).                             
           05  WS-CUR-DATE-NUM REDEFINES WS-CUR-DATE                            
                                          PIC 9(8).                             
       01  WS-KQ60-KEY.                                                         
           05  WS-NUM-SALE-MODE        PIC X(3)  VALUE SPACES.                  
           05  WS-NUM-ZONE             PIC X(3)  VALUE SPACES.                  
           05  WS-NUM-FLAT-TYPE        PIC X(2)  VALUE SPACES.                  
           05  WS-DTE-BALLOT           PIC X(6)  VALUE SPACES.                  
           05  WS-DTE-BKAPPMT          PIC X(8)  VALUE SPACES.                  
                                                                                
      *----------------------------------------------------------------*        
       PROCEDURE DIVISION.                                                      
      *----------------------------------------------------------------*        
                                                                                
      *----------------------------------------------------------------*        
       0000-MAIN-ROUTINE.                                                       
      *----------------------------------------------------------------*        
                                                                                
           PERFORM  1000-OPEN-FILES      THRU    1000-EXIT.                     
           PERFORM  1500-READ-BP13F205   THRU    1500-EXIT.                     
           PERFORM  2000-READ-BP13F200   THRU    2000-EXIT.                     
           PERFORM  3000-PROCESS         THRU    3000-EXIT                      
                     UNTIL WS-F200-EOF = 'Y' OR                                 
                           WS-F205-EOF = 'Y'.                                   
           PERFORM  9000-CLOSE-ROUTINE   THRU    9000-EXIT.                     
                                                                                
       0000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       1000-OPEN-FILES.                                                         
      *----------------------------------------------------------------*        
                                                                                
           OPEN INPUT  BP13F200                                                 
                       BP13F205                                                 
                       BP13K813                                                 
                I-O    BP13KQ60.                                                
                                                                                
           MOVE FUNCTION CURRENT-DATE(1:8) TO WS-CURR-DATE.                     
           STRING WS-CURR-DATE(7:2) '-' WS-CURR-DATE(5:2) '-'                   
                  WS-CURR-DATE(1:4) DELIMITED BY SIZE INTO                      
                               WS-EDITED-DATE.                                  
                                                                                
           IF WS-K813-STATUS NOT = 00 AND 97                                    
              DISPLAY 'OPENING ERROR BP13K813. STATUS : ' WS-K813-STATUS        
              MOVE WS-K813-STATUS       TO   RETURN-CODE                        
              PERFORM 9000-CLOSE-ROUTINE     THRU 9000-EXIT                     
           END-IF.                                                              
                                                                                
           IF WS-KQ60-STATUS NOT = 00 AND 97                                    
              DISPLAY 'OPENING ERROR BP13KQ60. STATUS : ' WS-KQ60-STATUS        
              MOVE WS-KQ60-STATUS       TO   RETURN-CODE                        
              PERFORM 9000-CLOSE-ROUTINE     THRU 9000-EXIT                     
           END-IF.                                                              
                                                                                
       1000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       1500-READ-BP13F205.                                                      
      *----------------------------------------------------------------*        
           READ BP13F205                                                        
              AT END MOVE 'Y'       TO  WS-F205-EOF                             
                 DISPLAY ' '                                                    
                 DISPLAY 'BP13F205 REACH EOF...'                                
                 DISPLAY ' '                                                    
              END-READ.                                                         
                                                                                
           INSPECT F205-START-QUEUE CONVERTING                                  
                                 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" TO ZEROS.         
           INSPECT F205-END-QUEUE CONVERTING                                    
                                 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" TO ZEROS.         
                                                                                
           MOVE SPACES              TO WS-F205-MATCH-KEY.                       
           MOVE F205-NUM-NT-ZONE    TO WS-F205-MATCH-NT-ZONE.                   
           MOVE F205-NUM-FLAT-TYPE  TO WS-F205-MATCH-FLAT-TYPE.                 
           MOVE F205-DTE-BALLOT     TO WS-F205-MATCH-DTE-BALLOT.                
           ADD 1                    TO WS-F205-CNT.                             
                                                                                
       1500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       2000-READ-BP13F200.                                                      
      *----------------------------------------------------------------*        
                                                                                
           READ BP13F200                                                        
                AT END                                                          
                   MOVE 'Y' TO WS-F200-EOF                                      
                NOT AT END                                                      
                   ADD 1 TO WS-CNT-F200-READ                                    
           END-READ.                                                            
                                                                                
           MOVE  F200-CDE-PROJECT      TO WS-CURR-F200-CDE-PROJECT.             
           MOVE  F200-DTE-BKAPPMT-DATE TO WS-CURR-F200-DTE-BKAPPMT              
                                          WS-CUR-DATE.                          
           MOVE  F200-NUM-NT-ZONE      TO WS-CURR-F200-NUM-NT-ZONE.             
           MOVE  F200-NUM-FLAT-TYPE    TO WS-CURR-F200-NUM-FLAT-TYPE.           
           INSPECT F200-NUM-HHTY-QUEUE-SERIAL CONVERTING                        
                                 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" TO ZEROS.         
           IF WS-NUM-QUEUE-BIG         = SPACES OR LOW-VALUES                   
              MOVE  F200-NUM-HHTY-QUEUE-SERIAL TO WS-NUM-QUEUE-BIG              
                                                  WS-NUM-QUEUE-TEMP             
           END-IF.                                                              
                                                                                
           IF WS-LAST-KEY     = SPACES OR LOW-VALUES                            
              MOVE  F200-CDE-PROJECT      TO WS-F200-CDE-PROJECT                
              MOVE  F200-DTE-BKAPPMT-DATE TO WS-F200-DTE-BKAPPMT                
              MOVE  F200-NUM-NT-ZONE      TO WS-F200-NUM-NT-ZONE                
              MOVE  F200-NUM-FLAT-TYPE    TO WS-F200-NUM-FLAT-TYPE              
           END-IF.                                                              
                                                                                
      *MOVE MATCHING KEY WITH F205                                              
           MOVE SPACES                    TO WS-F200-MATCH-KEY.                 
           MOVE F200-NUM-NT-ZONE          TO WS-F200-MATCH-NT-ZONE.             
           MOVE F200-NUM-FLAT-TYPE        TO WS-F200-MATCH-FLAT-TYPE.           
           MOVE F200-DTE-BALLOT           TO WS-F200-MATCH-DTE-BALLOT.          
                                                                                
       2000-EXIT.                                                               
           EXIT.                                                                
      *----------------------------------------------------------------*        
       3000-PROCESS.                                                            
      *----------------------------------------------------------------*        
           IF WS-F200-MATCH-KEY = WS-F205-MATCH-KEY                             
              IF (F200-NUM-HHTY-QUEUE-SERIAL < F205-START-QUEUE) OR             
                 (F200-NUM-HHTY-QUEUE-SERIAL > F205-END-QUEUE)                  
                  PERFORM 2000-READ-BP13F200 THRU 2000-EXIT                     
                  GO TO 3000-EXIT                                               
              END-IF                                                            
           ELSE                                                                 
             IF WS-F205-MATCH-KEY > WS-F200-MATCH-KEY                           
                PERFORM 2000-READ-BP13F200 THRU 2000-EXIT                       
             ELSE                                                               
                PERFORM 1500-READ-BP13F205 THRU 1500-EXIT                       
             END-IF                                                             
           END-IF.                                                              
                                                                                
           MOVE  0       TO WS-CNT.                                             
                                                                                
           PERFORM UNTIL WS-CURR-KEY      NOT = WS-LAST-KEY                     
                   OR WS-F200-EOF = 'Y'                                         
                ADD  1 TO WS-CNT                                                
                IF F200-NUM-HHTY-QUEUE-SERIAL >= WS-NUM-QUEUE-BIG               
                  MOVE F200-NUM-HHTY-QUEUE-SERIAL TO WS-NUM-QUEUE-BIG           
                  MOVE F200-CDE-PROJECT        TO  WS-NUM-SALE-MODE             
                                WS-PREV-F200-CDE-PROJECT                        
                  MOVE F200-NUM-NT-ZONE        TO  WS-NUM-ZONE                  
                                WS-PREV-F200-NUM-NT-ZONE                        
                  MOVE F200-DTE-BALLOT         TO  WS-DTE-BALLOT                
                  MOVE F200-DTE-BKAPPMT-DATE   TO  WS-DTE-BKAPPMT               
                       WS-PREV-F200-DTE-BKAPPMT                                 
                  MOVE F200-NUM-FLAT-TYPE      TO  WS-NUM-FLAT-TYPE             
                          WS-PREV-F200-NUM-FLAT-TYPE                            
                END-IF                                                          
                                                                                
                PERFORM 2000-READ-BP13F200 THRU 2000-EXIT                       
            END-PERFORM.                                                        
                                                                                
            PERFORM 3999-READ-BP13KQ60    THRU 3999-EXIT                        
                                                                                
            MOVE WS-CURR-KEY              TO WS-LAST-KEY.                       
            MOVE WS-NUM-QUEUE-BIG         TO WS-NUM-QUEUE-TEMP.                 
            MOVE ZEROS                    TO WS-NUM-QUEUE-BIG.                  
                                                                                
            IF WS-CURR-SUB-KEY = WS-PREV-SUB-KEY                                
               PERFORM 3500-CHK-DATE-DIFF   THRU 3500-EXIT                      
               MOVE ZEROS                   TO WS-NUM-QUEUE-BIG                 
               MOVE ZEROS                   TO WS-DTE-BKAPPMT                   
            END-IF.                                                             
                                                                                
       3000-EXIT.                                                               
           EXIT.                                                                
                                                                                
                                                                                
      *----------------------------------------------------------------*        
       3250-GET-FLAT-TYPE.                                                      
      *----------------------------------------------------------------*        
                                                                                
           MOVE SPACES                         TO BP13K813-REC.                 
           INITIALIZE                             BP13K813-REC.                 
                                                                                
           MOVE SPACES                         TO K813-KEY-FLD.                 
           MOVE WS-NUM-ZONE                    TO K813-NUM-ZONE.                
                                                                                
           PERFORM 3300-START-BP13K813       THRU 3300-EXIT                     
                                                                                
           IF K813-NUM-FLAT-TYPE = ZEROS OR SPACES OR LOW-VALUES                
              MOVE ZEROS                       TO WS-NUM-FLAT-TYPE              
           END-IF.                                                              
                                                                                
                                                                                
       3250-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3300-START-BP13K813.                                                     
      *----------------------------------------------------------------*        
                                                                                
           START BP13K813 KEY >= K813-KEY-FLD.                                  
                                                                                
           EVALUATE WS-K813-STATUS                                              
               WHEN 00                                                          
               WHEN 02                                                          
                    PERFORM 3310-READ-BP13K813  THRU 3310-EXIT                  
               WHEN 23                                                          
                    DISPLAY 'RECORD NOT FOUND-K813: '   WS-K813-STATUS          
                            ' KEY = ' K813-KEY-FLD                              
               WHEN OTHER                                                       
                    DISPLAY 'ERROR STARTING BP13K813: ' WS-K813-STATUS          
                            ' KEY = ' K813-KEY-FLD                              
                    PERFORM  9000-CLOSE-ROUTINE THRU 9000-EXIT                  
           END-EVALUATE.                                                        
                                                                                
                                                                                
       3300-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3310-READ-BP13K813.                                                      
      *----------------------------------------------------------------*        
                                                                                
            READ  BP13K813 NEXT AT END                                          
                  MOVE SPACES               TO K813-KEY-FLD.                    
                                                                                
            EVALUATE WS-K813-STATUS                                             
                WHEN 00                                                         
                WHEN 02                                                         
                     IF (K813-NUM-ZONE = WS-NUM-ZONE      AND                   
                         K813-DTE-BALLOT = WS-DTE-BALLOT        )               
                        MOVE K813-NUM-FLAT-TYPE TO WS-NUM-FLAT-TYPE             
                     END-IF                                                     
                WHEN 23                                                         
                    DISPLAY 'FLAT TYPE NOT AVAILABLE: ' WS-K813-STATUS          
                            ' KEY = ' K813-KEY-FLD                              
                WHEN OTHER                                                      
                     DISPLAY 'ERROR READING BP13K813 : ' WS-K813-STATUS         
                             ' KEY = ' K813-KEY-FLD                             
                     PERFORM  9000-CLOSE-ROUTINE  THRU 9000-EXIT                
            END-EVALUATE.                                                       
                                                                                
                                                                                
       3310-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3500-CHK-DATE-DIFF.                                                      
      *----------------------------------------------------------------*        
                                                                                
            MOVE WS-PREV-F200-DTE-BKAPPMT TO WS-START-DTE.                      
            MOVE WS-CURR-F200-DTE-BKAPPMT TO WS-END-DTE.                        
                                                                                
            COMPUTE  WS-FUNC-START-DTE =                                        
                     FUNCTION INTEGER-OF-DATE(WS-START-DTE-9).                  
            COMPUTE  WS-FUNC-END-DTE =                                          
                     FUNCTION INTEGER-OF-DATE(WS-END-DTE-9).                    
                                                                                
            COMPUTE WS-DATE-DIFF = WS-FUNC-END-DTE - WS-FUNC-START-DTE.         
                                                                                
            MOVE    ZEROS                    TO WS-NEXT-DTE.                    
                                                                                
            IF WS-DATE-DIFF > 1                                                 
              PERFORM UNTIL  WS-NEXT-DTE = WS-END-DTE                           
                 PERFORM 3600-GET-NEXT-DATE   THRU  3600-EXIT                   
                 MOVE    WS-NEXT-DTE         TO  WS-DTE-BKAPPMT                 
                 IF WS-NEXT-DTE NOT = WS-END-DTE                                
                    PERFORM 3999-READ-BP13KQ60   THRU  3999-EXIT                
                 END-IF                                                         
              END-PERFORM                                                       
            END-IF.                                                             
                                                                                
       3500-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3600-GET-NEXT-DATE.                                                      
      *----------------------------------------------------------------*        
                                                                                
            IF WS-NEXT-DTE = ZEROS OR SPACES OR LOW-VALUES                      
               MOVE   WS-START-DTE          TO   WS-NEXT-DTE                    
            END-IF.                                                             
            MOVE WS-NEXT-DTE-9(1:4)         TO   WS-LEAP-YR.                    
            EVALUATE WS-NEXT-MM                                                 
               WHEN 01                                                          
               WHEN 03                                                          
               WHEN 05                                                          
               WHEN 07                                                          
               WHEN 08                                                          
               WHEN 10                                                          
               WHEN 12                                                          
                      PERFORM 3610-CHK-DAY  THRU  3610-EXIT                     
                                                                                
               WHEN 02                                                          
                      PERFORM 3620-CHK-DAY  THRU  3620-EXIT                     
               WHEN 04                                                          
               WHEN 06                                                          
               WHEN 09                                                          
               WHEN 11                                                          
                     PERFORM  3630-CHK-DAY  THRU  3630-EXIT                     
               END-EVALUATE.                                                    
                                                                                
       3600-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       3610-CHK-DAY.                                                            
      *----------------------------------------------------------------*        
                                                                                
                                                                                
            IF WS-NEXT-DD  < 31                                                 
               ADD 1       TO WS-NEXT-DD                                        
            ELSE                                                                
               IF  WS-NEXT-DD  = 31                                             
                   MOVE        01           TO WS-NEXT-DD                       
                   IF WS-NEXT-MM  = 12                                          
                      MOVE 01               TO WS-NEXT-MM                       
                      ADD      1            TO WS-NEXT-CY                       
                   ELSE                                                         
                      ADD      1            TO WS-NEXT-MM                       
                   END-IF                                                       
               END-IF                                                           
            END-IF.                                                             
                                                                                
       3610-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3620-CHK-DAY.                                                            
      *----------------------------------------------------------------*        
            DIVIDE WS-LEAP-YR BY 4 GIVING    WS-QUOTIENT                        
                               REMAINDER WS-REMAINDER.                          
            IF WS-REMAINDER = 0                                                 
               PERFORM  3640-CHK-DAY    THRU  3640-EXIT                         
            ELSE                                                                
               PERFORM  3650-CHK-DAY    THRU  3650-EXIT                         
            END-IF.                                                             
                                                                                
       3620-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3630-CHK-DAY.                                                            
      *----------------------------------------------------------------*        
                                                                                
            IF WS-NEXT-DD  < 30                                                 
               ADD 1       TO WS-NEXT-DD                                        
            ELSE                                                                
               IF  WS-NEXT-DD  = 30                                             
                   MOVE        01           TO WS-NEXT-DD                       
                   IF WS-NEXT-MM  = 12                                          
                      MOVE 01               TO WS-NEXT-MM                       
                      ADD      1            TO WS-NEXT-CY                       
                   ELSE                                                         
                      ADD      1            TO WS-NEXT-MM                       
                   END-IF                                                       
               END-IF                                                           
            END-IF.                                                             
                                                                                
                                                                                
       3630-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3640-CHK-DAY.                                                            
      *----------------------------------------------------------------*        
            IF WS-NEXT-DD  < 29                                                 
               ADD 1       TO WS-NEXT-DD                                        
            ELSE                                                                
               IF  WS-NEXT-DD  = 29                                             
                   MOVE        01           TO WS-NEXT-DD                       
                   ADD          1           TO WS-NEXT-MM                       
               END-IF                                                           
            END-IF.                                                             
                                                                                
       3640-EXIT.                                                               
            EXIT.                                                               
                                                                                
                                                                                
      *----------------------------------------------------------------*        
       3650-CHK-DAY.                                                            
      *----------------------------------------------------------------*        
            IF WS-NEXT-DD  < 28                                                 
               ADD 1       TO WS-NEXT-DD                                        
            ELSE                                                                
               IF  WS-NEXT-DD  = 28                                             
                   MOVE        01           TO WS-NEXT-DD                       
                   ADD          1           TO WS-NEXT-MM                       
               END-IF                                                           
            END-IF.                                                             
                                                                                
       3650-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       3999-READ-BP13KQ60.                                                      
      *----------------------------------------------------------------*        
           MOVE SPACES                   TO  BP13KQ60-REC.                      
           INITIALIZE                        BP13KQ60-REC.                      
           MOVE WS-NUM-SALE-MODE         TO  KQ60-NUM-SALE-MODE.                
           MOVE WS-NUM-ZONE              TO  KQ60-NUM-ZONE.                     
           MOVE WS-DTE-BALLOT            TO  KQ60-DTE-BALLOT.                   
           MOVE WS-DTE-BKAPPMT           TO  KQ60-DTE-BKAPPMT.                  
           IF WS-NUM-SALE-MODE = 'BTO'                                          
             PERFORM 3250-GET-FLAT-TYPE  THRU  3250-EXIT                        
           END-IF.                                                              
           MOVE WS-NUM-FLAT-TYPE         TO  KQ60-NUM-FLAT-TYPE.                
           MOVE KQ60-KEY-FLD             TO  WS-KQ60-KEY-FLD.                   
                                                                                
           READ BP13KQ60                                                        
                                                                                
           IF WS-KQ60-STATUS = 0                                                
              IF KQ60-NUM-LAST-QUEUE <= WS-BP13KQ60-REC(23:5)                   
                 PERFORM 4000-PREPARE-KQ60-DATA THRU 4000-EXIT                  
                 PERFORM 4200-REWRITE-BP13KQ60  THRU 4200-EXIT                  
              END-IF                                                            
           ELSE                                                                 
             IF WS-KQ60-STATUS = 23                                             
                PERFORM 4000-PREPARE-KQ60-DATA  THRU 4000-EXIT                  
                PERFORM 4100-WRITE-BP13KQ60     THRU 4100-EXIT                  
             ELSE                                                               
               IF WS-KQ60-STATUS  NOT = 0                                       
                  MOVE WS-KQ60-STATUS  TO RETURN-CODE                           
                  DISPLAY 'READ ERROR, STATUS : ' WS-KQ60-STATUS                
                  DISPLAY ' KEY     : ' KQ60-KEY-FLD                            
                  PERFORM 9000-CLOSE-ROUTINE   THRU  9000-EXIT                  
               END-IF                                                           
             END-IF                                                             
           END-IF.                                                              
       3999-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       4000-PREPARE-KQ60-DATA.                                                  
      *----------------------------------------------------------------*        
                                                                                
            MOVE SPACES                  TO  BP13KQ60-REC.                      
            INITIALIZE                       BP13KQ60-REC.                      
            MOVE WS-KQ60-KEY-FLD         TO  KQ60-KEY-FLD.                      
            IF WS-NUM-QUEUE-BIG = ZEROS                                         
               MOVE WS-NUM-QUEUE-TEMP       TO  KQ60-NUM-LAST-QUEUE             
            ELSE                                                                
               MOVE WS-NUM-QUEUE-BIG        TO  KQ60-NUM-LAST-QUEUE             
            END-IF.                                                             
            MOVE FUNCTION CURRENT-DATE   TO  WS-CURRENT-DATE.                   
            MOVE WS-DATE                 TO  KQ60-DTE-UPDATE.                   
            MOVE WS-CURRENT-TIME         TO  WS-CURR-TIME1.                     
            ADD  1                       TO  WS-GM-CNT.                         
            MOVE WS-GM-CNT               TO  WS-GM.                             
            MOVE WS-CURR-TIME1           TO  KQ60-TME-SYSTEM.                   
            MOVE 'BP13C0Q1'              TO  KQ60-USERID.                       
                                                                                
       4000-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *----------------------------------------------------------------*        
       4100-WRITE-BP13KQ60.                                                     
      *----------------------------------------------------------------*        
           WRITE BP13KQ60-REC.                                                  
                                                                                
           IF WS-KQ60-STATUS = 0                                                
              ADD  1                       TO WS-CNT-KQ60-WRITE                 
           ELSE                                                                 
             IF WS-KQ60-STATUS  NOT = 0                                         
                 MOVE WS-KQ60-STATUS  TO RETURN-CODE                            
                 DISPLAY 'WRITE ERROR, STATUS : ' WS-KQ60-STATUS                
                 DISPLAY ' KEY     : ' KQ60-KEY-FLD                             
                 PERFORM 9000-CLOSE-ROUTINE   THRU  9000-EXIT                   
             END-IF                                                             
           END-IF.                                                              
                                                                                
       4100-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       4200-REWRITE-BP13KQ60.                                                   
      *----------------------------------------------------------------*        
           REWRITE BP13KQ60-REC.                                                
           IF WS-KQ60-STATUS = 0                                                
              ADD  1                        TO WS-CNT-KQ60-REWRITE              
           ELSE                                                                 
             IF WS-KQ60-STATUS  NOT = 0                                         
                MOVE WS-KQ60-STATUS         TO RETURN-CODE                      
                DISPLAY 'REWRITE ERROR, STATUS : ' WS-KQ60-STATUS               
                DISPLAY ' KEY     : ' KQ60-KEY-FLD                              
                PERFORM 9000-CLOSE-ROUTINE     THRU 9000-EXIT                   
             END-IF                                                             
           END-IF.                                                              
       4200-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *----------------------------------------------------------------*        
       9000-CLOSE-ROUTINE.                                                      
      *----------------------------------------------------------------*        
                                                                                
           CLOSE BP13F200                                                       
                 BP13F205                                                       
                 BP13K813                                                       
                 BP13KQ60.                                                      
                                                                                
           IF WS-KQ60-STATUS NOT = 00 AND 97                                    
              DISPLAY 'CLOSING ERROR BP13KQ60. STATUS : ' WS-KQ60-STATUS        
              MOVE WS-KQ60-STATUS       TO   RETURN-CODE.                       
                                                                                
           IF WS-K813-STATUS NOT = 00 AND 97                                    
              DISPLAY 'CLOSING ERROR BP13K813. STATUS : ' WS-K813-STATUS        
              MOVE WS-K813-STATUS       TO   RETURN-CODE.                       
                                                                                
           DISPLAY '                                  '.                        
           DISPLAY '************ BP13C0Q1 ************'.                        
           DISPLAY 'DATE : ' WS-EDITED-DATE.                                    
           DISPLAY '                                    '.                      
           DISPLAY 'NO OF RECORDS READ       (BP13F200) = '                     
                    WS-CNT-F200-READ.                                           
           DISPLAY 'NO OF RECORD UPDATED     (BP13KQ60) = '                     
                    WS-CNT-KQ60-WRITE.                                          
           DISPLAY 'NO OF REWRITE RECORD     (BP13KQ60) = '                     
                    WS-CNT-KQ60-REWRITE.                                        
           DISPLAY 'NO OF RECORD READ        (BP13F205) = '                     
                    WS-F205-CNT.                                                
                                                                                
           STOP RUN.                                                            
                                                                                
       9000-EXIT.                                                               
            EXIT.                                                               
