       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.    BP13C222.                                                 
      *AUTHOR.        CHETANA.                                                  
      *DATE-WRITTEN.  07 JAN 2019.                                              
      * ======================================================== *              
      * SYSTEM OF COMMITMENT (BP13)                              *              
      * ======================================================== *              
      *    OBJECTIVE  :                                          *              
      *      1.  CREATE F206 XML FILE                            *              
      *                                                          *              
      *     INPUT FILES:                                         *              
      *           1. BP13K757                                                   
      *           2. BP13K022                                    *              
      *                                                          *              
      *     OUTPUT FILES:                                        *              
      *           1. BP13F206                                    *              
      * -------------------------------------------------------- *              
      *  CHG NO     DATE     BY   DESCRIPTION                    *              
      * -------- ----------  ---- ------------------------------ *              
      * BP13XXXX 07/01/2019  CC37 NEW PROGRAM                    *              
      * BP139344 22/11/2022  MRR5 SKIP CANCELLED CASES           *              
      * BP139280 06/11/2023  EAA2 EXPAND BP13K757 FROM 3000 TO 4000*            
      ************************************************************              
                                                                                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
      *-------------------------------------------------------------            
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
      *-------------------------------------------------------------            
                                                                                
           SELECT BP13F206  ASSIGN        TO  BP13F206                          
                            FILE STATUS IS F206-STATUS.                         
                                                                                
           SELECT BP13K757  ASSIGN        TO  BP13K757                          
                            ORGANIZATION  IS  INDEXED                           
                            ACCESS MODE   IS  RANDOM                            
                            RECORD KEY    IS  K757-KEY-FLD                      
                            FILE STATUS   IS  K757-STATUS.                      
                                                                                
           SELECT BP13K022  ASSIGN        TO  BP13K022                          
                            ORGANIZATION  IS  INDEXED                           
                            ACCESS MODE   IS  RANDOM                            
                            RECORD KEY    IS  K022-KEY-FLD                      
                            ALTERNATE RECORD KEY IS  K022-NUM-REGN              
                            FILE STATUS   IS  K022-STATUS.                      
                                                                                
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
      *-------------------------------------------------------------            
                                                                                
       FD   BP13F206                                                            
            BLOCK CONTAINS 0 RECORDS                                            
            RECORD CONTAINS 150 CHARACTERS                                      
            LABEL RECORDS ARE STANDARD                                          
            RECORDING MODE IS F.                                                
       01   BP13F206-REC                  PIC X(150).                           
                                                                                
       FD   BP13K757                                                            
            RECORD CONTAINS 4000 CHARACTERS.                                    
       COPY BP13K757.                                                           
                                                                                
       FD   BP13K022                                                            
            RECORD CONTAINS 100 CHARACTERS.                                     
       COPY BP13K022.                                                           
                                                                                
      *------------------------------------------------------------*            
       WORKING-STORAGE SECTION.                                                 
      *-------------------------------------------------------------            
       01  WS-INDICATORS.                                                       
           05  WS-END-CURSOR              PIC X(01)   VALUE 'N'.                
           05  K757-STATUS                PIC 9(2)    VALUE  00.                
           05  K022-STATUS                PIC 9(2)    VALUE  00.                
           05  F206-STATUS                PIC 9(2)    VALUE  00.                
                                                                                
       01  WS-COUNTERS-POINTERS.                                                
           05  WS-READ-CNT-TAB            PIC 9(7)    VALUE ZEROS.              
           05  WS-WRITE-F206              PIC 9(6)    VALUE ZEROS.              
           05  WS-MISSING-K022            PIC 9(7)    VALUE ZEROS.              
           05  WS-MISSING-K757            PIC 9(7)    VALUE ZEROS.              
           05  WS-SKIPPED-K757            PIC 9(7)    VALUE ZEROS.              
           05  WS-INTEGER-DTE-SO-APPT     PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-DTE-2ND-CONLOAN PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-DTE-SUBTRANSFER PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-DTE-AO-APPT     PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-DTE-BK-APPT     PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-DTE-SL-APPT     PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-CUR-DATE1       PIC S9(9)   VALUE ZEROS.              
           05  WS-INTEGER-CUR-DATE4       PIC S9(9)   VALUE ZEROS.              
           05  WS-DATE-CHECK              PIC X(8)    VALUE SPACES.             
           05  WS-INVALID                 PIC X       VALUE 'N'.                
                                                                                
       01  WS-TIME-APPT                   PIC X(8).                             
       01  WS-TME-APNTMT-END              PIC X(8).                             
       01  WS-TME-APNTMT-START            PIC X(8).                             
       01  WS-DTE-APNTMT                  PIC X(10).                            
       01  WS-DATE                        PIC X(8).                             
       01  WS-DATE9 REDEFINES WS-DATE     PIC 9(8).                             
       01  WS-NAME-OCC                    PIC X(66)   VALUE SPACES.             
       01  WS-TIMESTAMP                   PIC X(26) VALUE SPACES.               
                                                                                
       01  LINK-VARIABLES.                                                      
           05 WS-LINK-REC.                                                      
              10 WS-IN-OPTION          PIC X(02).                               
              10 WS-IN-GEN.                                                     
                 15 WS-IN-DATE         PIC X(08).                               
              10 WS-RET-GEN.                                                    
                 15 WS-RETURN          PIC X(03).                               
                                                                                
       COPY F206XML.                                                            
       COPY P13COMM8.                                                           
                                                                                
       01  LINK-REC.                                                            
           05  LINK-NUM-SCH-ACC.                                                
               10  LINK-NUM-SCH             PIC X(4).                           
               10  LINK-NUM-ACC             PIC X(5).                           
                                                                                
       01  WS-VARS.                                                             
           05  XML-DECLARATION         PIC X(38) VALUE                          
               '<?xml version="1.0" encoding="UTF-8"?>'.                        
           05  XML-OPEN                PIC X(09) VALUE '<apntmts>'.             
           05  XML-CLOSE               PIC X(10) VALUE '</apntmts>'.            
           05  CSTMRS-OPEN             PIC X(10) VALUE '<cstmrs>'.              
           05  CSTMRS-CLOSE            PIC X(11) VALUE '</cstmrs>'.             
           05  CUSTOMER-OPEN           PIC X(10) VALUE '<cstmr>'.               
           05  CUSTOMER-CLOSE          PIC X(11) VALUE '</cstmr>'.              
           05  RCRD-OPEN               PIC X(06) VALUE '<rcrd>'.                
           05  RCRD-CLOSE              PIC X(07) VALUE '</rcrd>'.               
                                                                                
       01  WRITE-REC                   PIC X(150) VALUE SPACES.                 
                                                                                
           EXEC SQL INCLUDE P13VAPMT END-EXEC.                                  
           EXEC SQL INCLUDE SQLCA    END-EXEC.                                  
                                                                                
      *****************************************************                     
      ** CURSOR TO RETRIEVE APPOINTMENT INFO **                                 
      *****************************************************                     
           EXEC SQL                                                             
             DECLARE APPMT CURSOR FOR                                           
               SELECT                                                           
                 DTE_APNTMT                                                     
                ,TME_APNTMT                                                     
                ,NUM_SOURCE_REF                                                 
                ,NUM_QUEUE                                                      
               FROM                                                             
                 CSTMR_APNTMT                                                   
               WHERE                                                            
                 NUM_ENTRY_SYSTEM = 'BP13'          AND                         
                 DTE_APNTMT  = :WS-DTE-APNTMT       AND                         
                 TME_APNTMT >= :WS-TME-APNTMT-START AND                         
                 TME_APNTMT <= :WS-TME-APNTMT-END                               
               ORDER BY DTE_APNTMT,TME_APNTMT ASC                               
           END-EXEC.                                                            
                                                                                
      *------------------------------------------------------------*            
       PROCEDURE DIVISION.                                                      
      *------------------------------------------------------------*            
       000-MAIN.                                                                
      *------------------------------------------------------------*            
           INITIALIZE C221-TAGS                                                 
           PERFORM  100-OPEN-FILES        THRU   100-EXIT.                      
           PERFORM  200-GET-CURRENT-TIME  THRU   200-EXIT.                      
           PERFORM  300-PROCESS-PARA      THRU   300-EXIT                       
                                                                                
           PERFORM  9999-CLOSE-ROUTINE    THRU   9999-EXIT.                     
                                                                                
       000-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       100-OPEN-FILES.                                                          
      *-------------------------------------------------------------            
           OPEN INPUT  BP13K757                                                 
                       BP13K022                                                 
                OUTPUT BP13F206.                                                
                                                                                
           IF K757-STATUS NOT = 00 AND 97                                       
              DISPLAY 'BP13K757 - OPEN ERROR, K757-STATUS ' K757-STATUS         
              MOVE     K757-STATUS      TO       RETURN-CODE                    
              PERFORM  9999-CLOSE-ROUTINE.                                      
                                                                                
           IF K022-STATUS NOT = 00 AND 97                                       
              DISPLAY 'BP13K022 - OPEN ERROR, K022-STATUS ' K022-STATUS         
              MOVE     K022-STATUS      TO       RETURN-CODE                    
              PERFORM  9999-CLOSE-ROUTINE.                                      
                                                                                
           MOVE ZEROS                       TO WS-COUNTERS-POINTERS.            
                                                                                
       100-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       200-GET-CURRENT-TIME.                                                    
      *-------------------------------------------------------------            
           EXEC SQL                                                             
                SET :WS-TIMESTAMP = CURRENT TIMESTAMP                           
           END-EXEC.                                                            
           IF SQLCODE NOT = 000                                                 
              DISPLAY 'SQL ERROR SET DB2 TIMESTAMP'                             
              DISPLAY 'SQL ERROR CODE  : '  SQLCODE                             
              PERFORM 9999-CLOSE-ROUTINE THRU 9999-EXIT                         
           END-IF.                                                              
                                                                                
       200-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       300-PROCESS-PARA.                                                        
      *-------------------------------------------------------------            
           WRITE BP13F206-REC FROM XML-DECLARATION                              
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM XML-OPEN                                     
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           MOVE 'CREATE'            TO action                                   
           XML GENERATE WRITE-REC FROM action                                   
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           PERFORM 310-OPEN-CURSOR  THRU 310-EXIT.                              
           MOVE 'N'                   TO WS-END-CURSOR.                         
           PERFORM 320-FETCH-CURSOR THRU 320-EXIT                               
                   UNTIL WS-END-CURSOR = 'Y'                                    
           PERFORM 360-CLOSE-CURSOR THRU 360-EXIT.                              
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           MOVE WS-WRITE-F206       TO rcrds                                    
           XML GENERATE WRITE-REC FROM rcrds                                    
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           WRITE BP13F206-REC FROM XML-CLOSE.                                   
                                                                                
       300-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ***************************************************************           
       310-OPEN-CURSOR.                                                         
      ***************************************************************           
           MOVE WS-TIMESTAMP(1:10)      TO WS-DTE-APNTMT                        
                                                                                
           IF WS-TIMESTAMP(12:2) >= '12'                                        
              MOVE '12.00.00'           TO WS-TME-APNTMT-START                  
              MOVE '23.59.59'           TO WS-TME-APNTMT-END                    
           ELSE                                                                 
              MOVE '00.00.00'           TO WS-TME-APNTMT-START                  
              MOVE '11.59.59'           TO WS-TME-APNTMT-END                    
           END-IF                                                               
                                                                                
           EXEC SQL                                                             
                OPEN APPMT                                                      
           END-EXEC.                                                            
           EVALUATE SQLCODE                                                     
           WHEN 000                                                             
                CONTINUE                                                        
           WHEN OTHER                                                           
                DISPLAY 'ERROR OPENING THE CURSOR. SQLCODE:' SQLCODE            
                PERFORM 9999-CLOSE-ROUTINE THRU 9999-EXIT                       
           END-EVALUATE.                                                        
                                                                                
       310-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       320-FETCH-CURSOR.                                                        
      *-------------------------------------------------------------            
           EXEC SQL                                                             
                FETCH APPMT                                                     
                INTO :DCLCSTMR-APNTMT.DTE-APNTMT,                               
                     :DCLCSTMR-APNTMT.TME-APNTMT,                               
                     :DCLCSTMR-APNTMT.NUM-SOURCE-REF,                           
                     :DCLCSTMR-APNTMT.NUM-QUEUE                                 
           END-EXEC.                                                            
                                                                                
           EVALUATE SQLCODE                                                     
           WHEN 000                                                             
                ADD 1 TO WS-READ-CNT-TAB                                        
                PERFORM 330-MOVE-OUTPUT-DATA THRU 330-EXIT                      
           WHEN 100                                                             
                MOVE 'Y'  TO WS-END-CURSOR                                      
           WHEN OTHER                                                           
                DISPLAY 'ERROR FETCHING CURSOR. SQLCODE:' SQLCODE               
                PERFORM 9999-CLOSE-ROUTINE THRU 9999-EXIT                       
           END-EVALUATE.                                                        
                                                                                
       320-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       330-MOVE-OUTPUT-DATA.                                                    
      *-------------------------------------------------------------            
           MOVE SPACES               TO BP13K757-REC.                           
           MOVE NUM-SOURCE-REF       TO K757-NUM-REGN.                          
                                                                                
           READ BP13K757.                                                       
           EVALUATE K757-STATUS                                                 
           WHEN 00                                                              
                IF NUM-SOURCE-REF(11:4) = K757-NUM-LAST-QUEUE(2:4)              
                   IF K757-NUM-CANCEL = 'Y'                                     
                      ADD 1 TO WS-SKIPPED-K757                                  
                      DISPLAY 'SKIPPED CANCELLED K757 RECORD: '                 
                               K757-NUM-REGN                                    
                      GO TO 330-EXIT                                            
                   ELSE                                                         
                      CONTINUE                                                  
                   END-IF                                                       
                ELSE                                                            
                   ADD 1 TO WS-SKIPPED-K757                                     
                   DISPLAY 'SKIPPED K757 RECORD:' K757-NUM-REGN ' '             
                   DTE-APNTMT ' ' TME-APNTMT ' ' NUM-SOURCE-REF(10:5)           
                   GO TO 330-EXIT                                               
                END-IF                                                          
           WHEN 23                                                              
                DISPLAY 'BP13K757 - RECORD NOT FOUND, KEY: '                    
                         K757-NUM-REGN                                          
                ADD 1 TO WS-MISSING-K757                                        
                GO TO 330-EXIT                                                  
           WHEN OTHER                                                           
                DISPLAY 'BP13K757 - ERROR READING, KEY: '                       
                         K757-NUM-REGN                                          
                ADD 1 TO WS-MISSING-K757                                        
                GO TO 330-EXIT                                                  
           END-EVALUATE.                                                        
                                                                                
           MOVE SPACES TO BP13F206-REC.                                         
           INITIALIZE BP13F206-REC.                                             
           MOVE 'SALES'              TO  dptmnt.                                
           MOVE 'OBF'                TO  townCode.                              
           MOVE 'OB'                 TO  flatType.                              
           MOVE K757-DTE-BALLOT      TO  ballotDate.                            
           MOVE 'APPLICANT'          TO  role.                                  
           MOVE 'OBF'                TO  slctType.                              
           MOVE K757-DTE-REQUESTED   TO  rgstrtnDate                            
           MOVE K757-NUM-REGN        TO  rfrnc.                                 
           MOVE 'OB  '               TO  srvc                                   
           STRING DTE-APNTMT(1:4) DTE-APNTMT(6:2) DTE-APNTMT(9:2)               
                  DELIMITED BY SIZE INTO apntmtDate                             
           MOVE TME-APNTMT           TO WS-TIME-APPT                            
           IF NUM-SOURCE-REF(10:1) = 'Z'                                        
              MOVE NUM-SOURCE-REF(10:5) TO sales1queue                          
           ELSE                                                                 
              MOVE NUM-SOURCE-REF(11:4) TO sales1queue                          
              STRING 'B' NUM-SOURCE-REF(11:4)                                   
                     DELIMITED BY SIZE INTO sales1queue                         
           END-IF                                                               
           PERFORM 340-WRITE-F206   THRU 340-EXIT.                              
                                                                                
       330-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *---------------*                                                         
       340-WRITE-F206.                                                          
      *---------------*                                                         
           IF WS-TIME-APPT NOT = SPACES                                         
              MOVE WS-TIME-APPT      TO apntmtTime(1:8)                         
              MOVE '.'               TO apntmtTime(9:1)                         
              MOVE ':'               TO apntmtTime(3:1)                         
                                        apntmtTime(6:1)                         
              MOVE ZEROES            TO apntmtTime(10:3)                        
           END-IF                                                               
                                                                                
           PERFORM 341-GET-OIC         THRU 341-EXIT.                           
                                                                                
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM RCRD-OPEN                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM dptmnt                                   
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM srvc                                     
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM apntmtDate                               
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM apntmtTime                               
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM apntmtEnd                                
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM apntmtTyp                                
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM rgstrtnDate                              
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM rfrnc                                    
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM CSTMRS-OPEN                                  
                                                                                
           MOVE K757-NUM-APPLT1-UIN  TO  nric                                   
           MOVE K757-NME-APPLT1      TO  name                                   
           MOVE K757-NUM-APPLT1-HP-PAGER TO  cntct                              
           PERFORM 342-WRITE-APPLICANT-INFO THRU 342-EXIT                       
                                                                                
           IF K757-NUM-APPLT2-UIN NOT = SPACES                                  
              MOVE K757-NUM-APPLT2-UIN  TO  nric                                
              MOVE K757-NME-APPLT2      TO  name                                
              MOVE K757-NUM-APPLT2-HP-PAGER TO  cntct                           
              PERFORM 342-WRITE-APPLICANT-INFO THRU 342-EXIT                    
           END-IF                                                               
                                                                                
           IF K757-NUM-APPLT3-UIN NOT = SPACES                                  
              MOVE K757-NUM-APPLT3-UIN  TO  nric                                
              MOVE K757-NME-APPLT3      TO  name                                
              MOVE K757-NUM-APPLT3-HP-PAGER TO  cntct                           
              PERFORM 342-WRITE-APPLICANT-INFO THRU 342-EXIT                    
           END-IF                                                               
                                                                                
           IF K757-NUM-APPLT4-UIN NOT = SPACES                                  
              MOVE K757-NUM-APPLT4-UIN  TO  nric                                
              MOVE K757-NME-APPLT4      TO  name                                
              MOVE K757-NUM-APPLT4-HP-PAGER TO  cntct                           
              PERFORM 342-WRITE-APPLICANT-INFO THRU 342-EXIT                    
           END-IF                                                               
                                                                                
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM CSTMRS-CLOSE                                 
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM corpPass                                 
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM OIC                                      
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM OICcntct                                 
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM queuePFx                                 
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM queuePstn                                
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM sales1queue                              
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM othrCaseNo                               
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM townCode                                 
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM flatType                                 
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM slctType                                 
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM ballotDate                               
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM SpclRqstTag                              
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM rmrks                                    
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
      *    MOVE SPACES              TO BP13F206-REC                             
      *    WRITE BP13F206-REC FROM ADDRESS-OPEN                                 
      *                                                                         
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM street                                   
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
      *                                                                         
      *    MOVE SPACES              TO WRITE-REC                                
      *    IF WS-BLOCK NOT = SPACES                                             
      *       STRING BLOCK-OPEN, WS-BLOCK, BLOCK-CLOSE                          
      *       DELIMITED BY SIZE                                                 
      *       INTO WRITE-REC                                                    
      *    ELSE                                                                 
      *       STRING BLOCK-OPEN, ' ' , BLOCK-CLOSE                              
      *       DELIMITED BY SIZE                                                 
      *       INTO WRITE-REC                                                    
      *    END-IF                                                               
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
      *                                                                         
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM level                                    
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
      *                                                                         
      *    MOVE SPACES              TO WRITE-REC                                
      *    IF WS-UNIT NOT = SPACES                                              
      *       STRING UNIT-OPEN, WS-UNIT, UNIT-CLOSE                             
      *       DELIMITED BY SIZE                                                 
      *       INTO WRITE-REC                                                    
      *    ELSE                                                                 
      *       STRING UNIT-OPEN, ' ' , UNIT-CLOSE                                
      *       DELIMITED BY SIZE                                                 
      *       INTO WRITE-REC                                                    
      *    END-IF                                                               
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
      *                                                                         
      *    MOVE SPACES              TO WRITE-REC                                
      *    XML GENERATE WRITE-REC FROM postalCode                               
      *    WRITE BP13F206-REC FROM WRITE-REC                                    
      *                                                                         
      *    MOVE SPACES              TO BP13F206-REC                             
      *    WRITE BP13F206-REC FROM ADDRESS-CLOSE                                
                                                                                
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM RCRD-CLOSE                                   
                                                                                
           ADD 1  TO WS-WRITE-F206.                                             
                                                                                
       340-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *--------------*                                                          
       341-GET-OIC.                                                             
      *--------------*                                                          
           MOVE SPACES        TO K022-KEY-FLD                                   
           MOVE K757-NUM-REGN TO K022-NUM-REGN                                  
                                                                                
           READ BP13K022 KEY IS K022-NUM-REGN                                   
                                                                                
           EVALUATE K022-STATUS                                                 
           WHEN 00                                                              
           WHEN 02                                                              
                MOVE K022-NUM-OIC  TO OIC                                       
           WHEN 23                                                              
                DISPLAY 'BP13K022 - RECORD NOT FOUND, KEY: '                    
                         K757-NUM-REGN                                          
                MOVE SPACES        TO OIC                                       
                ADD 1 TO WS-MISSING-K022                                        
                                                                                
           WHEN OTHER                                                           
                DISPLAY 'BP13K022 - ERROR READING, KEY: '                       
                         K757-NUM-REGN                                          
                MOVE SPACES        TO OIC                                       
                ADD 1 TO WS-MISSING-K022                                        
                                                                                
           END-EVALUATE.                                                        
                                                                                
       341-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------*                                               
       342-WRITE-APPLICANT-INFO.                                                
      *-------------------------*                                               
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM CUSTOMER-OPEN                                
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM name                                     
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM nric                                     
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM role                                     
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO WRITE-REC                                
           XML GENERATE WRITE-REC FROM cntct                                    
           WRITE BP13F206-REC FROM WRITE-REC                                    
                                                                                
           MOVE SPACES              TO BP13F206-REC                             
           WRITE BP13F206-REC FROM CUSTOMER-CLOSE.                              
                                                                                
       342-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ***************************************************************           
       360-CLOSE-CURSOR.                                                        
      ***************************************************************           
                                                                                
           EXEC SQL                                                             
                CLOSE APPMT                                                     
           END-EXEC.                                                            
           EVALUATE SQLCODE                                                     
           WHEN 000                                                             
                CONTINUE                                                        
           WHEN OTHER                                                           
                DISPLAY 'ERROR CLOSING THE CURSOR. SQLCODE:' SQLCODE            
                PERFORM 9999-CLOSE-ROUTINE THRU 9999-EXIT                       
           END-EVALUATE.                                                        
                                                                                
       360-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       9999-CLOSE-ROUTINE.                                                      
      *-------------------------------------------------------------            
           DISPLAY '  '.                                                        
           DISPLAY '*----------- BP13C222 CONTROL LIST ----------*'.            
           DISPLAY '  '.                                                        
           DISPLAY 'NO OF RECS READ FROM TABLE = ' WS-READ-CNT-TAB.             
           DISPLAY 'NO OF F206 RECORDS WRITTEN = ' WS-WRITE-F206.               
           DISPLAY 'NO OF K757 SKIPPED RECORD  = ' WS-SKIPPED-K757.             
           DISPLAY 'NO OF K757 MISSING RECORD  = ' WS-MISSING-K757.             
           DISPLAY 'NO OF K022 MISSING RECORD  = ' WS-MISSING-K022.             
                                                                                
           CLOSE BP13K757                                                       
                 BP13K022                                                       
                 BP13F206.                                                      
                                                                                
           IF K757-STATUS NOT = 00 AND 97                                       
              DISPLAY 'BP13K757 CLOSE ERROR, K757-STATUS ' K757-STATUS          
              MOVE     K757-STATUS      TO       RETURN-CODE.                   
                                                                                
           IF K022-STATUS NOT = 00 AND 97                                       
              DISPLAY 'BP13K022 CLOSE ERROR, K022-STATUS ' K022-STATUS          
              MOVE     K022-STATUS      TO       RETURN-CODE.                   
                                                                                
           STOP RUN.                                                            
                                                                                
       9999-EXIT.                                                               
           EXIT.                                                                
                                                                                
