       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.   BP13CK03.                                                  
      *AUTHOR.       YCH2.                                                      
      *DATE-WRITTEN. 03/03/2006.                                                
      * ====================================================== *                
      * SYSTEM OF COMMITMENT (BP13)                            *                
      * ====================================================== *                
      *                                                        *                
      *    OBJECTIVE :                                         *                
      *      1.  THIS IS A PROGRAM TO MATCH THE NRIC IN REQUEST*                
      *          FILE WITH THE NRIC IN SMS, IF FOUND WITH      *                
      *          DP FLAT THEN OUTPUT                           *                
      *                                                        *                
      *--------------------------------------------------------*                
      * CHG-NO  BY   DATE      DESCRIPTION                     *                
      * ======  ===  ====      ============                    *                
      *BP132833 YCH2 030302006 NEW PROGRAM                     *                
      *BP139518 EAA2 26042023  TO INCLUDE 6 SALES TYPE CODE    *                
      *                          (8L/8M/8N/8R/8S/8T) 8E        *                
      * ====================================================== *                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
           SELECT BP13F558   ASSIGN TO BP13F558.                                
                                                                                
           SELECT BP13F559   ASSIGN TO BP13F559.                                
                                                                                
           SELECT AB03K080   ASSIGN TO AB03K080                                 
                  ORGANIZATION IS INDEXED                                       
                  ACCESS MODE  IS DYNAMIC                                       
                  RECORD KEY   IS K080-KEY                                      
                  FILE STATUS  IS AB03K080-STATUS.                              
                                                                                
           SELECT AB03K700   ASSIGN TO AB03K700                                 
                  ORGANIZATION IS INDEXED                                       
                  ACCESS MODE  IS RANDOM                                        
                  RECORD KEY   IS K700-NUM-HDB-REF                              
                  FILE STATUS  IS AB03K700-STATUS.                              
                                                                                
           SELECT AB03K030   ASSIGN TO AB03K030                                 
                  ORGANIZATION IS INDEXED                                       
                  ACCESS MODE  IS RANDOM                                        
                  RECORD KEY   IS K030-NUM-HDB-REF                              
                  FILE STATUS  IS AB03K030-STATUS.                              
                                                                                
           SELECT P13F558O   ASSIGN TO P13F558O.                                
                                                                                
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
                                                                                
       FD   BP13F558                                                            
            RECORD CONTAINS 600 CHARACTERS                                      
            BLOCK CONTAINS 0 RECORDS                                            
            LABEL RECORDS ARE STANDARD                                          
            RECORDING MODE IS F.                                                
                                                                                
       COPY BP13F558.                                                           
                                                                                
       FD   BP13F559                                                            
            RECORD CONTAINS 500 CHARACTERS                                      
            BLOCK CONTAINS 0 RECORDS                                            
            LABEL RECORDS ARE STANDARD                                          
            RECORDING MODE IS F.                                                
                                                                                
       COPY BP13F559.                                                           
                                                                                
       FD   P13F558O                                                            
            RECORD CONTAINS 600 CHARACTERS                                      
            BLOCK CONTAINS 0 RECORDS                                            
            LABEL RECORDS ARE STANDARD                                          
            RECORDING MODE IS F.                                                
                                                                                
       01   P13F558O-REC                  PIC X(600).                           
                                                                                
       FD   AB03K080                                                            
            RECORD CONTAINS 50 CHARACTERS.                                      
                                                                                
       COPY AB03K080.                                                           
                                                                                
       FD   AB03K700                                                            
            RECORD CONTAINS 500 CHARACTERS.                                     
                                                                                
       COPY AB03K700.                                                           
                                                                                
       FD   AB03K030                                                            
            RECORD CONTAINS 800 CHARACTERS.                                     
                                                                                
       COPY AB03K030.                                                           
                                                                                
      ***************************                                               
       WORKING-STORAGE SECTION.                                                 
      ***************************                                               
       01  AB03K030-STATUS         PIC 9(2)    VALUE ZEROES.                    
       01  AB03K700-STATUS         PIC 9(2)    VALUE ZEROES.                    
       01  AB03K080-STATUS         PIC 9(2)    VALUE ZEROES.                    
                                                                                
       01  WS-K080-READ            PIC 9(8)    VALUE 0.                         
       01  WS-F558-READ            PIC 9(8)    VALUE 0.                         
       01  WS-F558O-WRITE          PIC 9(8)    VALUE 0.                         
       01  WS-K030-NOTFND          PIC 9(8)    VALUE 0.                         
       01  WS-OUTPUT-CNT           PIC 9(8)    VALUE 0.                         
       01  WS-GRANT-CNT            PIC 9(8)    VALUE 0.                         
       01  WS-MULTIPLE-CNT         PIC 9(8)    VALUE 0.                         
       01  WS-OPEN-MARKET-CNT      PIC 9(8)    VALUE 0.                         
       01  WS-PUBLIC-CNT           PIC 9(8)    VALUE 0.                         
       01  WS-ADMIN-CNT            PIC 9(8)    VALUE 0.                         
       01  WS-MR-NOT-CURRENT-CNT   PIC 9(8)    VALUE 0.                         
       01  WS-F559-CNT             PIC 9(8)    VALUE 0.                         
       01  WS-F559-SUB             PIC 9(2)    VALUE 0.                         
       01  WS-STORE                PIC 9(2)    VALUE 0.                         
       01  WS-MR-NRIC              PIC 9(8)    VALUE 0.                         
       01  WS-NMR-NRIC             PIC 9(8)    VALUE 0.                         
       01  WS-TAG-WRITE            PIC X(1)    VALUE 'N'.                       
       01  WS-LESSEE-1             PIC X(1)    VALUE SPACES.                    
       01  WS-LESSEE-2             PIC X(1)    VALUE SPACES.                    
       01  WS-LESSEE-3             PIC X(1)    VALUE SPACES.                    
       01  WS-LESSEE-4             PIC X(1)    VALUE SPACES.                    
                                                                                
       01  WS-TAG-ADMIN            PIC X       VALUE 'A'.                       
       01  WS-MULTIPLE-REC         PIC 9       VALUE 0.                         
                                                                                
       01  EOF-AB03K080            PIC X       VALUE 'N'.                       
       01  EOF-AB03K700            PIC X       VALUE 'N'.                       
       01  EOF-BP13F558            PIC X       VALUE 'N'.                       
                                                                                
       01  WS-CUR-DATE             PIC X(8)   VALUE SPACES.                     
                                                                                
       01  WS-RSL-ADDRESS.                                                      
           05  WS-RSL-NUM-BLK      PIC X(5)   VALUE SPACES.                     
           05  WS-RSL-NUM-LEVEL    PIC X(2)   VALUE SPACES.                     
           05  WS-RSL-NUM-UNIT     PIC X(5)   VALUE SPACES.                     
           05  WS-RSL-NME-STREET   PIC X(32)  VALUE SPACES.                     
           05  WS-RSL-NUM-POSTAL   PIC X(6)   VALUE SPACES.                     
                                                                                
       01  WS-SMS-REC.                                                          
           03 WS-HOUSEHOLD-REC OCCURS 9 TIMES.                                  
              04 WS-F558-REC1.                                                  
              05 WS-HHTY-REC.                                                   
                 10 WS-F559-NUM-REGN                   PIC X(8).                
                 10 WS-F559-NUM-MATURE-KEY REDEFINES WS-F559-NUM-REGN.          
                    15 WS-F559-NUM-REF                 PIC X(6).                
                    15 FILLER                          PIC X(2).                
                 10 WS-F559-NUM-NRIC.                                           
                    15 WS-F559-NUM-NRIC-PREFIX         PIC X(1).                
                    15 WS-F559-NUM-NRIC-OLD            PIC X(8).                
               05 FILLER                                PIC X(27).              
               05 WS-F559-DTE-TRSF-SMS                  PIC X(8).               
               05 WS-F559-DTE-FLAT-SOLD-SMS             PIC X(8).               
               05 WS-F559-CDE-SALES-TYPE-SMS            PIC X(2).               
               05 WS-F559-DTE-ISSUE-REGN                PIC X(8).               
               05 WS-F559-NUM-HDB-REF-RSL               PIC X(11).              
               05 WS-F559-CDE-RELATIONSHIP              PIC X(2).               
               05 WS-F559-CDE-LESSEE-CHECK              PIC X(1).               
               05 WS-F559-DTE-UPDATE                    PIC X(8).               
               05 WS-F559-CDE-HOUSEHOLD                 PIC X(1).               
               05 WS-F559-NUM-5YR-OCCUPN                PIC X(1).               
               05 FILLER                                PIC X(4).               
               05 WS-F559-CDE-OWNER-STATUS              PIC X(1).               
               05 WS-F559-CDE-FILE                      PIC X(1).               
               05 WS-F559-NUM-HDB-REF-SMS               PIC X(11).              
               05 WS-F559-CDE-FILE-STATUS-RSL           PIC X(3).               
               05 WS-F559-CDE-FLAT-TYPE-SMS             PIC X(02).              
               05 WS-F559-CDE-FLAT-TYPE-RESALE          PIC X(01).              
               05 WS-F559-NUM-MTHLY-INCOME              PIC 9(05).              
               05 WS-F559-CDE-SOLE-LESSEE               PIC X(01).              
               05 WS-F559-CDE-FILE-STATUS-SMS           PIC X(02).              
               05 WS-F559-NUM-ETHNIC                    PIC X(01).              
               05 WS-F559-NUM-SEX                       PIC X(01).              
               05 WS-F559-NUM-MARITAL-STATUS            PIC X(01).              
               05 WS-F559-DTE-BIRTH.                                            
                  10 WS-F559-DTE-BIRTH-CC               PIC X(02).              
                  10 WS-F559-DTE-BIRTH-YY               PIC X(02).              
                  10 WS-F559-DTE-BIRTH-MM               PIC X(02).              
                  10 WS-F559-DTE-BIRTH-DD               PIC X(02).              
               05 WS-F559-NUM-CITIZENSHIP               PIC X(02).              
               05 FILLER                                PIC X(12).              
              04 WS-F558-REC2.                                                  
               05 WS-F559-UIN-SMS1                       PIC X(09).             
               05 WS-F559-UIN-SMS2                       PIC X(09).             
               05 WS-F559-UIN-SMS3                       PIC X(09).             
               05 WS-F559-UIN-SMS4                       PIC X(09).             
               05 WS-F559-ACCT-SMS                       PIC X(01).             
               05 FILLER                                 PIC X(63).             
                                                                                
      *****  REPORT FORMAT                                                      
                                                                                
       01  WS-COUNTERS.                                                         
           05  WS-LINE-CTR            PIC 9(03)  VALUE ZEROES.                  
           05  WS-CTR-WRTN            PIC 9(05)  VALUE ZEROES.                  
                                                                                
       01  WS-RPT-DATE.                                                         
           05 WS-RPT-DATE-CCYY        PIC X(04).                                
           05 WS-RPT-DATE-MM          PIC X(02).                                
           05 WS-RPT-DATE-DD          PIC X(02).                                
                                                                                
      *-----------------------------------------------------------*             
      *        LINKAGE FOR SUB-PROGRAM BP13C913                   *             
      *-----------------------------------------------------------*             
       01  WS-LINK-REC.                                                         
           05  WS-LINK-NUM-SCH-ACC.                                             
               10  WS-LINK-NUM-SCH     PIC X(4).                                
               10  WS-LINK-NUM-ACC     PIC X(5).                                
                                                                                
       COPY P13COMM8.                                                           
                                                                                
      ***************************                                               
       PROCEDURE DIVISION.                                                      
      ***************************                                               
       000-MAIN.                                                                
           OPEN INPUT  AB03K080                                                 
                       BP13F558                                                 
                       AB03K700                                                 
                       AB03K030                                                 
                OUTPUT P13F558O                                                 
                       BP13F559.                                                
                                                                                
           IF AB03K080-STATUS NOT = ZEROS AND 97                                
               DISPLAY 'FILE AB03K080 OPEN ERROR'                               
               DISPLAY 'ERROR STATUS = ' AB03K080-STATUS                        
               MOVE AB03K080-STATUS TO RETURN-CODE                              
               PERFORM 900-CLOSE-ROUTINE.                                       
                                                                                
           IF AB03K700-STATUS NOT = ZEROS AND 97                                
               DISPLAY 'FILE AB03K700 OPEN ERROR'                               
               DISPLAY 'ERROR STATUS = ' AB03K700-STATUS                        
               MOVE AB03K700-STATUS TO RETURN-CODE                              
               PERFORM 900-CLOSE-ROUTINE.                                       
                                                                                
           IF AB03K030-STATUS NOT = ZEROS AND 97                                
               DISPLAY 'FILE AB03K030 OPEN ERROR'                               
               DISPLAY 'ERROR STATUS = ' AB03K030-STATUS                        
               MOVE AB03K030-STATUS TO RETURN-CODE                              
               PERFORM 900-CLOSE-ROUTINE.                                       
                                                                                
           PERFORM 100-READ-F558-REC THRU 100-EXIT.                             
           PERFORM 200-PROCESS-REC   THRU 200-EXIT                              
                   UNTIL EOF-BP13F558 = 'Y'                                     
                     OR  F558-NUM-NRIC = HIGH-VALUE.                            
           PERFORM 900-CLOSE-ROUTINE.                                           
                                                                                
       000-EXIT.                                                                
           EXIT.                                                                
                                                                                
       100-READ-F558-REC.                                                       
           READ BP13F558 AT END MOVE 'Y' TO EOF-BP13F558                        
                MOVE HIGH-VALUE TO F558-NUM-NRIC                                
                GO TO 100-EXIT.                                                 
           ADD 1 TO WS-F558-READ.                                               
                                                                                
       100-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *---------------------------------------------------------------*         
      * WS-TAG-WRITE = TO CATER FOR RECORD FOUND IN SMS AND AT LEAST  *         
      *                ONE RECORD WRITE TO OUTPUT FILE BEFORE         *         
      *                                                               *         
      * OPEN MARKET  = CDE-FILE BLANK BUT WITH SCHEME ACCOUNT NO      *         
      *                CDE-HOUSEHOLD 'H'                              *         
      *---------------------------------------------------------------*         
      *                                                                         
       200-PROCESS-REC.                                                         
           MOVE 'N'           TO EOF-AB03K080.                                  
           MOVE  0            TO WS-MULTIPLE-REC.                               
           MOVE  0            TO WS-STORE.                                      
           MOVE SPACES        TO WS-LESSEE-1,                                   
                                 WS-LESSEE-2,                                   
                                 WS-LESSEE-3,                                   
                                 WS-LESSEE-4.                                   
           MOVE SPACES        TO K080-KEY.                                      
           MOVE F558-NUM-NRIC TO K080-NUM-UIN.                                  
                                                                                
           START AB03K080 KEY NOT LESS THAN K080-KEY.                           
                                                                                
           IF  AB03K080-STATUS = ZEROES                                         
               PERFORM 300-READ-AB03K080 THRU 300-EXIT                          
               IF  F558-NUM-NRIC =  K080-NUM-UIN                                
                   MOVE 'N' TO WS-TAG-WRITE                                     
                   PERFORM 210-INITIALIZE-TABLE THRU 210-EXIT                   
                           VARYING WS-F559-SUB FROM 1 BY 1                      
                           UNTIL WS-F559-SUB > 9                                
                                                                                
                   ADD   1  TO WS-MR-NRIC                                       
                   MOVE  0  TO WS-F559-SUB                                      
                   PERFORM 310-PROCESS-AB03K080 THRU 310-EXIT                   
                     UNTIL K080-NUM-UIN NOT = F558-NUM-NRIC                     
                        OR EOF-AB03K080 = 'Y'                                   
                                                                                
                   PERFORM 360-WRITE-NON-CURRENT THRU 360-EXIT                  
                                                                                
                   IF WS-MULTIPLE-REC > 1                                       
                      PERFORM 220-WRITE-OUTPUT THRU 220-EXIT                    
                         VARYING WS-F559-SUB FROM 1 BY 1                        
                         UNTIL WS-F559-SUB > WS-STORE                           
                   END-IF                                                       
                                                                                
               ELSE                                                             
                   ADD 1 TO WS-NMR-NRIC                                         
           ELSE                                                                 
               ADD 1 TO WS-K030-NOTFND                                          
           END-IF.                                                              
                                                                                
           PERFORM 100-READ-F558-REC THRU 100-EXIT.                             
                                                                                
       200-EXIT.                                                                
           EXIT.                                                                
                                                                                
       210-INITIALIZE-TABLE.                                                    
           MOVE SPACES TO WS-HOUSEHOLD-REC(WS-F559-SUB).                        
                                                                                
       210-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
       220-WRITE-OUTPUT.                                                        
           MOVE WS-HOUSEHOLD-REC(WS-F559-SUB) TO BP13F559-REC.                  
           WRITE BP13F559-REC.                                                  
           ADD 1 TO WS-F559-CNT.                                                
                                                                                
       220-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
       300-READ-AB03K080.                                                       
           READ AB03K080 NEXT AT END                                            
                MOVE HIGH-VALUES TO K080-NUM-UIN                                
                MOVE 'Y' TO EOF-AB03K080,                                       
                GO TO 300-EXIT.                                                 
                                                                                
       300-EXIT.                                                                
           EXIT.                                                                
                                                                                
       310-PROCESS-AB03K080.                                                    
           MOVE 'A'    TO WS-TAG-ADMIN.                                         
           PERFORM 320-READ-AB03K030 THRU 320-EXIT.                             
           PERFORM 300-READ-AB03K080 THRU 300-EXIT.                             
                                                                                
       310-EXIT.                                                                
           EXIT.                                                                
                                                                                
       320-READ-AB03K030.                                                       
           MOVE K080-NUM-HDB-REF TO K030-NUM-HDB-REF.                           
           READ AB03K030.                                                       
                                                                                
           IF  AB03K030-STATUS = ZEROES                                         
               NEXT SENTENCE                                                    
           ELSE                                                                 
               DISPLAY 'SCHACC NOT FOUND IN AB03K030 ' K080-NUM-HDB-REF         
               GO TO 320-EXIT                                                   
           END-IF.                                                              
                                                                                
           IF K030-CDE-ACCT-STAT = 'C'                                          
              IF (K030-CDE-SALES-TYP = '12' OR '7 ' OR '7C' OR '7J' OR          
                                       '8A' OR '8B' OR '9 ' OR '9A' OR          
                                       '8L' OR '8M' OR '8N' OR '8R' OR          
                                       '8S' OR '8T' OR '8E') OR                 
                 (K030-CDE-ALLOC-SCH = 'OM ' OR 'PPO' OR 'AOM' OR               
                                       'ROM' OR 'PPR' OR 'SPR')                 
                  CONTINUE                                                      
              ELSE                                                              
                  PERFORM 330-READ-AB03K700     THRU 330-EXIT                   
                  PERFORM 350-UPD-CDE-HOUSEHOLD THRU 350-EXIT                   
                  IF WS-MULTIPLE-REC > 1                                        
                     ADD 1 TO WS-MULTIPLE-CNT                                   
              END-IF                                                            
           END-IF.                                                              
                                                                                
       320-EXIT.                                                                
           EXIT.                                                                
                                                                                
       330-READ-AB03K700.                                                       
           MOVE K080-NUM-HDB-REF TO K700-NUM-HDB-REF.                           
                                                                                
           READ AB03K700.                                                       
           IF  AB03K700-STATUS = ZEROES                                         
               NEXT SENTENCE                                                    
           ELSE                                                                 
               DISPLAY 'SCHACC NOT FOUND IN AB03K700 ' K080-NUM-HDB-REF         
               GO TO 330-EXIT.                                                  
                                                                                
           IF K080-NUM-UIN = K700-NUM-UIN1                                      
              IF  K700-CDE-OWNER-STATUS1 = 'E' OR 'A' OR 'P'                    
                  IF WS-TAG-ADMIN = 'L'                                         
                     NEXT SENTENCE                                              
                  ELSE                                                          
                     MOVE 'A' TO WS-TAG-ADMIN                                   
              ELSE                                                              
                 MOVE 'L' TO WS-TAG-ADMIN                                       
                 MOVE 'Y' TO WS-LESSEE-1                                        
           ELSE                                                                 
              IF K080-NUM-UIN = K700-NUM-UIN2                                   
                 IF K700-CDE-OWNER-STATUS2 = 'E' OR 'A' OR 'P'                  
                    IF WS-TAG-ADMIN = 'L'                                       
                       NEXT SENTENCE                                            
                    ELSE                                                        
                       MOVE 'A' TO WS-TAG-ADMIN                                 
                 ELSE                                                           
                    MOVE 'L' TO WS-TAG-ADMIN                                    
                    MOVE 'Y' TO WS-LESSEE-2                                     
              ELSE                                                              
                IF K080-NUM-UIN = K700-NUM-UIN3                                 
                   IF K700-CDE-OWNER-STATUS3 = 'E' OR 'A' OR 'P'                
                      IF WS-TAG-ADMIN = 'L'                                     
                         NEXT SENTENCE                                          
                      ELSE                                                      
                         MOVE 'A' TO WS-TAG-ADMIN                               
                   ELSE                                                         
                      MOVE 'L' TO WS-TAG-ADMIN                                  
                      MOVE 'Y' TO WS-LESSEE-3                                   
                ELSE                                                            
                   IF K080-NUM-UIN = K700-NUM-UIN4                              
                      IF K700-CDE-OWNER-STATUS4 = 'E' OR 'A' OR 'P'             
                         IF WS-TAG-ADMIN = 'L'                                  
                            NEXT SENTENCE                                       
                         ELSE                                                   
                            MOVE 'A' TO WS-TAG-ADMIN                            
                      ELSE                                                      
                         MOVE 'L' TO WS-TAG-ADMIN                               
                         MOVE 'Y' TO WS-LESSEE-4.                               
                                                                                
       330-EXIT.                                                                
           EXIT.                                                                
                                                                                
       340-MOVE-MULTIPLE-REC.                                                   
                                                                                
           ADD 1 TO WS-MULTIPLE-REC.                                            
           ADD 1 TO WS-F559-SUB.                                                
           ADD 1 TO WS-STORE.                                                   
           MOVE BP13F558-REC     TO WS-HOUSEHOLD-REC(WS-F559-SUB).              
           MOVE K700-NUM-HDB-REF TO                                             
                                  WS-F559-NUM-HDB-REF-SMS(WS-F559-SUB).         
           MOVE K030-DTE-TRSF     TO WS-F559-DTE-TRSF-SMS(WS-F559-SUB).         
           MOVE K030-CDE-SALES-TYP TO                                           
                       WS-F559-CDE-SALES-TYPE-SMS(WS-F559-SUB).                 
                                                                                
           IF K030-DTE-EXE-SALE-AGRMT = SPACES OR LOW-VALUES                    
                                                                                
            MOVE  K030-DTE-SALE-EFF TO                                          
                       WS-F559-DTE-FLAT-SOLD-SMS(WS-F559-SUB)                   
            ELSE                                                                
            MOVE K030-DTE-EXE-SALE-AGRMT TO                                     
                       WS-F559-DTE-FLAT-SOLD-SMS(WS-F559-SUB)                   
            END-IF.                                                             
                                                                                
           MOVE K700-NUM-UIN1 TO WS-F559-UIN-SMS1(WS-F559-SUB).                 
           MOVE K700-NUM-UIN2 TO WS-F559-UIN-SMS2(WS-F559-SUB).                 
           MOVE K700-NUM-UIN3 TO WS-F559-UIN-SMS3(WS-F559-SUB).                 
           MOVE K700-NUM-UIN4 TO WS-F559-UIN-SMS4(WS-F559-SUB).                 
           MOVE K030-CDE-ACCT-STAT TO                                           
                                 WS-F559-ACCT-SMS(WS-F559-SUB).                 
                                                                                
                                                                                
       340-EXIT.                                                                
           EXIT.                                                                
                                                                                
       350-UPD-CDE-HOUSEHOLD.                                                   
           MOVE 'Y' TO WS-TAG-WRITE.                                            
                                                                                
           IF WS-LESSEE-1 = 'Y'                                                 
              MOVE '1' TO F558-NUM-LESSEE-SMS                                   
           ELSE                                                                 
           IF WS-LESSEE-2 = 'Y'                                                 
              MOVE '2' TO F558-NUM-LESSEE-SMS                                   
           ELSE                                                                 
           IF WS-LESSEE-3 = 'Y'                                                 
              MOVE '3' TO F558-NUM-LESSEE-SMS                                   
           ELSE                                                                 
           IF WS-LESSEE-4 = 'Y'                                                 
              MOVE '4' TO F558-NUM-LESSEE-SMS                                   
           END-IF.                                                              
                                                                                
           PERFORM 370-CHECK-SOLE-LESSEE THRU 370-EXIT.                         
           MOVE 'S'               TO F558-CDE-FILE.                             
           MOVE 'G'               TO F558-CDE-HOUSEHOLD.                        
           MOVE K700-NUM-HDB-REF  TO F558-NUM-HDB-REF-SMS.                      
           MOVE WS-TAG-ADMIN      TO F558-CDE-OWNER-STATUS.                     
           PERFORM 380-MOVE-DATE THRU 380-EXIT.                                 
                                                                                
           IF   WS-TAG-ADMIN = 'L'                                              
                PERFORM 340-MOVE-MULTIPLE-REC THRU 340-EXIT                     
           END-IF.                                                              
                                                                                
           IF F558-NUM-HDB-REF-SMS = F558-NUM-HDB-REF-RSL                       
              ADD 1 TO WS-GRANT-CNT                                             
           ELSE                                                                 
              MOVE WS-RSL-ADDRESS TO BP13F558-REC(550:50)                       
              WRITE P13F558O-REC FROM BP13F558-REC                              
              ADD 1 TO WS-F558O-WRITE                                           
           END-IF.                                                              
                                                                                
       350-EXIT.                                                                
           EXIT.                                                                
                                                                                
       360-WRITE-NON-CURRENT.                                                   
           IF WS-TAG-WRITE = 'N'                                                
              ADD 1 TO WS-MR-NOT-CURRENT-CNT                                    
           END-IF.                                                              
                                                                                
       360-EXIT.                                                                
           EXIT.                                                                
                                                                                
       370-CHECK-SOLE-LESSEE.                                                   
           IF K700-NUM-UIN2 = SPACES OR LOW-VALUES                              
              MOVE 'Y' TO F558-CDE-SOLE-LESSEE                                  
           END-IF.                                                              
                                                                                
       370-EXIT.                                                                
           EXIT.                                                                
                                                                                
       380-MOVE-DATE.                                                           
           MOVE K030-DTE-TRSF      TO  F558-DTE-TRSF-SMS.                       
           MOVE K030-CDE-SALES-TYP TO  F558-CDE-SALES-TYPE-SMS.                 
           MOVE K030-CDE-ALLOC-SCH TO  F558-NUM-ALLOC-SCH-SMS.                  
                                                                                
           IF K030-DTE-EXE-SALE-AGRMT = SPACES OR LOW-VALUES                    
              MOVE K030-DTE-SALE-EFF TO F558-DTE-FLAT-SOLD-SMS                  
           ELSE                                                                 
              MOVE K030-DTE-EXE-SALE-AGRMT TO F558-DTE-FLAT-SOLD-SMS            
           END-IF.                                                              
                                                                                
           PERFORM 390-CHECK-CURR-FLAT-ADDR THRU 390-EXIT.                      
           PERFORM 400-CHECK-EX-FLAT-ADDR   THRU 400-EXIT.                      
                                                                                
       380-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *--------------------------------------------------------*                
       390-CHECK-CURR-FLAT-ADDR.                                                
      *--------------------------------------------------------*                
                                                                                
           MOVE SPACES                    TO BP13COMM8-REC.                     
           INITIALIZE                        BP13COMM8-REC.                     
                                                                                
           MOVE F558-NUM-HDB-REF-SMS(1:9) TO WS-LINK-NUM-SCH-ACC.               
                                                                                
           CALL 'BP13C913'  USING WS-LINK-REC,                                  
                                  BP13COMM8-REC.                                
                                                                                
           EVALUATE COMM8-CDE-SYSERR                                            
              WHEN 00                                                           
                   MOVE COMM8-NUM-BLK TO F558-NUM-BLK                           
                   MOVE COMM8-NME-STREET TO F558-NME-STREET                     
                   MOVE COMM8-NUM-POSTAL-CODE TO F558-NUM-POSTAL-DSTRCT         
                   MOVE COMM8-NUM-LEVEL       TO F558-NUM-LVL                   
                   MOVE COMM8-NUM-UNIT-MAIN   TO F558-NUM-UNIT(1:4)             
                   MOVE COMM8-NUM-UNIT-SUB    TO F558-NUM-UNIT(5:1)             
              WHEN 100                                                          
                   MOVE SPACES                TO F558-SMS-ADDRESS               
              WHEN OTHER                                                        
                   DISPLAY 'ERROR READING PIDB TABLE ' COMM8-CDE-SYSERR         
           END-EVALUATE.                                                        
                                                                                
       390-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *--------------------------------------------------------*                
       400-CHECK-EX-FLAT-ADDR.                                                  
      *--------------------------------------------------------*                
                                                                                
           MOVE SPACES                    TO BP13COMM8-REC.                     
           INITIALIZE                        BP13COMM8-REC.                     
                                                                                
           MOVE F558-NUM-HDB-REF-RSL(1:9) TO WS-LINK-NUM-SCH-ACC.               
                                                                                
           CALL 'BP13C913'  USING WS-LINK-REC,                                  
                                  BP13COMM8-REC.                                
                                                                                
           EVALUATE COMM8-CDE-SYSERR                                            
              WHEN 00                                                           
                   MOVE COMM8-NUM-BLK         TO WS-RSL-NUM-BLK                 
                   MOVE COMM8-NME-STREET      TO WS-RSL-NME-STREET              
                   MOVE COMM8-NUM-POSTAL-CODE TO WS-RSL-NUM-POSTAL              
                   MOVE COMM8-NUM-LEVEL       TO WS-RSL-NUM-LEVEL               
                   MOVE COMM8-NUM-UNIT-MAIN   TO WS-RSL-NUM-UNIT(1:4)           
                   MOVE COMM8-NUM-UNIT-SUB    TO WS-RSL-NUM-UNIT(5:1)           
              WHEN 100                                                          
                   MOVE SPACES                TO WS-RSL-ADDRESS                 
              WHEN OTHER                                                        
                   DISPLAY 'ERROR READING EX ADDRESS ' COMM8-CDE-SYSERR         
           END-EVALUATE.                                                        
                                                                                
       400-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
       900-CLOSE-ROUTINE.                                                       
           MOVE FUNCTION CURRENT-DATE             TO  WS-CUR-DATE.              
                                                                                
           DISPLAY 'BP13U706                    DATE : ' WS-CUR-DATE.           
           DISPLAY 'MATCH NRIC IN REQUEST FILE WITH SMS MASTER'.                
           DISPLAY '*----------------------------------------*'.                
           DISPLAY '1) NO OF RECORDS READ FROM F558 ' WS-F558-READ.             
           DISPLAY '2) NO OF RECORDS NOT MATCH      ' WS-NMR-NRIC.              
           DISPLAY '3) NO OF RECORDS MATCH          ' WS-MR-NRIC.               
           DISPLAY '   A)  MATCH NRIC NOT CURRENT   '                           
                                       WS-MR-NOT-CURRENT-CNT.                   
           DISPLAY '   B)  BY PASS DUE TO GRNAT     '                           
                                       WS-GRANT-CNT.                            
           DISPLAY ' '.                                                         
           DISPLAY '4) NO OF RECORDS F558O WRITE    ' WS-F558O-WRITE.           
           DISPLAY '5) NO OF RECORDS F558A WRITE    '                           
           DISPLAY '   A) K030 NOT FOUND            ' WS-K030-NOTFND.           
           DISPLAY '   B) NRIC NOT MATCH            ' WS-NMR-NRIC.              
           DISPLAY '   C) NRIC MR BUT TAKE GRANT    ' WS-GRANT-CNT.             
           DISPLAY '   D) NRIC MR BUT NOT CURRENT   '                           
                                                WS-MR-NOT-CURRENT-CNT.          
           DISPLAY '6) NO OF RECORDS F559  WRITE    ' WS-MULTIPLE-CNT.          
           DISPLAY ' '.                                                         
                                                                                
           CLOSE P13F558O                                                       
                 BP13F559                                                       
                 BP13F558                                                       
                 AB03K700                                                       
                 AB03K030                                                       
                 AB03K080.                                                      
                                                                                
           IF  AB03K080-STATUS NOT = ZEROS AND 97                               
               DISPLAY 'CLOSING ERROR '                                         
               DISPLAY 'AB03K080-STATUS ' AB03K080-STATUS.                      
                                                                                
           IF  AB03K700-STATUS NOT = ZEROS AND 97                               
               DISPLAY 'CLOSING ERROR '                                         
               DISPLAY 'AB03K700-STATUS ' AB03K700-STATUS.                      
                                                                                
           IF  AB03K030-STATUS NOT = ZEROS AND 97                               
               DISPLAY 'CLOSING ERROR '                                         
               DISPLAY 'AB03K030-STATUS ' AB03K030-STATUS.                      
                                                                                
           STOP RUN.                                                            
                                                                                
       900-EXIT.                                                                
           EXIT.                                                                
