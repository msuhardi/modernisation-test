      *------------------------*                                                
       IDENTIFICATION DIVISION.                                                 
      *------------------------*                                                
       PROGRAM-ID.    BP13C36B.                                                 
      *AUTHOR.        ALWYN BENNY.                                              
      *DATE-WRITTEN.  30/06/2011.                                               
                                                                                
      * =========================================================== *           
      * SYSTEM OF COMMITMENT (BP13)                                 *           
      * =========================================================== *           
      *   OBJECTIVE   : THIS PROGRAM VALIDATE TRANSACTIONS PASSSED  *           
      *                 FROM PAYMENT SYSTEM TO PROCESS AMR CASE     *           
      *                                                             *           
      *   INPUT FILES :                                             *           
      *   1.  BP13K350                                                          
      *   2.  BP13K352                                                          
      *   3.  AG07F630 -- VOUCHER TRANSACTION FILE                  *           
      *                                                             *           
      *   OUTPUT FILES:                                             *           
      *   1.  BP13K130 -- EDITED FIRST TRANSACTION FILE             *           
      *   2.  BP13K140 -- KIV FILE                                  *           
      *   3.  BP13L36B -- CONTROL LISTING                           *           
      *                                                             *           
      *                                                             *           
      * REF      DATE      BY   DESCRIPTIONS                        *           
      * -------  --------  ---- ------------                        *           
      * BP134276 30/06/11  AB9  NEW PROGRAM.                        *           
      * BP134302 25/08/11  AB9  INCLUDE 'T' FOR CDE-PRINT.          *           
      *                         CHK K140-AMT IS NUMERIC.            *           
      * BP134355 29/08/11  AB9  CATER FOR 'ADPS' TRANS-TYP          *           
      * BP134873 04/07/13  ESD1 ADD CHECKING OF NUMERIC VALUES      *           
      * BP137044 22/11/17  RJB1 TO READ BM06K115 IF NOT FND IN K110 *           
      * BP137100 05/12/17  RJB1 TO FIX ISSUE ON WRITING TO K352     *           
      *                         INSTEAD OF K350 AND TO READ K893 IF *           
      *                         NOT FOUND IN K800                   *           
      * BP137159 08/01/18  RJB1 TO ADD CHECKING OF F630-NUM-BATCH-TYPE          
      *                         IN PARAGRAPH 360-ADV-AMT-STUDIO     *           
      * =========================================================== *           
                                                                                
      *------------------------*                                                
       ENVIRONMENT DIVISION.                                                    
      *------------------------*                                                
       CONFIGURATION SECTION.                                                   
      *------------------------*                                                
                                                                                
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
      *------------------------*                                                
       INPUT-OUTPUT SECTION.                                                    
      *------------------------*                                                
       FILE-CONTROL.                                                            
      *------------------------*                                                
                                                                                
                                                                                
           SELECT BP13K350 ASSIGN         TO BP13K350                           
                           ACCESS MODE       IS RANDOM                          
                           ORGANIZATION      IS INDEXED                         
                           RECORD KEY        IS K350-KEY-FLD                    
                           FILE STATUS       IS BP13K350-STATUS.                
                                                                                
           SELECT BP13K352 ASSIGN         TO BP13K352                           
                           ACCESS MODE       IS RANDOM                          
                           ORGANIZATION      IS INDEXED                         
                           RECORD KEY        IS K352-KEY-FLD                    
                           FILE STATUS       IS BP13K352-STATUS.                
                                                                                
           SELECT BP13K130 ASSIGN         TO BP13K130                           
                           ACCESS MODE    IS DYNAMIC                            
                           ORGANIZATION   IS INDEXED                            
                           RECORD KEY     IS K130-KEY-FLD                       
                           FILE STATUS    IS BP13K130-STATUS.                   
                                                                                
           SELECT BP13K140 ASSIGN         TO BP13K140                           
                           ACCESS MODE       IS RANDOM                          
                           ORGANIZATION      IS INDEXED                         
                           RECORD KEY        IS K140-KEY-FLD                    
                           FILE STATUS       IS BP13K140-STATUS.                
                                                                                
           SELECT BM06K110  ASSIGN        TO BM06K110                           
                            ACCESS MODE   IS RANDOM                             
                            ORGANIZATION  IS INDEXED                            
                            RECORD KEY    IS K110-KEY-FLD                       
                            FILE STATUS   IS BM06K110-STATUS.                   
                                                                                
           SELECT BM06K115  ASSIGN        TO BM06K115                           
                            ACCESS MODE   IS RANDOM                             
                            ORGANIZATION  IS INDEXED                            
                            RECORD KEY    IS K115-KEY-FLD                       
                            FILE STATUS   IS BM06K115-STATUS.                   
                                                                                
           SELECT BP13K800  ASSIGN        TO BP13K800                           
                            ACCESS MODE   IS RANDOM                             
                            ORGANIZATION  IS INDEXED                            
                            RECORD KEY    IS K800-NUM-REGN                      
                            FILE STATUS   IS BP13K800-STATUS.                   
                                                                                
           SELECT BP13K893  ASSIGN        TO BP13K893                           
                            ACCESS MODE   IS DYNAMIC                            
                            ORGANIZATION  IS INDEXED                            
                            RECORD KEY    IS K893-KEY-FLD                       
                            FILE STATUS   IS BP13K893-STATUS.                   
                                                                                
           SELECT AG07F630 ASSIGN TO AG07F630.                                  
                                                                                
           SELECT BP13F360 ASSIGN TO BP13F360.                                  
                                                                                
           SELECT BP13L36B ASSIGN TO BP13L36B.                                  
                                                                                
                                                                                
      *------------------------*                                                
       DATA DIVISION.                                                           
      *------------------------*                                                
       FILE SECTION.                                                            
      *------------------------*                                                
                                                                                
                                                                                
       FD   AG07F630                                                    00150000
            BLOCK CONTAINS   0  RECORDS                                         
            RECORD CONTAINS 130  CHARACTERS                                     
            LABEL RECORD IS STANDARD                                            
            RECORDING MODE IS F.                                                
       COPY AG07F630.                                                   00150000
                                                                                
       FD  BP13K350                                                             
           RECORD CONTAINS 600 CHARACTERS.                                      
       COPY BP13K350.                                                           
                                                                                
       FD  BP13K352                                                             
           RECORD CONTAINS 600 CHARACTERS.                                      
       COPY BP13K352.                                                           
                                                                                
       FD   BM06K110                                                            
            RECORD CONTAINS 500 CHARACTERS.                                     
       COPY BM06K110.                                                           
                                                                                
       FD   BM06K115                                                            
            RECORD CONTAINS 500 CHARACTERS.                                     
       COPY BM06K115.                                                           
                                                                                
       FD  BP13K130                                                             
           RECORD CONTAINS 150 CHARACTERS.                                      
       COPY BP13K130.                                                           
                                                                                
       FD  BP13K140                                                             
           RECORD CONTAINS 150 CHARACTERS.                                      
       COPY BP13K140.                                                           
                                                                                
       FD   BP13K800                                                            
            RECORD CONTAINS 2000 CHARACTERS.                                    
       COPY BP13K800.                                                           
                                                                                
       FD   BP13K893                                                            
            RECORD CONTAINS 2050 CHARACTERS.                                    
       COPY BP13K893.                                                           
                                                                                
       FD BP13F360                                                              
            RECORD CONTAINS  160  CHARACTERS                                    
            LABEL RECORD IS STANDARD                                            
            RECORDING MODE IS F.                                                
       COPY BP13F360.                                                   00150000
                                                                                
       FD  BP13L36B                                                             
           RECORD CONTAINS 132 CHARACTERS                                       
           LABEL RECORDS ARE OMITTED                                            
           RECORDING MODE IS F.                                                 
       01  PRINT-REC                 PIC X(132).                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       WORKING-STORAGE SECTION.                                                 
      *-------------------------------------------------------------            
                                                                                
       COPY P13COMM8.                                                           
                                                                                
       01  WS-VARIABLES.                                                        
           05  WS-COUNT-HISTORY           PIC 9(3)       VALUE ZEROS.           
           05  WS-CDE-ERROR               PIC X          VALUE SPACES.          
                                                                                
       01  WS-LINE-CNT                    PIC 99         VALUE 66.              
       01  WS-PAGE-CNT                    PIC 9(5)       VALUE ZERO.            
       01  CNT-KIV-CASES                  PIC 9(4)       VALUE ZERO.            
       01  WS-AMT-KIV-TOTAL               PIC 9(6)V99    VALUE ZEROES.          
       01  WS-DTE-CUR.                                                          
           05  WS-CC                      PIC 99.                               
           05  WS-YY                      PIC 99.                               
           05  WS-MM                      PIC 99.                               
           05  WS-DD                      PIC 99.                               
                                                                                
       01  WS-TRANS-DATE.                                                       
           05  WS-TRANS-YYYY              PIC 9(4).                             
           05  WS-TRANS-MM                PIC 9(2).                             
           05  WS-TRANS-DD                PIC 9(2).                             
                                                                                
                                                                                
       01  WS-FILE-STATUS.                                                      
           05  BP13K130-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BP13K140-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BP13K350-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BP13K352-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BM06K110-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BM06K115-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BP13K800-STATUS            PIC 9(2)       VALUE ZEROES.          
           05  BP13K893-STATUS            PIC 9(2)       VALUE ZEROES.          
                                                                                
       01  WS-COUNTERS.                                                         
           05  WS-K130-WRITE              PIC 9(5)       VALUE ZEROES.          
           05  WS-K140-WRITE              PIC 9(5)       VALUE ZEROES.          
           05  WS-K350-WRITE              PIC 9(5)       VALUE ZEROES.          
           05  WS-K352-WRITE              PIC 9(5)       VALUE ZEROES.          
           05  WS-F360-WRITE              PIC 9(5)       VALUE ZEROES.          
           05  WS-K110-READ               PIC 9(5)       VALUE ZEROES.          
           05  WS-K110-NOTFD              PIC 9(5)       VALUE ZEROES.          
           05  WS-K350-READ               PIC 9(5)       VALUE ZEROES.          
           05  WS-K352-READ               PIC 9(5)       VALUE ZEROES.          
           05  WS-K800-READ               PIC 9(5)       VALUE ZEROES.          
           05  WS-K800-NOTFD              PIC 9(5)       VALUE ZEROES.          
           05  WS-CNT-F630-READ           PIC 9(5)       VALUE ZEROES.          
           05  WS-CNT-HIST                PIC 9(2)       VALUE ZEROES.          
                                                                                
       01  WS-SWITCHES.                                                         
           05  WS-F630-EOF                PIC X          VALUE 'N'.             
           05  WS-K893-EOF                PIC X          VALUE 'N'.             
           05  WS-K130-WRITTEN            PIC X          VALUE SPACE.           
           05  WS-K140-WRITTEN            PIC X          VALUE SPACE.           
           05  WS-K350-WRITTEN            PIC X          VALUE SPACE.           
           05  WS-K352-WRITTEN            PIC X          VALUE SPACE.           
           05  WS-K110-REC-FND            PIC X          VALUE SPACES.          
           05  WS-K800-REC-FND            PIC X          VALUE SPACES.          
           05  WS-K350-FOUND              PIC X          VALUE 'N'.             
           05  WS-K352-FOUND              PIC X          VALUE 'N'.             
                                                                                
       01  WS-SCH-TAG                     PIC X          VALUE 'N'.             
       01  WS-AMT-TALLY                   PIC X          VALUE 'N'.             
       01  WS-TOTAL-AMT            PIC S9(7)V99 VALUE +0.                       
       01  WS-DIFF                 PIC S9(7)V9(2)  VALUE +0.                    
                                                                                
       01  WS-SCHEDULE-NO.                                                      
           05  WS-SCHEDULE-NUM     PIC X(8).                                    
           05  WS-DOC-NO           PIC X(6).                                    
                                                                                
       01  L36B-PR-HEAD-01.                                                     
           05  FILLER              PIC X(8)      VALUE 'BP13L36B'.              
           05  FILLER              PIC X(5)      VALUE SPACES .                 
           05  FILLER              PIC X(8)      VALUE 'HDBCAT 3'.              
           05  FILLER              PIC X(24)     VALUE SPACES.                  
           05  FILLER              PIC X(39)     VALUE                          
               'S Y S T E M   O F   C O M M I T M E N T'.                       
           05  FILLER              PIC X(17)     VALUE SPACES.                  
           05  FILLER              PIC X(6)      VALUE 'DATE: '.                
           05  13S1-DATE           PIC X(10).                                   
           05  FILLER              PIC X(3)      VALUE SPACES.                  
           05  FILLER              PIC X(6)      VALUE 'PAGE :'.                
           05  13S1-PAGE           PIC ZZ9 .                                    
                                                                                
       01  L36B-PR-HEAD-02.                                                     
           05  FILLER              PIC X(40)     VALUE SPACES .                 
           05  FILLER              PIC X(40)     VALUE                          
               '  ERROR LIST OF TRANSACTIONS PASSED FROM'.                      
           05  FILLER              PIC X(13)     VALUE                          
                                                 ' VOUCHER FILE'.               
           05  FILLER              PIC X(40)     VALUE SPACES.                  
                                                                                
       01  L36B-PR-HEAD-03.                                                     
           05  FILLER              PIC X(27)                                    
                  VALUE ' S/NO REGN NO   SCH ACC    '.                          
           05  FILLER              PIC X(34)                                    
                  VALUE ' AMOUNT  FLAT-TY  DR/CR RECEIPT NO'.                   
           05  FILLER              PIC X(28)                                    
                  VALUE '    TRANS DATE  SALES MODE'.                           
           05  FILLER              PIC X(21)                                    
                  VALUE ' PAY-TYP   REMARK'.                                    
           05  FILLER              PIC X(22)     VALUE SPACES.                  
                                                                                
       01  L36B-PR-DETAILS.                                                     
           05  FILLER              PIC X(01)     VALUE SPACES .                 
           05  13S1-SNO            PIC ZZZZ9.                                   
           05  FILLER              PIC X(01)     VALUE SPACES .                 
           05  13S1-REG-NO         PIC X(08).                                   
           05  FILLER              PIC X(01)     VALUE SPACES .                 
           05  13S1-SCH-ACC        PIC X(11)     VALUE SPACES.                  
           05  13S1-AMT            PIC $$$$$$$9.99DB.                           
           05  FILLER              PIC X(01)     VALUE SPACES .                 
           05  13S1-FLAT-TYP       PIC X(02).                                   
           05  FILLER              PIC X(03)     VALUE SPACES .                 
           05  13S1-DRCR           PIC X(01).                                   
           05  FILLER              PIC X(04)     VALUE SPACES .                 
           05  13S1-NUM-RECEIPT    PIC X(14) .                                  
           05  FILLER              PIC X(02)     VALUE SPACES.                  
           05  13S1-DTE-TRANS      PIC X(08) .                                  
           05  FILLER              PIC X(05)     VALUE SPACES .                 
           05  13S1-SALES-MODE     PIC X(03).                                   
           05  FILLER              PIC X(07)     VALUE SPACES .                 
           05  13S1-PAY-TYPE       PIC X(03).                                   
           05  FILLER              PIC X(03)     VALUE SPACES .                 
           05  13S1-REMARK         PIC X(38).                                   
                                                                                
       01  L36B-CONTROL-LINE.                                                   
           05  FILLER              PIC X(20)     VALUE  SPACES.                 
           05  CNTL-ITEM           PIC X(30)     VALUE  SPACES.                 
           05  CNTL-CNT            PIC ZZZZ9 .                                  
           05  FILLER              PIC X(58)     VALUE  SPACES.                 
                                                                                
                                                                                
      *-------------------------------------------------------------            
       PROCEDURE DIVISION.                                                      
      *-------------------------------------------------------------            
                                                                                
      *-------------------------------------------------------------            
       000-MAIN-ROUTINE.                                                        
      *-------------------------------------------------------------            
           PERFORM 100-OPEN-FILES       THRU 100-EXIT.                          
           PERFORM 200-READ-AG07F630    THRU 200-EXIT.                          
           PERFORM 300-VALIDATE-VOUCHER THRU 300-EXIT                           
                   UNTIL WS-F630-EOF = 'Y'.                                     
           PERFORM 999-CLOSE-FILES      THRU 999-EXIT.                          
       000-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       100-OPEN-FILES.                                                          
      *-------------------------------------------------------------            
           OPEN   INPUT  AG07F630                                               
                         BM06K110                                               
                         BM06K115                                               
                         BP13K800                                               
                         BP13K893                                               
                  I-O    BP13K140                                               
                         BP13K130                                               
                         BP13K350                                               
                         BP13K352                                               
                  OUTPUT BP13L36B                                               
                         BP13F360.                                              
                                                                                
           IF BP13K350-STATUS NOT = 0   AND  97                                 
               DISPLAY 'ERROR OPENING - BP13K350 : ' BP13K350-STATUS            
               MOVE BP13K350-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BP13K352-STATUS NOT = 0   AND  97                                 
               DISPLAY 'ERROR OPENING - BP13K352 : ' BP13K352-STATUS            
               MOVE BP13K352-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BP13K130-STATUS NOT = 0   AND  97                                 
               DISPLAY 'ERROR OPENING - BP13K130 : ' BP13K130-STATUS            
               MOVE BP13K130-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BP13K140-STATUS NOT = ZEROS   AND  97                             
               DISPLAY 'ERROR OPENING - BP13K140 : ' BP13K140-STATUS            
               MOVE BP13K140-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BM06K110-STATUS NOT = ZEROS   AND  97                             
               DISPLAY 'ERROR OPENING - BM06K110 : ' BM06K110-STATUS            
               MOVE BM06K110-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BM06K115-STATUS NOT = ZEROS   AND  97                             
               DISPLAY 'ERROR OPENING - BM06K115 : ' BM06K115-STATUS            
               MOVE BM06K115-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BP13K800-STATUS NOT = ZEROS   AND  97                             
               DISPLAY 'ERROR OPENING - BP13K800 : ' BP13K800-STATUS            
               MOVE BP13K800-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           IF BP13K893-STATUS NOT = ZEROS   AND  97                             
               DISPLAY 'ERROR OPENING - BP13K893 : ' BP13K893-STATUS            
               MOVE BP13K893-STATUS TO RETURN-CODE                              
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
           MOVE FUNCTION CURRENT-DATE TO WS-DTE-CUR.                            
           STRING WS-DTE-CUR(7:2) '/' WS-DTE-CUR(5:2) '/'               )       
                  WS-DTE-CUR(1:4)                                               
              DELIMITED BY SIZE INTO 13S1-DATE.                                 
                                                                                
       100-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       200-READ-AG07F630.                                                       
      *-------------------------------------------------------------            
           READ AG07F630                                                        
                AT END                                                          
                MOVE HIGH-VALUES TO AG07F630-REC                                
                MOVE 'Y' TO  WS-F630-EOF                                        
                GO TO 200-EXIT.                                                 
           ADD 1 TO WS-CNT-F630-READ.                                           
                                                                                
       200-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      **********************************************************                
      *              VALIDATE TRANSACTION  CASES               *                
      *                                                        *                
      * IF FOUND, WRITE VOUCHER TARNS ELSE WRITE KIV FILE      *                
      **********************************************************                
      *-------------------------------------------------------------            
       300-VALIDATE-VOUCHER.                                                    
      *-------------------------------------------------------------            
                                                                                
           MOVE 'N'   TO WS-K350-FOUND WS-K352-FOUND.                           
           IF F630-AMT-TRANS         IS NOT NUMERIC                             
              MOVE ZEROS             TO F630-AMT-TRANS                          
           END-IF.                                                              
           MOVE ZEROS TO WS-DIFF  WS-TOTAL-AMT.                                 
           PERFORM  305-READ-BM06K110          THRU    305-EXIT.                
           PERFORM  200-READ-AG07F630          THRU    200-EXIT.                
                                                                                
       300-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       305-READ-BM06K110.                                                       
      *-------------------------------------------------------------            
                                                                                
           MOVE SPACES                    TO  K110-REC.                         
           MOVE F630-NUM-HDB-REF          TO K110-KEY-FLD.                      
           READ BM06K110.                                                       
                                                                                
           EVALUATE BM06K110-STATUS                                             
              WHEN 00                                                           
                   PERFORM 375-READ-K800       THRU   375-EXIT                  
              WHEN 23                                                           
                   PERFORM 306-READ-K115       THRU   306-EXIT                  
              WHEN OTHER                                                        
                   MOVE BM06K110-STATUS    TO RETURN-CODE                       
                   DISPLAY 'ERROR READING BM06K110, STATUS = '                  
                                          BM06K110-STATUS                       
                   PERFORM 999-CLOSE-FILES THRU 999-EXIT                        
           END-EVALUATE.                                                        
                                                                                
       305-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       306-READ-K115.                                                           
      *-------------------------------------------------------------            
                                                                                
           MOVE SPACES                    TO  K115-REC.                         
           MOVE F630-NUM-HDB-REF          TO  K115-KEY-FLD.                     
           READ BM06K115.                                                       
                                                                                
           EVALUATE BM06K115-STATUS                                             
              WHEN 00                                                           
                   MOVE K115-REC          TO  K110-REC                          
                   PERFORM 375-READ-K800            THRU    375-EXIT            
              WHEN 23                                                           
                   ADD  1             TO WS-K110-NOTFD                          
                   DISPLAY 'REC NOTFD IN BM06K110. KEY ' K115-KEY-FLD           
                   MOVE 'A'           TO WS-CDE-ERROR                           
                   PERFORM  350-WRITE-BP13K140      THRU    350-EXIT            
                   PERFORM  800-ERROR-LIST          THRU    800-EXIT            
              WHEN OTHER                                                        
                   MOVE BM06K115-STATUS    TO RETURN-CODE                       
                   DISPLAY 'ERROR READING BM06K115, STATUS = '                  
                                          BM06K115-STATUS                       
                   PERFORM 999-CLOSE-FILES THRU 999-EXIT                        
           END-EVALUATE.                                                        
                                                                                
       306-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       310-READ-K350.                                                           
      *-------------------------------------------------------------            
                                                                                
                READ BP13K350                                                   
                EVALUATE BP13K350-STATUS                                        
                WHEN '00'                                                       
                     MOVE 'Y'         TO WS-K350-FOUND                          
                     PERFORM 311-CHECK350-NUMERIC THRU 311-EXIT                 
                     ADD 1 TO WS-K350-READ                                      
                     PERFORM 330-UPDATE-K350    THRU   330-EXIT                 
                WHEN '23'                                                       
                      MOVE 'N'         TO WS-K350-FOUND                         
                      IF F630-NUM-TRANS-DR-CR = 'C'                             
                         PERFORM 610-WRITE-K350  THRU     610-EXIT              
                         PERFORM 400-WRITE-BP13K130   THRU  400-EXIT            
                         PERFORM 550-WRITE-BP13F360   THRU  550-EXIT            
                      ELSE                                                      
                         MOVE 'N'      TO  WS-CDE-ERROR                         
                         PERFORM  350-WRITE-BP13K140   THRU  350-EXIT           
                         PERFORM  800-ERROR-LIST       THRU  800-EXIT           
                      END-IF                                                    
                WHEN OTHER                                                      
                      DISPLAY 'ERROR READING - BP13K350 : '             S       
                                                   BP13K350-STATUS              
                      MOVE  BP13K350-STATUS TO RETURN-CODE                      
                      PERFORM 999-CLOSE-FILES THRU 999-EXIT                     
                END-EVALUATE.                                                   
                                                                                
       310-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       311-CHECK350-NUMERIC.                                                    
      *-------------------------------------------------------------            
             IF K350-AMT-ADV-COLLECTION NOT NUMERIC                             
                MOVE ZEROES TO K350-AMT-ADV-COLLECTION                          
             END-IF.                                                            
                                                                                
             IF K350-AMT-MEDISAVE-TOPUP NOT NUMERIC                             
                MOVE ZEROES TO K350-AMT-MEDISAVE-TOPUP                          
             END-IF.                                                            
                                                                                
             IF K350-AMT-MEDISAVE-TOPUP-HA2 NOT NUMERIC                         
                MOVE ZEROES TO K350-AMT-MEDISAVE-TOPUP-HA2                      
             END-IF.                                                            
                                                                                
             IF K350-AMT-MEDISAVE-TOPUP-HA3 NOT NUMERIC                         
                MOVE ZEROES TO K350-AMT-MEDISAVE-TOPUP-HA3                      
             END-IF.                                                            
                                                                                
             IF K350-AMT-MEDISAVE-TOPUP-HA4 NOT NUMERIC                         
                MOVE ZEROES TO K350-AMT-MEDISAVE-TOPUP-HA4                      
             END-IF.                                                            
                                                                                
             IF K350-AMT-MEDISAVE-TOPUP-FU1 NOT NUMERIC                         
                MOVE ZEROES TO K350-AMT-MEDISAVE-TOPUP-FU1                      
             END-IF.                                                            
                                                                                
             IF K350-AMT-MEDISAVE-TOPUP-FU2 NOT NUMERIC                         
                MOVE ZEROES TO K350-AMT-MEDISAVE-TOPUP-FU2                      
             END-IF.                                                            
                                                                                
             IF K350-AMT-ADV-COLLECTION-TOPUP NOT NUMERIC                       
                MOVE ZEROES TO K350-AMT-ADV-COLLECTION-TOPUP                    
             END-IF.                                                            
                                                                                
             IF K350-AMT-RLEVY-HA1 NOT NUMERIC                                  
                MOVE ZEROES TO K350-AMT-RLEVY-HA1                               
             END-IF.                                                            
                                                                                
             IF K350-AMT-CONTRA-HA1 NOT NUMERIC                                 
                MOVE ZEROES TO K350-AMT-CONTRA-HA1                              
             END-IF.                                                            
                                                                                
             IF K350-AMT-RLEVY-HA2 NOT NUMERIC                                  
                MOVE ZEROES TO K350-AMT-RLEVY-HA2                               
             END-IF.                                                            
                                                                                
             IF K350-AMT-CONTRA-HA2 NOT NUMERIC                                 
                MOVE ZEROES TO K350-AMT-CONTRA-HA2                              
             END-IF.                                                            
                                                                                
             IF K350-AMT-BAL-SELL-PRICE NOT NUMERIC                             
                MOVE ZEROES TO K350-AMT-BAL-SELL-PRICE                          
             END-IF.                                                            
                                                                                
             IF K350-AMT-CD-PAID NOT NUMERIC                                    
                MOVE ZEROES TO K350-AMT-CD-PAID                                 
             END-IF.                                                            
                                                                                
             IF K350-AMT-REFUND-CD NOT NUMERIC                                  
                MOVE ZEROES TO K350-AMT-REFUND-CD                               
             END-IF.                                                            
                                                                                
             IF K350-AMT-REFUND-BK NOT NUMERIC                                  
                MOVE ZEROES TO K350-AMT-REFUND-BK                               
             END-IF.                                                            
                                                                                
             IF K350-AMT-REFUND-ADV-COL NOT NUMERIC                             
                MOVE ZEROES TO K350-AMT-REFUND-ADV-COL                          
             END-IF.                                                            
                                                                                
             IF K350-AMT-ADV-COLLECTION-USED NOT NUMERIC                        
                MOVE ZEROES TO K350-AMT-ADV-COLLECTION-USED                     
             END-IF.                                                            
                                                                                
       311-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       315-READ-K352.                                                           
      *-------------------------------------------------------------            
                                                                                
                READ BP13K352.                                                  
                EVALUATE BP13K352-STATUS                                        
                WHEN '00'                                                       
                     MOVE 'Y'         TO WS-K352-FOUND                          
                     PERFORM 316-CHECK352-NUMERIC THRU 316-EXIT                 
                     ADD 1 TO WS-K352-READ                                      
                     PERFORM 335-UPDATE-K352    THRU    335-EXIT                
                WHEN '23'                                                       
                      MOVE 'N'         TO WS-K352-FOUND                         
                      IF F630-NUM-TRANS-DR-CR = 'C'                             
                         PERFORM 650-WRITE-K352       THRU  650-EXIT            
                         PERFORM 400-WRITE-BP13K130   THRU  400-EXIT            
                         PERFORM 500-WRITE-BP13F360   THRU  500-EXIT            
                      ELSE                                                      
                         MOVE 'N'      TO  WS-CDE-ERROR                         
                         PERFORM  350-WRITE-BP13K140   THRU  350-EXIT           
                         PERFORM  800-ERROR-LIST       THRU  800-EXIT           
                      END-IF                                                    
                WHEN OTHER                                                      
                      DISPLAY 'ERROR READING - BP13K352 : '             S       
                                                   BP13K352-STATUS              
                      MOVE  BP13K352-STATUS TO RETURN-CODE                      
                      PERFORM 999-CLOSE-FILES THRU 999-EXIT                     
                END-EVALUATE.                                                   
                                                                                
       315-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       316-CHECK352-NUMERIC.                                                    
      *-------------------------------------------------------------            
             IF K352-AMT-ADV-COLLECTION NOT NUMERIC                             
                MOVE ZEROES TO K352-AMT-ADV-COLLECTION                          
             END-IF.                                                            
                                                                                
             IF K352-AMT-MEDISAVE-TOPUP NOT NUMERIC                             
                MOVE ZEROES TO K352-AMT-MEDISAVE-TOPUP                          
             END-IF.                                                            
                                                                                
             IF K352-AMT-MEDISAVE-TOPUP-HA2 NOT NUMERIC                         
                MOVE ZEROES TO K352-AMT-MEDISAVE-TOPUP-HA2                      
             END-IF.                                                            
                                                                                
             IF K352-AMT-MEDISAVE-TOPUP-HA3 NOT NUMERIC                         
                MOVE ZEROES TO K352-AMT-MEDISAVE-TOPUP-HA3                      
             END-IF.                                                            
                                                                                
             IF K352-AMT-MEDISAVE-TOPUP-HA4 NOT NUMERIC                         
                MOVE ZEROES TO K352-AMT-MEDISAVE-TOPUP-HA4                      
             END-IF.                                                            
                                                                                
             IF K352-AMT-MEDISAVE-TOPUP-FU1 NOT NUMERIC                         
                MOVE ZEROES TO K352-AMT-MEDISAVE-TOPUP-FU1                      
             END-IF.                                                            
                                                                                
             IF K352-AMT-MEDISAVE-TOPUP-FU2 NOT NUMERIC                         
                MOVE ZEROES TO K352-AMT-MEDISAVE-TOPUP-FU2                      
             END-IF.                                                            
                                                                                
             IF K352-AMT-ADV-COLLECTION-TOPUP NOT NUMERIC                       
                MOVE ZEROES TO K352-AMT-ADV-COLLECTION-TOPUP                    
             END-IF.                                                            
                                                                                
             IF K352-AMT-RLEVY-HA1 NOT NUMERIC                                  
                MOVE ZEROES TO K352-AMT-RLEVY-HA1                               
             END-IF.                                                            
                                                                                
             IF K352-AMT-CONTRA-HA1 NOT NUMERIC                                 
                MOVE ZEROES TO K352-AMT-CONTRA-HA1                              
             END-IF.                                                            
                                                                                
             IF K352-AMT-RLEVY-HA2 NOT NUMERIC                                  
                MOVE ZEROES TO K352-AMT-RLEVY-HA2                               
             END-IF.                                                            
                                                                                
             IF K352-AMT-CONTRA-HA2 NOT NUMERIC                                 
                MOVE ZEROES TO K352-AMT-CONTRA-HA2                              
             END-IF.                                                            
                                                                                
             IF K352-AMT-BAL-SELL-PRICE NOT NUMERIC                             
                MOVE ZEROES TO K352-AMT-BAL-SELL-PRICE                          
             END-IF.                                                            
                                                                                
             IF K352-AMT-CD-PAID NOT NUMERIC                                    
                MOVE ZEROES TO K352-AMT-CD-PAID                                 
             END-IF.                                                            
                                                                                
             IF K352-AMT-REFUND-CD NOT NUMERIC                                  
                MOVE ZEROES TO K352-AMT-REFUND-CD                               
             END-IF.                                                            
                                                                                
             IF K352-AMT-REFUND-BK NOT NUMERIC                                  
                MOVE ZEROES TO K352-AMT-REFUND-BK                               
             END-IF.                                                            
                                                                                
             IF K352-AMT-REFUND-ADV-COL NOT NUMERIC                             
                MOVE ZEROES TO K352-AMT-REFUND-ADV-COL                          
             END-IF.                                                            
                                                                                
             IF K352-AMT-ADV-COLLECTION-USED NOT NUMERIC                        
                MOVE ZEROES TO K352-AMT-ADV-COLLECTION-USED                     
             END-IF.                                                            
                                                                                
       316-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       330-UPDATE-K350.                                                         
      *-------------------------------------------------------------            
                                                                                
              IF (F630-NUM-HDB-REF = K350-NUM-SCH-ACC)                          
                  MOVE    'Y'          TO   WS-SCH-TAG                          
                  PERFORM 360-ADV-AMT-STUDIO  THRU   360-EXIT                   
                  PERFORM 340-MOVE-VALUE-K350  THRU  340-EXIT                   
                  PERFORM 400-WRITE-BP13K130   THRU  400-EXIT                   
                  PERFORM 550-WRITE-BP13F360   THRU  550-EXIT                   
             ELSE                                                               
                  MOVE    'N'          TO   WS-SCH-TAG                          
                  MOVE    'A'          TO   WS-CDE-ERROR                        
                  PERFORM  350-WRITE-BP13K140      THRU    350-EXIT             
                  PERFORM  800-ERROR-LIST          THRU    800-EXIT             
             END-IF.                                                            
                                                                                
       330-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       335-UPDATE-K352.                                                         
      *-------------------------------------------------------------            
                                                                                
              IF (F630-NUM-HDB-REF = K352-NUM-SCH-ACC)                          
                  MOVE    'Y'          TO   WS-SCH-TAG                          
                  PERFORM 365-ADV-AMT-NON-STUDIO THRU  365-EXIT                 
                  PERFORM 345-MOVE-VALUE-K352    THRU  345-EXIT                 
                  PERFORM 400-WRITE-BP13K130     THRU  400-EXIT                 
                  PERFORM 500-WRITE-BP13F360     THRU  500-EXIT                 
             ELSE                                                               
                  MOVE    'N'          TO            WS-SCH-TAG                 
                  MOVE    'A'          TO            WS-CDE-ERROR               
                  PERFORM  350-WRITE-BP13K140      THRU    350-EXIT             
                  PERFORM  800-ERROR-LIST          THRU    800-EXIT             
             END-IF.                                                            
                                                                                
       335-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       340-MOVE-VALUE-K350.                                                     
      *-------------------------------------------------------------            
                                                                                
               MOVE 'A'                 TO  K350-CDE-PRINT.                     
               MOVE F630-NUM-BATCH      TO  K350-NUM-JRNO-BATCH-NO.             
               MOVE F630-DTE-TRANS      TO  K350-DTE-POST.                      
               MOVE WS-DTE-CUR          TO  K350-DTE-UPDATE.                    
               MOVE 'BP13C36B'          TO  K350-NUM-USERID.                    
               REWRITE BP13K350-REC                                             
               IF BP13K350-STATUS = '00'                                        
                  ADD        1     TO    WS-K350-WRITE                          
               END-IF.                                                          
                                                                                
       340-EXIT.                                                                
           EXIT.                                                                
                                                                                
      *-------------------------------------------------------------            
       345-MOVE-VALUE-K352.                                                     
      *-------------------------------------------------------------            
                                                                                
               MOVE 'A'                 TO  K352-CDE-PRINT.                     
               MOVE F630-NUM-BATCH      TO  K352-NUM-JRNO-BATCH-NO.             
               MOVE F630-DTE-TRANS      TO  K352-DTE-POST.                      
               MOVE WS-DTE-CUR          TO  K352-DTE-UPDATE.                    
               MOVE 'BP13C36B'          TO  K352-NUM-USERID.                    
               REWRITE BP13K352-REC                                             
               IF BP13K352-STATUS = '00'                                        
                  ADD        1     TO    WS-K352-WRITE                          
               END-IF.                                                          
                                                                                
       345-EXIT.                                                                
           EXIT.                                                                
                                                                                
      **********************************************************                
      *        WRITTING ERROR RECORDS TO BP13K140 FOR KIV      *                
      **********************************************************                
      *-------------------------------------------------------------            
       350-WRITE-BP13K140.                                                      
      *-------------------------------------------------------------            
           MOVE SPACES TO BP13K140-KIVTRAN.                                     
           ADD 1       TO WS-K140-WRITE.                                        
                                                                                
           IF F630-NUM-TRANS-ID = 'AMRT'                                        
                MOVE 'AMR' TO K140-CDE-PAYMENT-TYPE                             
           ELSE                                                                 
           IF F630-NUM-TRANS-ID = 'ADPS'                                        
                MOVE 'ADP' TO K140-CDE-PAYMENT-TYPE                             
           END-IF                                                               
           END-IF.                                                              
           IF F630-NUM-BATCH-TYPE = 'J'                                         
                   MOVE '16' TO K140-CDE-TRANS-TYPE                             
           ELSE                                                                 
                IF F630-NUM-BATCH-TYPE = 'P' OR 'B'                             
                   MOVE '15' TO K140-CDE-TRANS-TYPE                             
           END-IF.                                                              
                                                                                
           MOVE 'V'                 TO  K140-COUNT-HIST-CHAR            00051000
           MOVE K110-REGN-NO        TO  K140-NUM-REGN.                  00051000
           MOVE F630-NUM-HDB-REF    TO  K140-NUM-SCH-ACCT.                      
           MOVE WS-K140-WRITE       TO  K140-COUNT-HIST-NUM.            00051000
           MOVE F630-NUM-BATCH      TO  WS-SCHEDULE-NUM.                        
           MOVE F630-NUM-VR-SERIAL  TO  WS-DOC-NO.                              
           MOVE WS-SCHEDULE-NO      TO  K140-NUM-RECPT-JRNO.                    
           MOVE F630-NUM-VR-DDD     TO  K140-NUM-VR-DDD.                        
           MOVE F630-NUM-VR-YY      TO  K140-NUM-VR-YY.                         
           MOVE F630-NUM-TRANS-DR-CR TO K140-CDE-CRDR.                          
           MOVE F630-DTE-TRANS      TO  K140-DTE-TRANS                          
                                        K140-DTE-POST.                          
           IF F630-AMT-TRANS        IS NOT NUMERIC                              
              MOVE ZEROS            TO F630-AMT-TRANS                           
           END-IF.                                                              
           IF F630-NUM-TRANS-DR-CR = 'D'                                        
              COMPUTE K140-AMT-RECEIPT = 0 - F630-AMT-TRANS                     
           ELSE                                                                 
              MOVE F630-AMT-TRANS      TO  K140-AMT-RECEIPT                     
           END-IF.                                                              
           MOVE WS-CDE-ERROR       TO  K140-CDE-ERROR.                          
           WRITE BP13K140-KIVTRAN.                                              
                                                                                
           IF BP13K140-STATUS = '00' OR '02'                                    
              NEXT SENTENCE                                                     
           ELSE                                                                 
              IF BP13K140-STATUS = '22'                                         
                 ADD 1 TO  WS-CNT-HIST                                          
                 MOVE WS-CNT-HIST TO  K140-COUNT-HIST-NUM                       
                 WRITE BP13K140-KIVTRAN                                         
                 DISPLAY ' DUPLICATE RECORDS AT BP13K140 '                      
             ELSE                                                               
               DISPLAY ' WRITE ERROR AT BP13K140 '                              
               DISPLAY ' REGN NO IS : ' F630-NUM-REGN                           
               DISPLAY 'BP13K140-STATUS   IS : ' BP13K140-STATUS                
               MOVE BP13K140-STATUS       TO     RETURN-CODE                    
               PERFORM 999-CLOSE-FILES THRU 999-EXIT.                           
                                                                                
       350-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       360-ADV-AMT-STUDIO.                                                      
      ******************************************************************        
                                                                                
           EVALUATE F630-NUM-BATCH-TYPE                                         
           WHEN 'B'                                                             
                IF F630-NUM-TRANS-DR-CR = 'D'                                   
                    COMPUTE K350-AMT-REFUND-ADV-COL =                           
                            K350-AMT-REFUND-ADV-COL + F630-AMT-TRANS            
                ELSE                                                            
                    COMPUTE K350-AMT-ADV-COLLECTION =                           
                            K350-AMT-ADV-COLLECTION + F630-AMT-TRANS            
                END-IF                                                          
           WHEN 'P'                                                             
                IF F630-NUM-TRANS-DR-CR = 'D'                                   
                    COMPUTE K350-AMT-REFUND-ADV-COL =                           
                            K350-AMT-REFUND-ADV-COL + F630-AMT-TRANS            
                ELSE                                                            
                    COMPUTE K350-AMT-ADV-COLLECTION =                           
                            K350-AMT-ADV-COLLECTION + F630-AMT-TRANS            
                END-IF                                                          
           WHEN 'J'                                                             
                IF F630-NUM-TRANS-DR-CR = 'D'                                   
                    COMPUTE K350-AMT-ADV-COLLECTION-USED =                      
                        K350-AMT-ADV-COLLECTION-USED + F630-AMT-TRANS           
                ELSE                                                            
                    COMPUTE K350-AMT-ADV-COLLECTION =                           
                            K350-AMT-ADV-COLLECTION + F630-AMT-TRANS            
                END-IF                                                          
           END-EVALUATE.                                                        
                                                                                
       360-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       365-ADV-AMT-NON-STUDIO.                                                  
      ******************************************************************        
                                                                                
            EVALUATE F630-NUM-BATCH-TYPE                                        
             WHEN 'B'                                                           
                IF F630-NUM-TRANS-DR-CR = 'D'                                   
                    COMPUTE K352-AMT-REFUND-ADV-COL =                           
                            K352-AMT-REFUND-ADV-COL + F630-AMT-TRANS            
                ELSE                                                            
                    COMPUTE K352-AMT-ADV-COLLECTION =                           
                            K352-AMT-ADV-COLLECTION + F630-AMT-TRANS            
                END-IF                                                          
             WHEN 'P'                                                           
                IF F630-NUM-TRANS-DR-CR = 'D'                                   
                    COMPUTE K352-AMT-REFUND-ADV-COL =                           
                            K352-AMT-REFUND-ADV-COL + F630-AMT-TRANS            
                ELSE                                                            
                    COMPUTE K352-AMT-ADV-COLLECTION =                           
                            K352-AMT-ADV-COLLECTION + F630-AMT-TRANS            
                END-IF                                                          
             WHEN 'J'                                                           
                IF F630-NUM-TRANS-DR-CR = 'D'                                   
                    COMPUTE K352-AMT-ADV-COLLECTION-USED =                      
                        K352-AMT-ADV-COLLECTION-USED + F630-AMT-TRANS           
                ELSE                                                            
                    COMPUTE K352-AMT-ADV-COLLECTION =                           
                            K352-AMT-ADV-COLLECTION + F630-AMT-TRANS            
                END-IF                                                          
             END-EVALUATE.                                                      
                                                                                
       365-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       375-READ-K800.                                                           
      ******************************************************************        
                                                                                
            IF (K110-REGN-NO NOT = SPACES AND LOW-VALUES AND                    
                                   ALL 'X') AND                                 
               (K110-REGN-NO(1:2) NOT = '##')                                   
                                                                                
                ADD  1             TO WS-K110-READ                              
                MOVE K110-REGN-NO  TO K350-NUM-REGN K352-NUM-REGN               
                                      K800-NUM-REGN                             
                PERFORM 380-READ-K800        THRU   380-EXIT                    
                PERFORM 385-READ-K350-352    THRU   385-EXIT                    
            ELSE                                                                
               MOVE 'R'         TO   WS-CDE-ERROR                               
               PERFORM  350-WRITE-BP13K140      THRU    350-EXIT                
               PERFORM  800-ERROR-LIST          THRU    800-EXIT                
            END-IF.                                                             
                                                                                
       375-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       380-READ-K800.                                                           
      ******************************************************************        
                                                                                
              READ BP13K800                                                     
              EVALUATE BP13K800-STATUS                                          
              WHEN '00'                                                         
                    MOVE 'Y'      TO    WS-K800-REC-FND                         
                    ADD  1        TO    WS-K800-READ                            
              WHEN  '23'                                                        
                     PERFORM 382-READ-K893   THRU 382-EXIT                      
              WHEN  OTHER                                                       
                     MOVE 'N'     TO     WS-K800-REC-FND                        
                     MOVE  BP13K800-STATUS TO RETURN-CODE                       
                     PERFORM 999-CLOSE-FILES THRU 999-EXIT                      
              END-EVALUATE.                                                     
                                                                                
       380-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       382-READ-K893.                                                           
      ******************************************************************        
                                                                                
           MOVE SPACES         TO    K893-KEY-FLD WS-K893-EOF.                  
           INITIALIZE                K893-KEY-FLD.                              
                                                                                
           MOVE K110-REGN-NO   TO    K893-NUM-REGN-HIST.                        
                                                                                
           START BP13K893 KEY >= K893-KEY-FLD.                                  
                                                                                
           EVALUATE BP13K893-STATUS                                             
           WHEN '00'                                                            
           WHEN '02'                                                            
                 PERFORM 383-READNEXT-K893 THRU 383-EXIT                        
                   UNTIL K110-REGN-NO NOT = K893-NUM-REGN-HIST                  
                      OR WS-K893-EOF = 'Y'                                      
           WHEN  '10'                                                           
           WHEN  '23'                                                           
                  MOVE 'N'     TO     WS-K800-REC-FND                           
                  ADD 1        TO     WS-K800-NOTFD                             
                  DISPLAY 'BP13K800-RECORD NOT FOUND  '                         
                                  K893-NUM-REGN-HIST                            
           WHEN  OTHER                                                          
                  MOVE 'N'     TO     WS-K800-REC-FND                           
                  DISPLAY 'STARTBR ERROR BP13K893 - ' BP13K893-STATUS           
                          ', KEY IS ' K893-KEY-FLD                              
                  MOVE  BP13K893-STATUS TO RETURN-CODE                          
                  PERFORM 999-CLOSE-FILES THRU 999-EXIT                         
           END-EVALUATE.                                                        
                                                                                
       382-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       383-READNEXT-K893.                                                       
      ******************************************************************        
           READ BP13K893 NEXT RECORD.                                           
                                                                                
           EVALUATE BP13K893-STATUS                                             
           WHEN '00'                                                            
           WHEN '02'                                                            
                 IF K110-REGN-NO = K893-NUM-REGN-HIST                           
                    ADD 1     TO     WS-K800-READ                               
                    MOVE BP13K893-MASTER TO BP13K800-MASTER                     
                 ELSE                                                           
                    MOVE 'Y'  TO     WS-K893-EOF                                
                 END-IF                                                         
           WHEN  '10'                                                           
           WHEN  '23'                                                           
                 MOVE 'N'     TO     WS-K800-REC-FND                            
                 MOVE 'Y'     TO     WS-K893-EOF                                
                 ADD 1        TO     WS-K800-NOTFD                              
                 DISPLAY 'BP13K800-RECORD NOT FOUND  '                          
                                 K800-NUM-REGN                                  
           WHEN  OTHER                                                          
                 MOVE 'N'     TO     WS-K800-REC-FND                            
                 DISPLAY 'READNXT ERROR BP13K893 - ' BP13K893-STATUS            
                         ', KEY IS ' K893-KEY-FLD                               
                 MOVE  BP13K893-STATUS TO RETURN-CODE                           
                 PERFORM 999-CLOSE-FILES THRU 999-EXIT                          
           END-EVALUATE.                                                        
                                                                                
       383-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       385-READ-K350-352.                                                       
      ******************************************************************        
                                                                                
             IF F630-NUM-TRANS-ID = 'ADPS'                                      
                IF K800-NUM-FLAT-TYPE  = '1A' OR '2A' OR '2F'                   
                   PERFORM 310-READ-K350     THRU  310-EXIT                     
                ELSE                                                            
                   PERFORM 315-READ-K352     THRU  315-EXIT                     
                END-IF                                                          
             ELSE                                                               
               IF F630-NUM-TRANS-ID = 'AMRT'                                    
                  IF K800-NUM-FLAT-TYPE = '1A' OR '2A' OR '2F'                  
                     PERFORM  310-READ-K350  THRU  310-EXIT                     
                  ELSE                                                          
                     PERFORM  315-READ-K352  THRU  315-EXIT                     
                  END-IF                                                        
               END-IF                                                           
             END-IF.                                                            
                                                                                
       385-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       400-WRITE-BP13K130.                                                      
      ******************************************************************        
                                                                                
           PERFORM 410-MOVE-VALUES-TO-K130 THRU 410-EXIT.                       
                                                                                
           WRITE BP13K130-CDHIST.                                               
                                                                                
           IF BP13K130-STATUS = '00'                                            
              ADD 1 TO WS-K130-WRITE                                            
           ELSE                                                                 
              IF BP13K130-STATUS = '22'                                         
                 MOVE 'N' TO WS-K130-WRITTEN                                    
                 PERFORM 420-READ-BP13K130 THRU 420-EXIT UNTIL                  
                             WS-K130-WRITTEN = 'Y'                              
              ELSE                                                              
                 MOVE BP13K130-STATUS   TO RETURN-CODE                          
                 DISPLAY 'ERROR READING BP13K130. STATUS : '                    
                                                  BP13K130-STATUS               
                 PERFORM 999-CLOSE-FILES THRU 999-EXIT.                         
                                                                                
       400-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      ******************************************************************        
       410-MOVE-VALUES-TO-K130.                                                 
      ******************************************************************        
                                                                                
           MOVE  SPACES                TO    BP13K130-CDHIST.                   
           INITIALIZE                        BP13K130-CDHIST.                   
           IF F630-NUM-TRANS-ID = 'AMRT'                                        
                MOVE 'AMR' TO K130-PAYMENT-TYPE                                 
           ELSE                                                                 
              IF F630-NUM-TRANS-ID = 'ADPS'                                     
                MOVE 'ADP' TO K130-PAYMENT-TYPE                                 
              END-IF                                                            
           END-IF.                                                              
           IF F630-NUM-BATCH-TYPE = 'J'                                         
              MOVE '16' TO  K130-TRANS-TYPE                                     
           ELSE                                                                 
              IF F630-NUM-BATCH-TYPE = 'P' OR 'B'                               
                 MOVE '15' TO  K130-TRANS-TYPE                                  
              END-IF                                                            
           END-IF.                                                              
           MOVE K110-REGN-NO           TO    K130-NUM-ORIG-REGN.                
           MOVE F630-DTE-TRANS         TO    K130-DTE-POST                      
                                             K130-DTE-TRANS.                    
           MOVE WS-COUNT-HISTORY       TO    K130-COUNT-HISTORY.                
           IF   F630-AMT-TRANS         IS   NOT NUMERIC                         
                MOVE ZEROS             TO   F630-AMT-TRANS                      
           END-IF.                                                              
           IF F630-NUM-TRANS-DR-CR = 'D'                                        
              COMPUTE K130-AMT-CASH =  0 - F630-AMT-TRANS                       
           ELSE                                                                 
              MOVE F630-AMT-TRANS TO K130-AMT-CASH                              
           END-IF.                                                              
           MOVE F630-NUM-TRANS-DR-CR   TO    K130-AMT-TYP.                      
           MOVE F630-NUM-HDB-REF       TO    K130-NUM-SCH-ACCT.                 
           MOVE F630-NUM-BATCH         TO    WS-SCHEDULE-NUM.                   
           MOVE F630-NUM-VR-SERIAL     TO    WS-DOC-NO.                         
           MOVE WS-SCHEDULE-NO         TO    K130-NUM-RECPT-JRNO.               
           IF WS-K800-REC-FND = 'Y'                                             
              MOVE K800-NUM-NRIC1         TO    K130-NUM-NRIC                   
           ELSE                                                                 
              MOVE SPACES                 TO    K130-NUM-NRIC                   
           END-IF.                                                              
           MOVE SPACES                 TO    K130-NME-NAME                      
                                             K130-CDE-ERROR                     
                                             K130-CDE-VALID                     
                                             K130-CDE-CANCEL                    
                                             K130-CDE-BO                        
                                             K130-NUM-FLAT-TYPE-SA              
                                             K130-NUM-FLAT-TYPE-RSL             
                                             K130-NUM-CPF-APPL.                 
                                                                                
       410-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       420-READ-BP13K130.                                                       
      ******************************************************************        
           MOVE K110-REGN-NO           TO    K130-NUM-ORIG-REGN.                
           MOVE F630-DTE-TRANS         TO    K130-DTE-POST.                     
           ADD 1                       TO    WS-COUNT-HISTORY.                  
           MOVE WS-COUNT-HISTORY       TO    K130-COUNT-HISTORY.                
                                                                                
           READ BP13K130.                                                       
                                                                                
           IF BP13K130-STATUS = '00'                                            
              NEXT SENTENCE                                                     
           ELSE                                                                 
              IF  BP13K130-STATUS = '23'                                        
                  MOVE 'Y'  TO WS-K130-WRITTEN                                  
                  PERFORM 400-WRITE-BP13K130       THRU  400-EXIT.              
                                                                                
       420-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       500-WRITE-BP13F360.                                                      
      ******************************************************************        
                                                                                
           PERFORM 510-MOVE-VALUES-TO-F360 THRU 510-EXIT.                       
           WRITE BP13F360-REC.                                                  
           ADD 1 TO WS-F360-WRITE.                                              
                                                                                
       500-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      ******************************************************************        
       510-MOVE-VALUES-TO-F360.                                                 
      ******************************************************************        
                                                                                
           MOVE  SPACES                TO    BP13F360-REC.                      
           INITIALIZE                        BP13F360-REC.                      
           MOVE K352-NUM-REGN          TO    F360-NUM-REG.                      
           MOVE F630-DTE-TRANS         TO    F360-DTE-TRANS.                    
           MOVE F630-NUM-TRANS-DR-CR   TO    F360-NUM-TRANS-DR-CR.              
           MOVE F630-NUM-HDB-REF       TO    F360-NUM-HDB-REF.                  
           MOVE F630-NUM-BATCH         TO    WS-SCHEDULE-NUM.                   
           MOVE F630-NUM-VR-SERIAL     TO    WS-DOC-NO.                         
           MOVE F630-TXT-TRANS-DESC(1:2) TO  F360-NUM-VR-TYP.                   
           MOVE WS-SCHEDULE-NO         TO    F360-NUM-RECPT-JRNO.               
           MOVE 'A'                    TO    F360-NUM-TAX-CDE.                  
           MOVE K352-AMT-ADV-COLLECTION TO   F360-AMT-ADV-COLLECTION.           
           MOVE K352-AMT-ADV-COLLECTION-USED TO                                 
                        F360-AMT-ADV-COLLECTION-USED.                           
           MOVE K352-AMT-REFUND-ADV-COL TO   F360-AMT-REFUND-ADV-COL.           
           MOVE K800-NUM-FLAT-TYPE      TO   F360-NUM-FLAT-TYPE.                
           MOVE K800-NUM-ALLO-CAT       TO   F360-NUM-SALE-MODE.                
           MOVE K110-DTE-KEY-AVAIL      TO   F360-DTE-KEY-AVAIL.                
           MOVE F630-AMT-TRANS          TO   F360-AMT-TRANS.                    
           IF F630-NUM-TRANS-ID = 'ADPS'                                        
              MOVE 'ADP'                TO   F630-PAYMENT-TYPE                  
           ELSE                                                                 
             IF F630-NUM-TRANS-ID = 'AMRT'                                      
                MOVE 'AMR'              TO F630-PAYMENT-TYPE                    
             END-IF                                                             
            END-IF.                                                             
                                                                                
       510-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       550-WRITE-BP13F360.                                                      
      ******************************************************************        
                                                                                
           PERFORM 560-MOVE-VALUES-TO-F360 THRU 560-EXIT.                       
           WRITE BP13F360-REC.                                                  
           ADD 1 TO WS-F360-WRITE.                                              
                                                                                
       550-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      ******************************************************************        
       560-MOVE-VALUES-TO-F360.                                                 
      ******************************************************************        
                                                                                
           MOVE  SPACES                TO    BP13F360-REC.                      
           INITIALIZE                        BP13F360-REC.                      
           MOVE K350-NUM-REGN          TO    F360-NUM-REG.                      
           MOVE F630-DTE-TRANS         TO    F360-DTE-TRANS.                    
           MOVE F630-NUM-TRANS-DR-CR   TO    F360-NUM-TRANS-DR-CR.              
           MOVE F630-NUM-HDB-REF       TO    F360-NUM-HDB-REF.                  
           MOVE F630-NUM-BATCH         TO    WS-SCHEDULE-NUM.                   
           MOVE F630-NUM-VR-SERIAL     TO    WS-DOC-NO.                         
           MOVE F630-AMT-TRANS         TO    F360-AMT-TRANS.                    
           MOVE F630-TXT-TRANS-DESC(1:2) TO  F360-NUM-VR-TYP.                   
           MOVE WS-SCHEDULE-NO         TO    F360-NUM-RECPT-JRNO.               
           MOVE 'A'                    TO    F360-NUM-TAX-CDE.                  
           MOVE K350-AMT-ADV-COLLECTION TO   F360-AMT-ADV-COLLECTION.           
           MOVE K350-AMT-ADV-COLLECTION-USED TO                                 
                        F360-AMT-ADV-COLLECTION-USED.                           
           MOVE K350-AMT-REFUND-ADV-COL TO   F360-AMT-REFUND-ADV-COL.           
           MOVE K800-NUM-FLAT-TYPE      TO   F360-NUM-FLAT-TYPE.                
           MOVE K800-NUM-ALLO-CAT       TO   F360-NUM-SALE-MODE.                
           MOVE K110-DTE-KEY-AVAIL      TO   F360-DTE-KEY-AVAIL.                
           IF F630-NUM-TRANS-ID = 'ADPS'                                        
              MOVE 'ADP'                TO   F630-PAYMENT-TYPE                  
           ELSE                                                                 
             IF F630-NUM-TRANS-ID = 'AMRT'                                      
                MOVE 'AMR'              TO F630-PAYMENT-TYPE                    
             END-IF                                                             
           END-IF.                                                              
       560-EXIT.                                                                
           EXIT.                                                                
                                                                                
      ******************************************************************        
       610-WRITE-K350.                                                          
      ******************************************************************        
                                                                                
                MOVE   SPACES               TO    BP13K350-REC.                 
                INITIALIZE                        BP13K350-REC.                 
                MOVE K110-REGN-NO           TO    K350-NUM-REGN.                
                IF K800-NUM-SCH-ACC = SPACES OR LOW-VALUES OR ZEROS             
                   MOVE F630-NUM-HDB-REF    TO    K350-NUM-SCH-ACC              
                ELSE                                                            
                   MOVE K800-NUM-SCH-ACC    TO    K350-NUM-SCH-ACC              
                END-IF.                                                         
                PERFORM 360-ADV-AMT-STUDIO  THRU  360-EXIT.                     
                MOVE F630-NUM-BATCH         TO   K350-NUM-JRNO-BATCH-NO.        
                MOVE F630-DTE-TRANS         TO   K350-DTE-POST.                 
                MOVE 'A'                    TO   K350-CDE-PRINT.                
                MOVE WS-DTE-CUR             TO   K350-DTE-UPDATE.               
                MOVE 'BP13C36B'             TO   K350-NUM-USERID.               
                WRITE BP13K350-REC.                                             
                IF BP13K350-STATUS = ZERO                                       
                   ADD 1            TO WS-K350-WRITE                            
                   MOVE 'Y'         TO WS-K350-FOUND                            
                ELSE                                                            
                   MOVE BP13K350-STATUS    TO RETURN-CODE                       
                   DISPLAY 'ERROR WRITING BP13K350. STATUS : '                  
                                                  BP13K350-STATUS               
                   PERFORM 999-CLOSE-FILES THRU 999-EXIT                        
                END-IF.                                                         
                                                                                
       610-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      ******************************************************************        
       650-WRITE-K352.                                                          
      ******************************************************************        
                                                                                
                MOVE   SPACES               TO    BP13K352-REC.                 
                INITIALIZE                        BP13K352-REC.                 
                MOVE K110-REGN-NO           TO    K352-NUM-REGN.                
                IF K800-NUM-SCH-ACC = SPACES OR LOW-VALUES OR ZEROS             
                   MOVE F630-NUM-HDB-REF    TO    K352-NUM-SCH-ACC              
                ELSE                                                            
                   MOVE K800-NUM-SCH-ACC    TO    K352-NUM-SCH-ACC              
                END-IF.                                                         
                PERFORM 365-ADV-AMT-NON-STUDIO THRU  365-EXIT.                  
                MOVE F630-NUM-BATCH         TO   K352-NUM-JRNO-BATCH-NO.        
                MOVE F630-DTE-TRANS         TO   K352-DTE-POST.                 
                MOVE 'A'                    TO   K352-CDE-PRINT.                
                MOVE WS-DTE-CUR             TO   K352-DTE-UPDATE.               
                MOVE 'BP13C36B'             TO   K352-NUM-USERID.               
                WRITE BP13K352-REC.                                             
                IF BP13K352-STATUS = ZERO                                       
                   ADD 1            TO WS-K352-WRITE                            
                   MOVE 'Y'         TO WS-K352-FOUND                            
                ELSE                                                            
                   MOVE BP13K352-STATUS    TO RETURN-CODE                       
                   DISPLAY 'ERROR WRITING BP13K352. STATUS : '                  
                                                  BP13K352-STATUS               
                   PERFORM 999-CLOSE-FILES THRU 999-EXIT                        
                END-IF.                                                         
                                                                                
       650-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       800-ERROR-LIST.                                                          
      *-------------------------------------------------------------            
           IF WS-LINE-CNT > 46                                                  
               MOVE 1 TO WS-LINE-CNT                                            
               PERFORM 900-ERROR-HEADING THRU 900-EXIT                          
           ELSE                                                                 
               ADD 1 TO WS-LINE-CNT.                                            
                                                                                
           ADD 1 TO CNT-KIV-CASES.                                              
           EVALUATE WS-CDE-ERROR                                                
            WHEN 'R'                                                            
               MOVE 'ORIG REGN NO ERROR' TO 13S1-REMARK                         
            WHEN 'A'                                                            
               MOVE 'SCHEME ACCOUNT NUMBER ERROR' TO 13S1-REMARK                
            WHEN 'N'                                                            
               MOVE 'RECORD NOT FOUND IN K350/K352' TO 13S1-REMARK              
           END-EVALUATE.                                                        
           MOVE  CNT-KIV-CASES         TO 13S1-SNO.                             
           MOVE  K110-REGN-NO          TO 13S1-REG-NO.                          
           IF F630-NUM-TRANS-ID = 'AMRT'                                        
              MOVE 'AMR'               TO 13S1-PAY-TYPE                         
           ELSE                                                                 
             IF F630-NUM-TRANS-ID = 'ADPS'                                      
                MOVE 'ADP'               TO 13S1-PAY-TYPE                       
             ELSE                                                               
              MOVE SPACES              TO 13S1-PAY-TYPE                         
             END-IF                                                             
           END-IF.                                                              
           MOVE  K800-NUM-ALLO-CAT     TO 13S1-SALES-MODE.                      
           MOVE  K800-NUM-FLAT-TYPE    TO 13S1-FLAT-TYP.                        
           MOVE  F630-DTE-TRANS        TO 13S1-DTE-TRANS.                       
           MOVE  K140-NUM-RECPT-JRNO   TO 13S1-NUM-RECEIPT.                     
           MOVE  K140-AMT-RECEIPT      TO 13S1-AMT.                             
           MOVE  F630-NUM-HDB-REF      TO 13S1-SCH-ACC.                         
           MOVE  F630-NUM-TRANS-DR-CR  TO 13S1-DRCR.                            
           WRITE PRINT-REC FROM L36B-PR-DETAILS.                                
                                                                                
       800-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       900-ERROR-HEADING.                                                       
      *-------------------------------------------------------------            
            ADD 1         TO WS-PAGE-CNT .                                      
            MOVE WS-PAGE-CNT TO 13S1-PAGE.                                      
            MOVE SPACES   TO PRINT-REC                                          
            WRITE PRINT-REC AFTER PAGE.                                         
            WRITE PRINT-REC FROM L36B-PR-HEAD-01 AFTER 2.                       
            WRITE PRINT-REC FROM L36B-PR-HEAD-02 AFTER 3.                       
            WRITE PRINT-REC FROM L36B-PR-HEAD-03 AFTER 3.                       
            MOVE ALL '-'  TO PRINT-REC.                                         
            WRITE PRINT-REC .                                                   
            MOVE SPACES   TO PRINT-REC.                                         
            WRITE PRINT-REC AFTER 1.                                            
                                                                                
       900-EXIT.                                                                
           EXIT.                                                                
                                                                                
                                                                                
                                                                                
      *-------------------------------------------------------------            
       999-CLOSE-FILES.                                                         
      *-------------------------------------------------------------            
           DISPLAY '******  BP13C36B *************'.                            
           DISPLAY 'NO OF F630 READ      (F630) : ' WS-CNT-F630-READ.           
           DISPLAY 'NO OF K110 READ      (K110) : ' WS-K110-READ.               
           DISPLAY 'NO OF K350 READ      (K350) : ' WS-K350-READ.               
           DISPLAY 'NO OF K352 READ      (K352) : ' WS-K352-READ.               
           DISPLAY 'NO OF K800 READ      (K800) : ' WS-K800-READ.               
           DISPLAY 'NO OF K350 WRITE     (K350) : ' WS-K350-WRITE.              
           DISPLAY 'NO OF K352 WRITE     (K352) : ' WS-K352-WRITE.              
           DISPLAY 'NO OF K140 WRITE     (K140) : ' WS-K140-WRITE.              
           DISPLAY 'NO OF K130 WRITE     (K130) : ' WS-K130-WRITE.              
           DISPLAY 'NO OF F360 WRITE     (F360) : ' WS-F360-WRITE.              
                                                                                
           CLOSE BP13K350                                                       
                 BP13K352                                                       
                 BP13K140                                                       
                 BP13K130                                                       
                 BM06K110                                                       
                 BM06K115                                                       
                 AG07F630                                                       
                 BP13K800                                                       
                 BP13F360                                                       
                 BP13L36B.                                                      
                                                                                
                                                                                
           IF BP13K350-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K350-STATUS ' BP13K350-STATUS          
            MOVE BP13K350-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K352-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K352-STATUS ' BP13K352-STATUS          
            MOVE BP13K352-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K140-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K140-STATUS ' BP13K140-STATUS          
            MOVE BP13K140-STATUS TO RETURN-CODE.                                
                                                                                
           IF BM06K110-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BM06K110-STATUS ' BM06K110-STATUS          
            MOVE BM06K110-STATUS TO RETURN-CODE.                                
                                                                                
           IF BM06K115-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BM06K115-STATUS ' BM06K115-STATUS          
            MOVE BM06K115-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K800-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K800-STATUS ' BP13K800-STATUS          
            MOVE BP13K800-STATUS TO RETURN-CODE.                                
                                                                                
           IF BP13K130-STATUS NOT = 0 AND 97                                    
            DISPLAY ' CLOSING ERROR, BP13K130-STATUS ' BP13K130-STATUS          
            MOVE BP13K130-STATUS TO RETURN-CODE.                                
                                                                                
           STOP RUN.                                                            
                                                                                
       999-EXIT.                                                                
            EXIT.                                                               
