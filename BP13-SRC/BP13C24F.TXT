       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.   BP13C24F.                                                  
       AUTHOR.       ELAINE S ARGA.                                             
      *DATE-WRITTEN. 22 JUN 2011.                                               
      ************************************************************              
      *  SYSTEM NAME : SYSTEM OF COMMITMENT                      *              
      *  SYSTEM ID   : BP13                                      *              
      *  OBJECTIVE   : TO CREATE ALLOCATION SUMMARY FILE BP13F222*              
      *                                                          *              
      *  BP13F205    : CONTROL REC                               *              
      *  BP13F222    : ALLOCATION SUMMARY RESULT FILE            *              
      *  BP13K270    : BOOKING PROGRAMME FILE                    *              
      *  BP13K210    : BOOKING WORKPLAN                          *              
      *                                                          *              
      * CHG-NO   BY   DATE    DESCRIPTION                        *              
      * -------- ---- ------  -----------                        *              
      * BP134253 ESA1 220684  NEW PROGRAM PATTERNED TO BP13C248  *              
      * BP135190 SMR2 041213  EXPAND BP13K813 TO 1000            *              
      * BP136836 ESA1 180817  TO BYPASS ROF CASES                *              
      ************************************************************              
                                                                                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
                                                                                
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
                                                                                
           SELECT BP13F205 ASSIGN       TO BP13F205.                            
                                                                                
           SELECT BP13F222 ASSIGN       TO BP13F222.                            
                                                                                
           SELECT BP13K270 ASSIGN       TO BP13K270                             
                           ORGANIZATION IS INDEXED                              
                           ACCESS MODE  IS DYNAMIC                              
                           RECORD KEY   IS K270-KEY-FLD                         
                           FILE STATUS  IS K270-STATUS.                         
                                                                                
           SELECT BP13K210 ASSIGN       TO BP13K210                             
                           ORGANIZATION IS INDEXED                              
                           ACCESS MODE  IS DYNAMIC                              
                           RECORD KEY   IS K210-KEY-FLD                         
                           FILE STATUS  IS K210-STATUS.                         
                                                                                
           SELECT BP13K813 ASSIGN       TO BP13K813                             
                           ORGANIZATION IS INDEXED                              
                           ACCESS MODE  IS DYNAMIC                              
                           RECORD KEY   IS K813-KEY-FLD                         
                           FILE STATUS  IS K813-STATUS.                         
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
                                                                                
       FD  BP13F205                                                             
           BLOCK  CONTAINS 0   RECORDS                                          
           LABEL  RECORDS  ARE STANDARD                                         
           RECORDING MODE  IS  F                                                
           RECORD CONTAINS 80  CHARACTERS.                                      
       COPY BP13F205.                                                           
                                                                                
       FD  BP13F222                                                             
           RECORD CONTAINS 100 CHARACTERS.                                      
       COPY BP13F222.                                                           
                                                                                
       FD  BP13K270                                                             
           RECORD CONTAINS 250 CHARACTERS.                                      
       COPY BP13K270.                                                           
                                                                                
       FD  BP13K210                                                             
           RECORD CONTAINS 100 CHARACTERS.                                      
       COPY BP13K210.                                                           
                                                                                
       FD  BP13K813                                                             
           RECORD CONTAINS 1000 CHARACTERS.                                     
       COPY BP13K813.                                                           
                                                                                
       WORKING-STORAGE SECTION.                                                 
       01  WS-FILE-STATUS.                                                      
           05  F222-STATUS         PIC 99      VALUE ZERO.                      
           05  K210-STATUS         PIC 99      VALUE ZERO.                      
           05  K270-STATUS         PIC 99      VALUE ZERO.                      
           05  K813-STATUS         PIC 99      VALUE ZERO.                      
                                                                                
       01  WS-K210-FT              PIC X(2).                                    
                                                                                
       01  WS-COUNTERS.                                                         
           05  WS-F205-READ        PIC 9(8)    VALUE ZERO.                      
           05  WS-F222-WRITE       PIC 9(8)    VALUE ZERO.                      
           05  WS-F222-UPDATE      PIC 9(8)    VALUE ZERO.                      
           05  WS-K210-READ        PIC 9(8)    VALUE ZERO.                      
                                                                                
       01  WS-SWITCHES.                                                         
           05  F205-EOF            PIC X       VALUE 'N'.                       
               88  END-OF-F205                 VALUE 'Y'.                       
           05  K270-EOF            PIC X       VALUE 'N'.                       
               88  END-OF-K270                 VALUE 'Y'.                       
           05  K210-EOF            PIC X       VALUE 'N'.                       
               88  END-OF-K210                 VALUE 'Y'.                       
           05  WS-ZONE-FND-FLAG    PIC X       VALUE 'N'.                       
           05  WS-EOF-K813         PIC X       VALUE 'N'.                       
                                                                                
       01  WS-TEMP-VARIABLES.                                                   
           05  WS-CNT-BKAPPMT      PIC 9(4)    VALUE ZERO.                      
           05  WS-FLAT-OFFER       PIC 9(4)    VALUE ZERO.                      
           05  WS-ALLOC-TOTAL      PIC 9(4)    VALUE ZERO.                      
           05  WS-SERS-FLAT        PIC 9(4)    VALUE ZERO.                      
           05  WS-FT-NO            PIC 9(2)    VALUE ZERO.                      
           05  WS-START-DATE       PIC X(8)    VALUE SPACES.                    
           05  WS-END-DATE         PIC X(8)    VALUE SPACES.                    
           05  WS-WORK-END-DATE    PIC X(8)    VALUE SPACES.                    
           05  WS-DAY              PIC 9(2)    VALUE ZERO.                      
           05  WS-CTR              PIC 9(2)    VALUE ZERO.                      
                                                                                
       PROCEDURE DIVISION.                                                      
      *************************************************************             
       0000-MAIN-LOGIC.                                                         
      *************************************************************             
           PERFORM 1000-OPEN-FILES      THRU 1000-EXIT.                         
           PERFORM 2000-READ-F205       THRU 2000-EXIT.                         
           PERFORM 3000-PROCESS-RTN     THRU 3000-EXIT                          
             UNTIL END-OF-F205.                                                 
           PERFORM 9000-CLOSE-FILES     THRU 9000-EXIT.                         
                                                                                
      *************************************************************             
       1000-OPEN-FILES.                                                         
      *************************************************************             
           OPEN  INPUT BP13F205                                                 
                       BP13K210                                                 
                       BP13K270                                                 
                       BP13K813                                                 
                OUTPUT BP13F222.                                                
                                                                                
           IF K270-STATUS NOT = 00 AND 97                                       
              MOVE K270-STATUS            TO RETURN-CODE                        
              DISPLAY 'ERROR OPENING BP13K270 FILE, ' K270-STATUS               
              PERFORM 9000-CLOSE-FILES  THRU 9000-EXIT                          
           END-IF.                                                              
                                                                                
           IF K210-STATUS NOT = 00 AND 97                                       
              MOVE K210-STATUS            TO RETURN-CODE                        
              DISPLAY 'ERROR OPENING BP13K210 FILE, ' K210-STATUS               
              PERFORM 9000-CLOSE-FILES  THRU 9000-EXIT                          
           END-IF.                                                              
                                                                                
           IF K813-STATUS NOT = 00 AND 97                                       
              MOVE K813-STATUS            TO RETURN-CODE                        
              DISPLAY 'ERROR OPENING BP13K813 FILE, ' K813-STATUS               
              PERFORM 9000-CLOSE-FILES  THRU 9000-EXIT                          
           END-IF.                                                              
                                                                                
           INITIALIZE      WS-SWITCHES                                          
                           WS-TEMP-VARIABLES                                    
                           WS-COUNTERS.                                         
                                                                                
       1000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *************************************************************             
       2000-READ-F205.                                                          
      *************************************************************             
           READ BP13F205                                                        
             AT END                                                             
                MOVE 'Y' TO F205-EOF                                            
                GO TO 2000-EXIT.                                                
                                                                                
           ADD 1                   TO WS-F205-READ.                             
                                                                                
       2000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *************************************************************             
       3000-PROCESS-RTN.                                                        
      *************************************************************             
      *----------------------------------------------------*                    
      *BYPASS ROF CASES DUE TO NO BP13K270 RECORDS CREATED                      
      *----------------------------------------------------*                    
           IF F205-NUM-NT-ZONE = 'ROF'                                          
              CONTINUE                                                          
           ELSE                                                                 
              INITIALIZE  WS-TEMP-VARIABLES                                     
                          WS-SWITCHES                                           
                                                                                
              PERFORM 3100-START-BP13K210 THRU 3100-EXIT                        
           END-IF.                                                              
                                                                                
           PERFORM 2000-READ-F205      THRU 2000-EXIT.                          
                                                                                
       3000-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3100-START-BP13K210.                                                     
      *-----------------------------------------------------------*             
           MOVE 'N'                       TO K210-EOF.                          
           MOVE SPACES                    TO BP13K210-REC.                      
           MOVE F205-NUM-NT-ZONE          TO K210-NUM-NT-ZONE.                  
           MOVE ZEROS                     TO WS-CNT-BKAPPMT.                    
                                                                                
           START BP13K210 KEY NOT < K210-KEY-FLD.                               
                                                                                
           IF K210-STATUS = 00                                                  
              PERFORM 3200-READ-BP13K210 THRU 3200-EXIT                         
                UNTIL (F205-NUM-NT-ZONE   = K210-NUM-NT-ZONE    AND             
                       F205-DTE-ALLOCN    = K210-DTE-ALLOC      AND             
                       F205-NUM-FLAT-TYPE = K210-NUM-FLAT-TYPE)                 
                   OR  K210-EOF = 'Y'                                           
                                                                                
              IF (K210-EOF = 'Y') OR                                            
                 (F205-NUM-NT-ZONE   NOT = K210-NUM-NT-ZONE)    OR              
                 (F205-DTE-ALLOCN    NOT = K210-DTE-ALLOC)      OR              
                 (F205-NUM-FLAT-TYPE NOT = K210-NUM-FLAT-TYPE)                  
                 GO TO 3100-EXIT                                                
              ELSE                                                              
                 PERFORM 3250-PROCESS-BP13K210 THRU 3250-EXIT                   
              END-IF                                                            
           ELSE                                                                 
           IF K210-STATUS = 23                                                  
              DISPLAY 'START ERROR BP13K210 FILE' K210-STATUS                   
              DISPLAY 'K210-KEY-FLD : ' K210-KEY-FLD                            
           ELSE                                                                 
              MOVE K210-STATUS         TO RETURN-CODE                           
              DISPLAY 'ERROR START BP13K210 FILE, ' K210-STATUS                 
              DISPLAY 'K210-KEY-FLD = ' K210-KEY-FLD                            
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT.                          
                                                                                
       3100-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3200-READ-BP13K210.                                                      
      *-----------------------------------------------------------*             
                                                                                
           READ BP13K210 NEXT AT END  MOVE 'Y' TO K210-EOF                      
                GO TO 3200-EXIT.                                                
                                                                                
           ADD 1 TO WS-K210-READ.                                               
                                                                                
       3200-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3250-PROCESS-BP13K210.                                                   
      *-----------------------------------------------------------*             
                                                                                
           MOVE K210-NUM-FLAT-TYPE TO WS-K210-FT.                               
           PERFORM 3300-COUNT-SELECTION-DAY THRU 3300-EXIT                      
             UNTIL K210-NUM-NT-ZONE   > F205-NUM-NT-ZONE                        
                OR K210-NUM-FLAT-TYPE > WS-K210-FT                              
                OR K210-EOF = 'Y'.                                              
                                                                                
           PERFORM 3400-READ-K270 THRU 3400-EXIT.                               
                                                                                
       3250-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3300-COUNT-SELECTION-DAY.                                                
      *-----------------------------------------------------------*             
                                                                                
           IF F205-DTE-ALLOCN = K210-DTE-ALLOC                                  
              IF K210-NUM-FLAT-TYPE = WS-K210-FT                                
                 ADD K210-NUM-BKAPPMT       TO WS-CNT-BKAPPMT                   
                 ADD 1 TO WS-DAY                                                
                 IF WS-DAY = 1                                                  
                    MOVE K210-DTE-BKAPPMT   TO WS-START-DATE                    
                 END-IF                                                         
                 MOVE K210-DTE-BKAPPMT      TO WS-END-DATE                      
                                               WS-WORK-END-DATE                 
              ELSE                                                              
                 PERFORM 3400-READ-K270   THRU 3400-EXIT                        
                 MOVE K210-NUM-FLAT-TYPE    TO WS-K210-FT                       
                 MOVE ZEROS                 TO WS-DAY                           
                                               WS-CNT-BKAPPMT                   
                 GO TO 3300-EXIT                                                
              END-IF                                                            
           END-IF.                                                              
                                                                                
           PERFORM 3200-READ-BP13K210  THRU 3200-EXIT.                          
                                                                                
       3300-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3400-READ-K270.                                                          
      *-----------------------------------------------------------*             
                                                                                
           MOVE SPACES                    TO K270-KEY-FLD.                      
           MOVE F205-DTE-ALLOCN           TO K270-ALLOCN-DATE.                  
           MOVE ZEROS                     TO WS-FLAT-OFFER.                     
                                                                                
           START BP13K270 KEY NOT < K270-KEY-FLD.                               
                                                                                
           IF K270-STATUS = 00 OR 02                                            
              CONTINUE                                                          
           ELSE                                                                 
           IF K270-STATUS = 23                                                  
              DISPLAY 'RECORD NOT FOUND IN BP13K270'                            
              DISPLAY 'K270-KEY-FLD = ' K270-KEY-FLD                            
              GO TO 3400-EXIT                                                   
           ELSE                                                                 
              MOVE K270-STATUS           TO RETURN-CODE                         
              DISPLAY 'START ERROR READING BP13K270 FILE, ' K270-STATUS         
              DISPLAY 'K270-KEY-FLD = ' K270-KEY-FLD                            
              PERFORM 9000-CLOSE-FILES THRU 9000-EXIT.                          
                                                                                
      * TO GET THE SUBSCRIPT FOR K270-NUM-ALLOC BASED ON                        
      * K100-NUM-FLAT-TYPE                                                      
                                                                                
           IF WS-K210-FT = '1 '                                                 
              MOVE 1 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = '2 '                                                 
              MOVE 2 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = '3 ' OR '3P'                                         
              MOVE 3 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = '4 ' OR '4D'                                         
              MOVE 4 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = '4S'                                                 
              MOVE 5 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = '5 ' OR '5D'                                         
              MOVE 6 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = 'E ' OR 'ED'                                         
              MOVE 7 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = 'H '                                                 
              MOVE 8 TO WS-FT-NO                                                
           ELSE                                                                 
           IF WS-K210-FT = 'SE'                                                 
              MOVE 9 TO WS-FT-NO.                                               
                                                                                
           IF K270-STATUS = 0                                                   
              MOVE 'N'       TO K270-EOF                                        
              PERFORM 3500-ACCUM-FLATOFFER THRU 3500-EXIT                       
                UNTIL END-OF-K270.                                              
                                                                                
           PERFORM 3600-WRITETO-F222       THRU 3600-EXIT.                      
                                                                                
       3400-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3500-ACCUM-FLATOFFER.                                                    
      *-----------------------------------------------------------*             
           READ BP13K270 NEXT                                                   
                AT END                                                          
                   MOVE 'Y' TO K270-EOF                                         
                   GO 3500-EXIT.                                                
                                                                                
           PERFORM VARYING WS-CTR FROM 1 BY 1 UNTIL WS-CTR > 9                  
              IF K270-NUM-OFFER(WS-CTR) NOT NUMERIC                             
                 MOVE ZEROES    TO  K270-NUM-OFFER(WS-CTR)                      
              END-IF                                                            
           END-PERFORM.                                                         
                                                                                
           IF K270-ALLOCN-DATE NOT = F205-DTE-ALLOCN                            
              MOVE 'Y' TO K270-EOF                                              
              GO 3500-EXIT.                                                     
                                                                                
           EVALUATE F205-NUM-FLAT-TYPE                                          
             WHEN '00'                                                          
              IF F205-NUM-NT-ZONE(2:1) IS NUMERIC                               
                 PERFORM 3560-STARTBR-BP13K813  THRU 3560-EXIT                  
                 IF K813-CDE-NT = K270-CDE-NT                                   
                    IF WS-ZONE-FND-FLAG = 'Y'                                   
                       MOVE 0 TO WS-ALLOC-TOTAL                                 
                       IF F205-NUM-NT-ZONE (1:2) = '17'                         
                         PERFORM 3510-COMPUTE-FOR-DUXTON THRU 3510-EXIT         
                       ELSE                                                     
                         PERFORM 3520-COMPUTE-FOR-BTO THRU 3520-EXIT            
                       END-IF                                                   
                    END-IF                                                      
                 END-IF                                                         
              ELSE                                                              
                 IF (K270-CDE-NT = F205-NUM-NT-ZONE) OR                         
                    (K270-CDE-APPL-ZONE = F205-NUM-NT-ZONE)                     
                    MOVE 0 TO WS-ALLOC-TOTAL                                    
                    COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(4) +                
                                             K270-NUM-OFFER(5) +                
                                             K270-NUM-OFFER(6) +                
                                             K270-NUM-OFFER(7)                  
                    ADD WS-ALLOC-TOTAL TO WS-FLAT-OFFER                         
                 ELSE                                                           
                    IF F205-NUM-NT-ZONE = '00'                                  
                        MOVE 0 TO WS-ALLOC-TOTAL                                
                        COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(4)              
                        ADD WS-ALLOC-TOTAL TO WS-FLAT-OFFER                     
                    END-IF                                                      
                 END-IF                                                         
              END-IF                                                            
             WHEN OTHER                                                         
              IF (K270-CDE-NT = F205-NUM-NT-ZONE) OR                            
                 (K270-CDE-APPL-ZONE = F205-NUM-NT-ZONE)                        
                  MOVE 0 TO WS-ALLOC-TOTAL                                      
                  IF F205-NUM-FLAT-TYPE = 'SE'                                  
                     PERFORM 3530-COMPUTE-FOR-SE THRU 3530-EXIT                 
                  ELSE                                                          
                     IF F205-NUM-FLAT-TYPE = '4 '                               
                        PERFORM 3540-COMPUTE-FOR-RM4 THRU 3540-EXIT             
                     ELSE                                                       
                        IF F205-NUM-FLAT-TYPE = 'E '                            
                           COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(7) +         
                                                    K270-NUM-OFFER(9)           
                           MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER                 
                        ELSE                                                    
                           IF K270-NUM-COMBINE-SA = 'Y' OR                      
                              WS-K210-FT = '2F'                                 
                              PERFORM 3550-COMPUTE-FOR-COMBINE-SA               
                                 THRU 3550-EXIT                                 
                           ELSE                                                 
                              ADD K270-NUM-OFFER(WS-FT-NO)                      
                                  TO WS-FLAT-OFFER                              
                              MOVE WS-FLAT-OFFER TO WS-ALLOC-TOTAL              
                           END-IF                                               
                        END-IF                                                  
                     END-IF                                                     
                  END-IF                                                        
              END-IF                                                            
           END-EVALUATE.                                                        
                                                                                
       3500-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3510-COMPUTE-FOR-DUXTON.                                                 
      *-----------------------------------------------------------*             
           COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(4) +                         
                                    K270-NUM-OFFER(6).                          
                                                                                
           MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER.                                
                                                                                
       3510-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3520-COMPUTE-FOR-BTO.                                                    
      *-----------------------------------------------------------*             
           EVALUATE K813-NUM-FLAT-TYPE(1:1)                                     
              WHEN '1'                                                          
                  COMPUTE WS-ALLOC-TOTAL = WS-FLAT-OFFER     +                  
                                           K270-NUM-OFFER(1) +                  
                                           K270-NUM-OFFER(2)                    
                  MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER                          
              WHEN '2'                                                          
                  COMPUTE WS-ALLOC-TOTAL = WS-FLAT-OFFER  +                     
                                           K270-NUM-OFFER(2)                    
                  MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER                          
              WHEN '3'                                                          
                  ADD  K270-NUM-OFFER(3) TO WS-FLAT-OFFER                       
                  MOVE K270-NUM-OFFER(3) TO WS-ALLOC-TOTAL                      
              WHEN '4'                                                          
                  ADD  K270-NUM-OFFER(4) TO WS-FLAT-OFFER                       
                  MOVE K270-NUM-OFFER(4) TO WS-ALLOC-TOTAL                      
              WHEN '5'                                                          
                  ADD  K270-NUM-OFFER(6) TO WS-FLAT-OFFER                       
                  MOVE K270-NUM-OFFER(6) TO WS-ALLOC-TOTAL                      
              WHEN OTHER                                                        
                  DISPLAY 'BP13K813 - INVALID FLAT TYPE: '                      
                           K813-NUM-FLAT-TYPE                                   
           END-EVALUATE.                                                        
                                                                                
       3520-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3530-COMPUTE-FOR-SE.                                                     
      *-----------------------------------------------------------*             
           COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(3) +                         
                                    K270-NUM-OFFER(4) +                         
                                    K270-NUM-OFFER(5) +                         
                                    K270-NUM-OFFER(6).                          
                                                                                
           MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER.                                
                                                                                
       3530-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3540-COMPUTE-FOR-RM4.                                                    
      *-----------------------------------------------------------*             
           COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(4) +                         
                                    K270-NUM-OFFER(5).                          
                                                                                
           MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER.                                
                                                                                
       3540-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3550-COMPUTE-FOR-COMBINE-SA.                                             
      *-----------------------------------------------------------*             
           COMPUTE WS-ALLOC-TOTAL = K270-NUM-OFFER(1) +                         
                                    K270-NUM-OFFER(2).                          
                                                                                
           MOVE WS-ALLOC-TOTAL TO WS-FLAT-OFFER.                                
                                                                                
       3550-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3560-STARTBR-BP13K813.                                                   
      *-----------------------------------------------------------*             
                                                                                
           MOVE SPACES                     TO BP13K813-REC.                     
           INITIALIZE                         BP13K813-REC.                     
                                                                                
           MOVE 'N'                        TO WS-EOF-K813                       
                                              WS-ZONE-FND-FLAG.                 
                                                                                
           MOVE F205-NUM-NT-ZONE           TO K813-NUM-ZONE.                    
                                                                                
           START BP13K813 KEY >= K813-NUM-ZONE.                                 
                                                                                
           EVALUATE K813-STATUS                                                 
           WHEN 00                                                              
           WHEN 02                                                              
                PERFORM 3570-READNEXT-BP13K813 THRU 3570-EXIT                   
                 UNTIL WS-EOF-K813 = 'Y' OR WS-ZONE-FND-FLAG = 'Y'              
           WHEN 10                                                              
           WHEN 23                                                              
                CONTINUE                                                        
           WHEN OTHER                                                           
                DISPLAY 'START ERROR BP13K825 : ' K813-STATUS                   
                        ' ZONE : ' K813-NUM-ZONE                                
                PERFORM 9000-CLOSE-FILES         THRU 9000-EXIT                 
           END-EVALUATE.                                                        
                                                                                
       3560-EXIT.                                                               
           EXIT.                                                                
                                                                                
      *-----------------------------------------------------------*             
       3570-READNEXT-BP13K813.                                                  
      *-----------------------------------------------------------*             
                                                                                
           READ BP13K813 NEXT RECORD                                            
                AT END MOVE 'Y' TO WS-EOF-K813.                                 
                                                                                
           EVALUATE K813-STATUS                                                 
           WHEN 00                                                              
           WHEN 02                                                              
                IF K813-NUM-ZONE   = F205-NUM-NT-ZONE                           
                   MOVE 'Y'        TO  WS-ZONE-FND-FLAG                         
                END-IF                                                          
           WHEN 10                                                              
           WHEN 23                                                              
                MOVE 'Y'           TO  WS-EOF-K813                              
           WHEN OTHER                                                           
                DISPLAY 'READNEXT ERROR BP13K813 : ' K813-STATUS                
                        ' ZONE : ' K813-NUM-ZONE                                
                PERFORM 9000-CLOSE-FILES         THRU 9000-EXIT                 
           END-EVALUATE.                                                        
                                                                                
       3570-EXIT.                                                               
            EXIT.                                                               
                                                                                
      *-----------------------------------------------------------*             
       3600-WRITETO-F222.                                                       
      *-----------------------------------------------------------*             
           MOVE SPACES                    TO BP13F222-REC.                      
           MOVE ZEROS                     TO F222-NUM-BOOKED.                   
           MOVE WS-CNT-BKAPPMT            TO F222-NUM-BKAPPMT.                  
           MOVE WS-FLAT-OFFER             TO F222-NUM-FLAT-OFFER.               
           MOVE F205-NUM-NT-ZONE          TO F222-NUM-NT-ZONE.                  
           MOVE F205-DTE-ALLOCN           TO F222-DTE-ALLOC.                    
           MOVE F205-DTE-BALLOT           TO F222-DTE-BALLOT.                   
           MOVE WS-K210-FT                TO F222-NUM-FLAT-TYPE.                
           MOVE WS-START-DATE             TO F222-DTE-START-BKAPPMT.            
           MOVE WS-END-DATE               TO F222-DTE-END-BKAPPMT.              
           MOVE 'P13C248'                 TO F222-NUM-USERID.                   
           MOVE FUNCTION CURRENT-DATE     TO F222-DTE-UPDATE.                   
                                                                                
           WRITE BP13F222-REC.                                                  
           ADD 1  TO WS-F222-WRITE.                                             
                                                                                
                                                                                
       3600-EXIT.                                                               
           EXIT.                                                                
                                                                                
                                                                                
      *************************************************************             
       9000-CLOSE-FILES.                                                        
      *************************************************************             
           DISPLAY '***************** BP13C24F *****************'.              
           DISPLAY 'TOTAL RECORDS READ    (BP13F205) = ' WS-F205-READ.          
           DISPLAY 'TOTAL RECORDS WRITTEN (BP13F222) = ' WS-F222-WRITE.         
                                                                                
           CLOSE BP13F205                                                       
                 BP13K270                                                       
                 BP13K210                                                       
                 BP13K813                                                       
                 BP13F222.                                                      
                                                                                
           IF K270-STATUS NOT = 00 AND 97                                       
              MOVE K270-STATUS            TO RETURN-CODE                        
              DISPLAY 'ERROR CLOSING BP13K270 FILE, ' K270-STATUS               
           END-IF.                                                              
                                                                                
           IF K210-STATUS NOT = 00 AND 97                                       
              MOVE K210-STATUS            TO RETURN-CODE                        
              DISPLAY 'ERROR CLOSING BP13K210 FILE, ' K210-STATUS               
           END-IF.                                                              
                                                                                
           IF K813-STATUS NOT = 00 AND 97                                       
              MOVE K813-STATUS            TO RETURN-CODE                        
              DISPLAY 'ERROR CLOSING BP13K813 FILE, ' K813-STATUS               
           END-IF.                                                              
                                                                                
           STOP RUN.                                                            
                                                                                
       9000-EXIT.                                                               
           EXIT.                                                                
